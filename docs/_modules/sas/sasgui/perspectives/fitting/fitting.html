<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sas.sasgui.perspectives.fitting.fitting &mdash; SasView 4.2.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '4.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="top" title="SasView 4.2.0 documentation" href="../../../../../index.html" />
    <link rel="up" title="sas.sasgui.perspectives.fitting" href="../fitting.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">SasView 4.2.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../../../sas.html" >sas</a> &raquo;</li>
          <li class="nav-item nav-item-3"><a href="../fitting.html" accesskey="U">sas.sasgui.perspectives.fitting</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sas.sasgui.perspectives.fitting.fitting</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fitting perspective</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">################################################################################</span>
<span class="c1">#This software was developed by the University of Tennessee as part of the</span>
<span class="c1">#Distributed Data Analysis of Neutron Scattering Experiments (DANSE)</span>
<span class="c1">#project funded by the US National Science Foundation.</span>
<span class="c1">#</span>
<span class="c1">#See the license text in license.txt</span>
<span class="c1">#</span>
<span class="c1">#copyright 2009, University of Tennessee</span>
<span class="c1">################################################################################</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">bumps.options</span>
<span class="kn">from</span> <span class="nn">bumps.gui.fit_dialog</span> <span class="kn">import</span> <span class="n">show_fit_config</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">bumps.gui.fit_dialog</span> <span class="kn">import</span> <span class="n">EVT_FITTER_CHANGED</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># CRUFT: bumps 0.7.5.8 and below</span>
    <span class="n">EVT_FITTER_CHANGED</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># type: wx.PyCommandEvent</span>

<span class="kn">from</span> <span class="nn">sas.sascalc.dataloader.loader</span> <span class="kn">import</span> <span class="n">Loader</span>
<span class="kn">from</span> <span class="nn">sas.sascalc.fit.BumpsFitting</span> <span class="kn">import</span> <span class="n">BumpsFit</span> <span class="k">as</span> <span class="n">Fit</span>
<span class="kn">from</span> <span class="nn">sas.sascalc.fit.pagestate</span> <span class="kn">import</span> <span class="n">Reader</span><span class="p">,</span> <span class="n">PageState</span><span class="p">,</span> <span class="n">SimFitPageState</span>
<span class="kn">from</span> <span class="nn">sas.sascalc.fit</span> <span class="kn">import</span> <span class="n">models</span>

<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.dataFitting</span> <span class="kn">import</span> <span class="n">Data2D</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.dataFitting</span> <span class="kn">import</span> <span class="n">Data1D</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.dataFitting</span> <span class="kn">import</span> <span class="n">check_data_validity</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.events</span> <span class="kn">import</span> <span class="n">NewPlotEvent</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.events</span> <span class="kn">import</span> <span class="n">StatusEvent</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.events</span> <span class="kn">import</span> <span class="n">EVT_SLICER_PANEL</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.events</span> <span class="kn">import</span> <span class="n">EVT_SLICER_PARS_UPDATE</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.gui_style</span> <span class="kn">import</span> <span class="n">GUIFRAME_ID</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.plugin_base</span> <span class="kn">import</span> <span class="n">PluginBase</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.data_processor</span> <span class="kn">import</span> <span class="n">BatchCell</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.gui_manager</span> <span class="kn">import</span> <span class="n">MDIFrame</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.guiframe.documentation_window</span> <span class="kn">import</span> <span class="n">DocumentationWindow</span>

<span class="kn">from</span> <span class="nn">sas.sasgui.perspectives.calculator.model_editor</span> <span class="kn">import</span> <span class="n">TextDialog</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.perspectives.calculator.model_editor</span> <span class="kn">import</span> <span class="n">EditorWindow</span>
<span class="kn">from</span> <span class="nn">sas.sasgui.perspectives.calculator.pyconsole</span> <span class="kn">import</span> <span class="n">PyConsole</span>

<span class="kn">from</span> <span class="nn">.fitting_widgets</span> <span class="kn">import</span> <span class="n">DataDialog</span>
<span class="kn">from</span> <span class="nn">.fit_thread</span> <span class="kn">import</span> <span class="n">FitThread</span>
<span class="kn">from</span> <span class="nn">.fitpage</span> <span class="kn">import</span> <span class="n">Chi2UpdateEvent</span>
<span class="kn">from</span> <span class="nn">.console</span> <span class="kn">import</span> <span class="n">ConsoleUpdate</span>
<span class="kn">from</span> <span class="nn">.fitproblem</span> <span class="kn">import</span> <span class="n">FitProblemDictionary</span>
<span class="kn">from</span> <span class="nn">.fitpanel</span> <span class="kn">import</span> <span class="n">FitPanel</span>
<span class="kn">from</span> <span class="nn">.model_thread</span> <span class="kn">import</span> <span class="n">Calc1D</span><span class="p">,</span> <span class="n">Calc2D</span>
<span class="kn">from</span> <span class="nn">.resultpanel</span> <span class="kn">import</span> <span class="n">ResultPanel</span><span class="p">,</span> <span class="n">PlotResultEvent</span>
<span class="kn">from</span> <span class="nn">.gpu_options</span> <span class="kn">import</span> <span class="n">GpuOptions</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">MAX_NBR_DATA</span> <span class="o">=</span> <span class="mi">4</span>

<span class="p">(</span><span class="n">PageInfoEvent</span><span class="p">,</span> <span class="n">EVT_PAGE_INFO</span><span class="p">)</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">newevent</span><span class="o">.</span><span class="n">NewEvent</span><span class="p">()</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
    <span class="n">ON_MAC</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ON_MAC</span> <span class="o">=</span> <span class="bp">True</span>


<div class="viewcode-block" id="Plugin"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin">[docs]</a><span class="k">class</span> <span class="nc">Plugin</span><span class="p">(</span><span class="n">PluginBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fitting plugin is used to perform fit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">PluginBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Fitting&quot;</span><span class="p">)</span>

        <span class="c1">#list of panel to send to guiframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mypanels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># reference to the current running thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_2D</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_1D</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit_thread_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_panel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># Start with a good default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">=</span> <span class="mf">0.022</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">## dictionary of page closed and id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed_page_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">## Relative error desired in the sum of squares (float)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_reset_flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1">#List of selected data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">## list of slicer panel created to display slicer parameters and results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slicer_panels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># model 2D view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model2D_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">#keep reference of the simultaneous fit page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_menu</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_menu</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_model</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_model_color</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">#Create a reader for fit page&#39;s state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extensions</span> <span class="o">=</span> <span class="s1">&#39;.fitv&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_model_frame</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfile_ext</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># take care of saving  data, model and page associated with each other</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Log startup</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fitting plug-in started&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_capable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_capable</span><span class="p">()</span>

<div class="viewcode-block" id="Plugin.get_batch_capable"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.get_batch_capable">[docs]</a>    <span class="k">def</span> <span class="nf">get_batch_capable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the plugin has a batch capability</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Plugin.create_fit_problem"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.create_fit_problem">[docs]</a>    <span class="k">def</span> <span class="nf">create_fit_problem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an ID create a fitproblem container</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">FitProblemDictionary</span><span class="p">()</span></div>

<div class="viewcode-block" id="Plugin.delete_fit_problem"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.delete_fit_problem">[docs]</a>    <span class="k">def</span> <span class="nf">delete_fit_problem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an ID create a fitproblem container</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">page_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span></div>

<div class="viewcode-block" id="Plugin.add_color"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.add_color">[docs]</a>    <span class="k">def</span> <span class="nf">add_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        adds a color as a key with a plot id as its value to a dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color_dict</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span></div>

<div class="viewcode-block" id="Plugin.on_batch_selection"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_batch_selection">[docs]</a>    <span class="k">def</span> <span class="nf">on_batch_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        switch the the notebook of batch mode or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_on</span> <span class="o">=</span> <span class="n">flag</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">batch_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_on</span></div>

<div class="viewcode-block" id="Plugin.populate_menu"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.populate_menu">[docs]</a>    <span class="k">def</span> <span class="nf">populate_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a menu for the Fitting plug-in</span>

<span class="sd">        :param id: id to create a menu</span>
<span class="sd">        :param owner: owner of menu</span>

<span class="sd">        :return: list of information to populate the main menu</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Menu for fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
        <span class="n">id1</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="n">simul_help</span> <span class="o">=</span> <span class="s2">&quot;Add new fit panel&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="s1">&#39;&amp;New Fit Page&#39;</span><span class="p">,</span> <span class="n">simul_help</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">id1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_add_new_page</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">AppendSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_simfit</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="n">simul_help</span> <span class="o">=</span> <span class="s2">&quot;Constrained or Simultaneous Fit&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_simfit</span><span class="p">,</span> <span class="s1">&#39;&amp;Constrained or Simultaneous Fit&#39;</span><span class="p">,</span> <span class="n">simul_help</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_simfit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_add_sim_page</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_menu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">FindItemById</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_simfit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_menu</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="c1">#combined Batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_batchfit</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="n">batch_help</span> <span class="o">=</span> <span class="s2">&quot;Combined Batch&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_batchfit</span><span class="p">,</span> <span class="s1">&#39;&amp;Combine Batch Fit&#39;</span><span class="p">,</span> <span class="n">batch_help</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_batchfit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_add_sim_page</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_menu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">FindItemById</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_batchfit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_menu</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">AppendSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_bumps_options</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="n">bopts_help</span> <span class="o">=</span> <span class="s2">&quot;Fitting options&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_bumps_options</span><span class="p">,</span> <span class="s1">&#39;Fit &amp;Options&#39;</span><span class="p">,</span> <span class="n">bopts_help</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_bumps_options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_bumps_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bumps_options_menu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">FindItemById</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_bumps_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bumps_options_menu</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id_gpu_options_panel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_gpu_options_panel</span><span class="p">,</span> <span class="s2">&quot;OpenCL Options&quot;</span><span class="p">,</span> <span class="s2">&quot;Choose OpenCL driver or turn it off&quot;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_gpu_options_panel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_gpu_options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id_result_panel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_result_panel</span><span class="p">,</span> <span class="s2">&quot;Fit Results&quot;</span><span class="p">,</span> <span class="s2">&quot;Show fit results panel&quot;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_result_panel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_fit_results</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">AppendSeparator</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id_reset_flag</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="n">resetf_help</span> <span class="o">=</span> <span class="s2">&quot;BatchFit: If checked, the initial param values will be &quot;</span>
        <span class="n">resetf_help</span> <span class="o">+=</span> <span class="s2">&quot;propagated from the previous results. &quot;</span>
        <span class="n">resetf_help</span> <span class="o">+=</span> <span class="s2">&quot;Otherwise, the same initial param values will be used &quot;</span>
        <span class="n">resetf_help</span> <span class="o">+=</span> <span class="s2">&quot;for all fittings.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">AppendCheckItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_reset_flag</span><span class="p">,</span>
                                   <span class="s2">&quot;Chain Fitting [BatchFit Only]&quot;</span><span class="p">,</span>
                                   <span class="n">resetf_help</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_reset_flag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_reset_batch_flag</span><span class="p">)</span>
        <span class="n">chain_menu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">FindItemById</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_reset_flag</span><span class="p">)</span>
        <span class="n">chain_menu</span><span class="o">.</span><span class="n">Check</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_reset_flag</span><span class="p">)</span>
        <span class="n">chain_menu</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_on</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">AppendSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_model_menu</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
        <span class="c1"># Find and put files name in menu</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_edit_menu</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">owner</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id_edit</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">AppendMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_edit</span><span class="p">,</span> <span class="s2">&quot;Plugin Model Operations&quot;</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">edit_model_menu</span><span class="p">)</span>
        <span class="c1">#create  menubar items</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_menu</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Plugin.edit_custom_model"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.edit_custom_model">[docs]</a>    <span class="k">def</span> <span class="nf">edit_custom_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the python editor panel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">GetLabel</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">find_plugins_dir</span><span class="p">(),</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">PyConsole</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">panel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Advanced Plugin Model Editor&#39;</span><span class="p">,</span>
                          <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_icon</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.delete_custom_model"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.delete_custom_model">[docs]</a>    <span class="k">def</span> <span class="nf">delete_custom_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete custom model file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_menu</span><span class="o">.</span><span class="n">GetLabel</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">find_plugins_dir</span><span class="p">(),</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Are you sure you want to delete the file {}?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MessageDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">YES_NO</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">ICON_QUESTION</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_YES</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;.pyc&#39;</span><span class="p">]:</span>
                <span class="n">p_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">ext</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.pyc&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">ext</span><span class="p">):</span>
                    <span class="c1"># If model is invalid, .pyc file may not exist as model has</span>
                    <span class="c1"># never been compiled. Don&#39;t try and delete it</span>
                    <span class="k">continue</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_custom_combo</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">p_path</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Sorry! unable to delete the default &quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;plugin model... </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Please manually remove the files (.py, .pyc) &quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;in the &#39;plugin_models&#39; folder </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;inside of the SasView application, &quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;and try it again.&quot;</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">MessageBox</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;Info&#39;</span><span class="p">)</span>
                <span class="c1">#evt = StatusEvent(status=msg, type=&#39;stop&#39;, info=&#39;warning&#39;)</span>
                <span class="c1">#wx.PostEvent(self.parent, evt)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_menu</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">GetMenuItems</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">GetLabel</span><span class="p">()</span> <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">DeleteItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The plugin model, </span><span class="si">%s</span><span class="s2">, has been deleted.&quot;</span> <span class="o">%</span> <span class="n">label</span>
                        <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
                        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Delete Error: </span><span class="se">\n</span><span class="s1">Could not delete the file; Check if in use.&#39;</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">MessageBox</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.make_sum_model"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.make_sum_model">[docs]</a>    <span class="k">def</span> <span class="nf">make_sum_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Edit summodel template and make one</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="n">model_manager</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ModelManager</span><span class="p">()</span>
        <span class="n">model_list</span> <span class="o">=</span> <span class="n">model_manager</span><span class="o">.</span><span class="n">composable_models</span><span class="p">()</span>
        <span class="n">plug_dir</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">find_plugins_dir</span><span class="p">()</span>
        <span class="n">textdial</span> <span class="o">=</span> <span class="n">TextDialog</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span> <span class="s1">&#39;Easy Sum/Multi(p1, p2) Editor&#39;</span><span class="p">,</span>
                              <span class="n">model_list</span><span class="p">,</span> <span class="n">plug_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_icon</span><span class="p">(</span><span class="n">textdial</span><span class="p">)</span>
        <span class="n">textdial</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span>
        <span class="n">textdial</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span></div>

<div class="viewcode-block" id="Plugin.make_new_model"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.make_new_model">[docs]</a>    <span class="k">def</span> <span class="nf">make_new_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make new model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_model_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_model_frame</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_model_frame</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
            <span class="n">dir_path</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">find_plugins_dir</span><span class="p">()</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;New Plugin Model Function&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_model_frame</span> <span class="o">=</span> <span class="n">EditorWindow</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                                <span class="n">path</span><span class="o">=</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_icon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_model_frame</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.load_plugin_models"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.load_plugin_models">[docs]</a>    <span class="k">def</span> <span class="nf">load_plugin_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update of models in plugin_models folder</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_custom_combo</span><span class="p">()</span></div>

<div class="viewcode-block" id="Plugin.update_custom_combo"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.update_custom_combo">[docs]</a>    <span class="k">def</span> <span class="nf">update_custom_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update custom model list in the fitpage combo box</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Update edit menus</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_edit_menu_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_custom_model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_edit_menu_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_custom_model</span><span class="p">)</span>
            <span class="n">new_pmodel_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">reset_pmodel_list</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_pmodel_list</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># Redraws to a page not in focus are showing up as if they are</span>
            <span class="c1"># in the current page tab.</span>
            <span class="n">current_page_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
            <span class="n">current_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">GetCurrentPage</span><span class="p">()</span>
            <span class="n">last_drawn_page</span> <span class="o">=</span> <span class="n">current_page</span>

            <span class="c1"># Set the new plugin model list for all fit pages; anticipating</span>
            <span class="c1"># categories, the updated plugin may be in either the form factor</span>
            <span class="c1"># or the structure factor combo boxes</span>
            <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">opened_pages</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">pbox</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;formfactorbox&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">sbox</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s2">&quot;structurebox&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pbox</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Set the new model list for the page</span>
                <span class="n">page</span><span class="o">.</span><span class="n">model_list_box</span> <span class="o">=</span> <span class="n">new_pmodel_list</span>

                <span class="c1"># Grab names of the P and S models from the page.  Need to do</span>
                <span class="c1"># this before resetting the form factor box since that clears</span>
                <span class="c1"># the structure factor box.</span>
                <span class="n">old_struct</span> <span class="o">=</span> <span class="n">old_form</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">form_name</span> <span class="o">=</span> <span class="n">pbox</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">struct_name</span> <span class="o">=</span> <span class="n">sbox</span><span class="o">.</span><span class="n">GetStringSelection</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">form_name</span><span class="p">:</span>
                    <span class="n">old_form</span> <span class="o">=</span> <span class="n">pbox</span><span class="o">.</span><span class="n">GetClientData</span><span class="p">(</span><span class="n">pbox</span><span class="o">.</span><span class="n">GetCurrentSelection</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">struct_name</span><span class="p">:</span>
                    <span class="n">old_struct</span> <span class="o">=</span> <span class="n">sbox</span><span class="o">.</span><span class="n">GetClientData</span><span class="p">(</span><span class="n">sbox</span><span class="o">.</span><span class="n">GetCurrentSelection</span><span class="p">())</span>

                <span class="c1"># Reset form factor combo box.  We are doing this for all</span>
                <span class="c1"># categories not just plugins since eventually the category</span>
                <span class="c1"># manager will allow plugin models to be anywhere.</span>
                <span class="n">page</span><span class="o">.</span><span class="n">_show_combox_helper</span><span class="p">()</span>
                <span class="n">form_index</span> <span class="o">=</span> <span class="n">pbox</span><span class="o">.</span><span class="n">FindString</span><span class="p">(</span><span class="n">form_name</span><span class="p">)</span>
                <span class="n">pbox</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="n">form_index</span><span class="p">)</span>
                <span class="n">new_form</span> <span class="o">=</span> <span class="p">(</span><span class="n">pbox</span><span class="o">.</span><span class="n">GetClientData</span><span class="p">(</span><span class="n">form_index</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">form_index</span> <span class="o">!=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NOT_FOUND</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
                <span class="c1">#print(&quot;form: %r&quot;%form_name, old_form, new_form)</span>

                <span class="c1"># Reset structure factor combo box; even if the model list</span>
                <span class="c1"># hasn&#39;t changed, the model may have.  Show the structure</span>
                <span class="c1"># factor combobox if the selected model is a form factor.</span>
                <span class="n">sbox</span><span class="o">.</span><span class="n">Clear</span><span class="p">()</span>
                <span class="n">page</span><span class="o">.</span><span class="n">initialize_combox</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">new_form</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">new_form</span><span class="p">,</span> <span class="s1">&#39;is_form_factor&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                    <span class="n">sbox</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
                    <span class="n">sbox</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">text2</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">text2</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
                <span class="n">struct_index</span> <span class="o">=</span> <span class="n">sbox</span><span class="o">.</span><span class="n">FindString</span><span class="p">(</span><span class="n">struct_name</span><span class="p">)</span>
                <span class="n">sbox</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="n">struct_index</span><span class="p">)</span>
                <span class="n">new_struct</span> <span class="o">=</span> <span class="p">(</span><span class="n">sbox</span><span class="o">.</span><span class="n">GetClientData</span><span class="p">(</span><span class="n">struct_index</span><span class="p">)</span>
                              <span class="k">if</span> <span class="n">struct_index</span> <span class="o">!=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NOT_FOUND</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
                <span class="c1">#print(&quot;struct: %r&quot;%struct_name, old_struct, new_struct)</span>

                <span class="c1"># Update the page if P or S has changed</span>
                <span class="k">if</span> <span class="n">old_form</span> <span class="o">!=</span> <span class="n">new_form</span> <span class="ow">or</span> <span class="n">old_struct</span> <span class="o">!=</span> <span class="n">new_struct</span><span class="p">:</span>
                    <span class="c1">#print(&quot;triggering model update&quot;)</span>
                    <span class="n">page</span><span class="o">.</span><span class="n">_on_select_model</span><span class="p">(</span><span class="n">keep_pars</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">last_drawn_page</span> <span class="o">=</span> <span class="n">page</span>

            <span class="c1"># If last drawn is not the current, then switch the current to the</span>
            <span class="c1"># last drawn then switch back.  Very ugly.</span>
            <span class="k">if</span> <span class="n">last_drawn_page</span> <span class="o">!=</span> <span class="n">current_page</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">page_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">PageCount</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page_index</span><span class="p">)</span> <span class="o">==</span> <span class="n">last_drawn_page</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="n">page_index</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="n">current_page_index</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;update_custom_combo: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.set_edit_menu"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_edit_menu">[docs]</a>    <span class="k">def</span> <span class="nf">set_edit_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set list of the edit model menu labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wx_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="c1">#new_model_menu = wx.Menu()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_model_menu</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">wx_id</span><span class="p">,</span> <span class="s1">&#39;New Plugin Model&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;Add a new model function&#39;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">wx_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_new_model</span><span class="p">)</span>

        <span class="n">wx_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_model_menu</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">wx_id</span><span class="p">,</span> <span class="s1">&#39;Sum|Multi(p1, p2)&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;Sum of two model functions&#39;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">wx_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_sum_model</span><span class="p">)</span>

        <span class="n">e_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_model_menu</span><span class="o">.</span><span class="n">AppendMenu</span><span class="p">(</span><span class="n">e_id</span><span class="p">,</span>
                                    <span class="s1">&#39;Advanced Plugin Editor&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_edit_menu_helper</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_custom_model</span><span class="p">)</span>

        <span class="n">d_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_menu</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_model_menu</span><span class="o">.</span><span class="n">AppendMenu</span><span class="p">(</span><span class="n">d_id</span><span class="p">,</span>
                                        <span class="s1">&#39;Delete Plugin Models&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_edit_menu_helper</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_custom_model</span><span class="p">)</span>

        <span class="n">wx_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_model_menu</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">wx_id</span><span class="p">,</span> <span class="s1">&#39;Load Plugin Models&#39;</span><span class="p">,</span>
          <span class="s1">&#39;(Re)Load all models present in user plugin_models folder&#39;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">wx_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_plugin_models</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.set_edit_menu_helper"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_edit_menu_helper">[docs]</a>    <span class="k">def</span> <span class="nf">set_edit_menu_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">menu</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        help for setting list of the edit model menu labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">menu</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">menu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_custom_model</span>
        <span class="n">list_fnames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">find_plugins_dir</span><span class="p">())</span>
        <span class="n">list_fnames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f_item</span> <span class="ow">in</span> <span class="n">list_fnames</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f_item</span><span class="p">)</span>
            <span class="n">toks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.py&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;__init__&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">menu</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_custom_model</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;easy_sum_of_p1_p2&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">submenu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">submenu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_menu</span>
                <span class="n">has_file</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">submenu</span><span class="o">.</span><span class="n">GetMenuItems</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">submenu</span><span class="o">.</span><span class="n">GetLabel</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">GetId</span><span class="p">()):</span>
                        <span class="n">has_file</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_file</span><span class="p">:</span>
                    <span class="n">wx_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
                    <span class="n">submenu</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">wx_id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">wx_id</span><span class="p">,</span> <span class="n">menu</span><span class="p">)</span>
                    <span class="n">has_file</span> <span class="o">=</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="Plugin.put_icon"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.put_icon">[docs]</a>    <span class="k">def</span> <span class="nf">put_icon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Put icon in the frame title bar</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="s2">&quot;IsIconized&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">IsIconized</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">icon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">GetIcon</span><span class="p">()</span>
                    <span class="n">frame</span><span class="o">.</span><span class="n">SetIcon</span><span class="p">(</span><span class="n">icon</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span></div>

<div class="viewcode-block" id="Plugin.on_add_sim_page"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_add_sim_page">[docs]</a>    <span class="k">def</span> <span class="nf">on_add_sim_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a page to access simultaneous fit option</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="n">caption</span> <span class="o">=</span> <span class="s2">&quot;Const &amp; Simul Fit&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span>
        <span class="k">if</span> <span class="n">event_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_batchfit</span><span class="p">:</span>
            <span class="n">caption</span> <span class="o">=</span> <span class="s2">&quot;Combined Batch&quot;</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span>

        <span class="k">def</span> <span class="nf">set_focus_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">page</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">Refresh</span><span class="p">()</span>
            <span class="n">page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
            <span class="c1">#self.parent._mgr.Update()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> already opened</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">window_caption</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">set_focus_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">caption</span> <span class="o">==</span> <span class="s2">&quot;Const &amp; Simul Fit&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">add_sim_page</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">add_sim_page</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.get_context_menu"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.get_context_menu">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plotpanel</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the context menu items available for P(r).them allow fitting option</span>
<span class="sd">        for Data2D and Data1D only.</span>

<span class="sd">        :param graph: the Graph object to which we attach the context menu</span>

<span class="sd">        :return: a list of menu items with call-back function</span>

<span class="sd">        :note: if Data1D was generated from Theory1D</span>
<span class="sd">                the fitting option is not allowed</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_panel</span> <span class="o">=</span> <span class="n">plotpanel</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">plotpanel</span><span class="o">.</span><span class="n">graph</span>
        <span class="n">fit_option</span> <span class="o">=</span> <span class="s2">&quot;Select data for fitting&quot;</span>
        <span class="n">fit_hint</span> <span class="o">=</span> <span class="s2">&quot;Dialog with fitting parameters &quot;</span>

        <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">selected_plottable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plotpanel</span><span class="o">.</span><span class="n">plots</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">plotpanel</span><span class="o">.</span><span class="n">plots</span><span class="p">[</span><span class="n">graph</span><span class="o">.</span><span class="n">selected_plottable</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">is</span> <span class="s2">&quot;Data2D&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;is_data&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">is_data</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[[</span><span class="n">fit_option</span><span class="p">,</span> <span class="n">fit_hint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onSelect</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">fit_option</span><span class="p">,</span> <span class="n">fit_hint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onSelect</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># if is_data is true , this in an actual data loaded</span>
            <span class="c1">#else it is a data created from a theory model</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;is_data&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">is_data</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[[</span><span class="n">fit_option</span><span class="p">,</span> <span class="n">fit_hint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onSelect</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">fit_option</span><span class="p">,</span> <span class="n">fit_hint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onSelect</span><span class="p">]]</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="Plugin.get_panels"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.get_panels">[docs]</a>    <span class="k">def</span> <span class="nf">get_panels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and return a list of panel objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="c1">#self.parent.Bind(EVT_FITSTATE_UPDATE, self.on_set_state_helper)</span>
        <span class="c1"># Creation of the fit panel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">MDIFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span> <span class="o">=</span> <span class="n">FitPanel</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">set_panel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_set_helper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_add_new_page</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1">#Set the manager for the main panel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># List of windows used for the perspective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perspective</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perspective</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">window_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result_frame</span> <span class="o">=</span> <span class="n">MDIFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">ResultPanel</span><span class="o">.</span><span class="n">window_caption</span><span class="p">,</span> <span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_panel</span> <span class="o">=</span> <span class="n">ResultPanel</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result_frame</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perspective</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_panel</span><span class="o">.</span><span class="n">window_name</span><span class="p">)</span>

        <span class="c1">#index number to create random model name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_model</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_theory</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">EVT_SLICER_PANEL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_slicer_event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">EVT_SLICER_PARS_UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onEVT_SLICER_PANEL</span><span class="p">)</span>

        <span class="c1"># CRUFT: EVT_FITTER_CHANGED is not None for bumps 0.7.5.9 and above</span>
        <span class="k">if</span> <span class="n">EVT_FITTER_CHANGED</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">EVT_FITTER_CHANGED</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_fitter_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_fitter_label</span><span class="p">(</span><span class="n">bumps</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">FIT_CONFIG</span><span class="p">)</span>

        <span class="c1">#self.parent._mgr.Bind(wx.aui.EVT_AUI_PANE_CLOSE,self._onclearslicer)</span>
        <span class="c1">#Create reader when fitting panel are created</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_state</span><span class="p">)</span>
        <span class="c1">#append that reader to list of available reader</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">Loader</span><span class="p">()</span>
        <span class="n">loader</span><span class="o">.</span><span class="n">associate_file_reader</span><span class="p">(</span><span class="s2">&quot;.fitv&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span><span class="p">)</span>
        <span class="c1">#Send the fitting panel to guiframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mypanels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mypanels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_panel</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mypanels</span></div>

<div class="viewcode-block" id="Plugin.clear_panel"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.clear_panel">[docs]</a>    <span class="k">def</span> <span class="nf">clear_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">clear_panel</span><span class="p">()</span></div>

<div class="viewcode-block" id="Plugin.delete_data"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.delete_data">[docs]</a>    <span class="k">def</span> <span class="nf">delete_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        delete  the given data from panel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">delete_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.set_data"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_data">[docs]</a>    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        receive a list of data to fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">selected_data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_on</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_fit_page</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_NBR_DATA</span><span class="p">:</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">DataDialog</span><span class="p">(</span><span class="n">data_list</span><span class="o">=</span><span class="n">data_list</span><span class="p">,</span> <span class="n">nb_data</span><span class="o">=</span><span class="n">MAX_NBR_DATA</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">selected_data_list</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_data_list</span> <span class="o">=</span> <span class="n">data_list</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">group_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">selected_data_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="c1"># 2D has no same group_id</span>
                        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;Data2D&#39;</span><span class="p">:</span>
                            <span class="n">group_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">group_id</span>
                        <span class="k">if</span> <span class="n">group_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">list_group_id</span><span class="p">:</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">list_group_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_fit_page</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fitting set_data: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Plugin.set_theory"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_theory">[docs]</a>    <span class="k">def</span> <span class="nf">set_theory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theory_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#set the model state for a given theory_state:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">theory_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">theory_state</span> <span class="o">=</span> <span class="n">item</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">set_model_state</span><span class="p">(</span><span class="n">theory_state</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fitting: cannot deal with the theory received&quot;</span>
                <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;set_theory &quot;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">))</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.set_state"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">datainfo</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call-back method for the fit page state reader.</span>
<span class="sd">        This method is called when a .fitv/.svs file is loaded.</span>

<span class="sd">        : param state: PageState object</span>
<span class="sd">        : param datainfo: data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">PageState</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SimFitPageState</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">sim_page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">add_sim_page</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">sim_page</span><span class="o">.</span><span class="n">load_from_save_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># index to start with for a new set_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># state file format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfile_ext</span> <span class="o">=</span> <span class="n">format</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_set_state_helper</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.on_set_state_helper"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_set_state_helper">[docs]</a>    <span class="k">def</span>  <span class="nf">on_set_state_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set_state_helper. This actually sets state</span>
<span class="sd">        after plotting data from state file.</span>

<span class="sd">        : event: FitStateUpdateEvent called</span>
<span class="sd">            by dataloader.plot_data from guiframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mypanels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfile_ext</span> <span class="o">==</span> <span class="s1">&#39;.svs&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Load fitting state</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state_index</span><span class="p">]</span>
            <span class="c1">#panel state should have model selection to set_state</span>
            <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">formfactorcombobox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1">#set state</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">create_gui_data</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">group_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">data_list</span><span class="o">=</span><span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>
                <span class="c1">#need to be fix later make sure we are sendind guiframe.data</span>
                <span class="c1">#to panel</span>
                <span class="n">state</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#just set data because set_state won&#39;t work</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">create_gui_data</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">group_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">data_list</span><span class="o">=</span><span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>
                <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_fit_page</span><span class="p">([</span><span class="n">data</span><span class="p">])</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">window_caption</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_data</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">data_list</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">get_data_list</span><span class="p">(),</span>
                                <span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mypanels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

            <span class="c1"># get ready for the next set_state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">#reset state variables to default when all set_state is finished.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_index</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1">#self.state_index = 0</span>
                <span class="c1"># Make sure the user sees the fitting panel after loading</span>
                <span class="c1">#self.parent.set_perspective(self.perspective)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_perspective</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_state</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="Plugin.set_param2fit"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_param2fit">[docs]</a>    <span class="k">def</span> <span class="nf">set_param2fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">param2fit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the list of param names to fit for fitprobelm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">set_param2fit</span><span class="p">(</span><span class="n">param2fit</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.set_graph_id"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_graph_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_graph_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">graph_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set graph_id for fitprobelm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">set_graph_id</span><span class="p">(</span><span class="n">graph_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.get_graph_id"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.get_graph_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set graph_id for fitprobelm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">get_graph_id</span><span class="p">()</span></div>

<div class="viewcode-block" id="Plugin.save_fit_state"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.save_fit_state">[docs]</a>    <span class="k">def</span> <span class="nf">save_fit_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">fitstate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save fit page state into file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span> <span class="n">fitstate</span><span class="o">=</span><span class="n">fitstate</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.set_fit_weight"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_fit_weight">[docs]</a>    <span class="k">def</span> <span class="nf">set_fit_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">is2d</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the fit weights of a given page for all</span>
<span class="sd">        its data by default. If fid is provide then set the range</span>
<span class="sd">        only for the data with fid as id</span>
<span class="sd">        :param uid: id corresponding to a fit page</span>
<span class="sd">        :param fid: id corresponding to a fit problem (data, model)</span>
<span class="sd">        :param weight: current dy data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we are not dealing with a specific fit problem, then</span>
        <span class="c1"># there is no point setting the weights.</span>
        <span class="k">if</span> <span class="n">fid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">set_weight</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">,</span> <span class="n">is2d</span><span class="o">=</span><span class="n">is2d</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.set_fit_range"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_fit_range">[docs]</a>    <span class="k">def</span> <span class="nf">set_fit_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">qmin</span><span class="p">,</span> <span class="n">qmax</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the fitting range of a given page for all</span>
<span class="sd">        its data by default. If fid is provide then set the range</span>
<span class="sd">        only for the data with fid as id</span>
<span class="sd">        :param uid: id corresponding to a fit page</span>
<span class="sd">        :param fid: id corresponding to a fit problem (data, model)</span>
<span class="sd">        :param qmin: minimum  value of the fit range</span>
<span class="sd">        :param qmax: maximum  value of the fit range</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">set_range</span><span class="p">(</span><span class="n">qmin</span><span class="o">=</span><span class="n">qmin</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="n">qmax</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.schedule_for_fit"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.schedule_for_fit">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_for_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the fit problem field to 0 or 1 to schedule that problem to fit.</span>
<span class="sd">        Schedule the specified fitproblem or get the fit problem related to</span>
<span class="sd">        the current page and set value.</span>
<span class="sd">        :param value: integer 0 or 1</span>
<span class="sd">        :param uid: the id related to a page containing fitting information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_tofit</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.get_page_finder"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.get_page_finder">[docs]</a>    <span class="k">def</span> <span class="nf">get_page_finder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return self.page_finder used also by simfitpage.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span></div>

<div class="viewcode-block" id="Plugin.set_page_finder"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_page_finder">[docs]</a>    <span class="k">def</span> <span class="nf">set_page_finder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelname</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used by simfitpage.py to reset a parameter given the string constrainst.</span>

<span class="sd">        :param modelname: the name of the model for with the parameter</span>
<span class="sd">                            has to reset</span>
<span class="sd">        :param value: can be a string in this case.</span>
<span class="sd">        :param names: the parameter name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim_page_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span><span class="o">.</span><span class="n">uid</span>
        <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">uid</span> <span class="o">!=</span> <span class="n">sim_page_id</span> <span class="ow">and</span> <span class="n">uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span><span class="o">.</span><span class="n">uid</span><span class="p">:</span>
                <span class="n">model_list</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get_model</span><span class="p">()</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">modelname</span><span class="p">:</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">set_model_param</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                    <span class="k">break</span></div>

<div class="viewcode-block" id="Plugin.split_string"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.split_string">[docs]</a>    <span class="k">def</span> <span class="nf">split_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        receive a word containing dot and split it. used to split parameterset</span>
<span class="sd">        name into model name and parameter name example: ::</span>

<span class="sd">            parameterset (item) = M1.A</span>
<span class="sd">            Will return model_name = M1 , parameter name = A</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">param_names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">r&quot;\.&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">param_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">##Assume max len is 3; eg., M0.radius.width</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">param_name</span> <span class="o">=</span> <span class="n">param_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">param_names</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_name</span> <span class="o">=</span> <span class="n">param_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">param_name</span></div>

<div class="viewcode-block" id="Plugin.on_bumps_options"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_bumps_options">[docs]</a>    <span class="k">def</span> <span class="nf">on_bumps_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the bumps options panel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">show_fit_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_help</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.on_fitter_changed"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_fitter_changed">[docs]</a>    <span class="k">def</span> <span class="nf">on_fitter_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_fitter_label</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_fitter_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">window_name</span>
                                       <span class="o">+</span> <span class="s2">&quot; - Active Fitting Optimizer: &quot;</span>
                                       <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">selected_name</span><span class="p">)</span>

<div class="viewcode-block" id="Plugin.on_help"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_help">[docs]</a>    <span class="k">def</span> <span class="nf">on_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm_id</span><span class="p">):</span>
        <span class="n">_TreeLocation</span> <span class="o">=</span> <span class="s2">&quot;user/sasgui/perspectives/fitting/optimizer.html&quot;</span>
        <span class="n">_anchor</span> <span class="o">=</span> <span class="s2">&quot;#fit-&quot;</span><span class="o">+</span><span class="n">algorithm_id</span>
        <span class="n">DocumentationWindow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span> <span class="n">_TreeLocation</span><span class="p">,</span> <span class="n">_anchor</span><span class="p">,</span> <span class="s2">&quot;Optimizer Help&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Plugin.on_fit_results"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_fit_results">[docs]</a>    <span class="k">def</span> <span class="nf">on_fit_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the Fit Results panel visible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_frame</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_frame</span><span class="o">.</span><span class="n">Raise</span><span class="p">()</span></div>

<div class="viewcode-block" id="Plugin.on_gpu_options"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_gpu_options">[docs]</a>    <span class="k">def</span> <span class="nf">on_gpu_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the Fit Results panel visible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">GpuOptions</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Plugin.stop_fit"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.stop_fit">[docs]</a>    <span class="k">def</span> <span class="nf">stop_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_thread_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">calc_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_thread_list</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">calc_fit</span> <span class="ow">is</span> <span class="ow">not</span>  <span class="bp">None</span> <span class="ow">and</span> <span class="n">calc_fit</span><span class="o">.</span><span class="n">isrunning</span><span class="p">():</span>
                <span class="n">calc_fit</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fit stop!&quot;</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">))</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_thread_list</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>
        <span class="c1">#set the fit button label of page when fit stop is trigger from</span>
        <span class="c1">#simultaneous fit pane</span>
        <span class="n">sim_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">uid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span><span class="o">.</span><span class="n">uid</span>
        <span class="n">batch_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">uid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span><span class="o">.</span><span class="n">uid</span>
        <span class="k">if</span> <span class="n">sim_flag</span> <span class="ow">or</span> <span class="n">batch_flag</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get_scheduled</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">opened_pages</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">panel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">opened_pages</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>
                        <span class="n">panel</span><span class="o">.</span><span class="n">_on_fit_complete</span><span class="p">()</span></div>

<div class="viewcode-block" id="Plugin.set_smearer"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.set_smearer">[docs]</a>    <span class="k">def</span> <span class="nf">set_smearer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">smearer</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">qmin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">enable_smearer</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a smear object and store it to a fit problem of fid as id. If proper</span>
<span class="sd">        flag is enable , will plot the theory with smearing information.</span>

<span class="sd">        :param smearer: smear object to allow smearing data of id fid</span>
<span class="sd">        :param enable_smearer: Define whether or not all (data, model) contained</span>
<span class="sd">            in the structure of id uid will be smeared before fitting.</span>
<span class="sd">        :param qmin: the maximum value of the theory plotting range</span>
<span class="sd">        :param qmax: the maximum value of the theory plotting range</span>
<span class="sd">        :param draw: Determine if the theory needs to be plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">enable_smearing</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="n">enable_smearer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">set_smearer</span><span class="p">(</span><span class="n">smearer</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
            <span class="c1">## draw model 1D with smeared data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">get_fit_data</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;set_mearer requires at least data.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Got data = </span><span class="si">%s</span><span class="s2"> .</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span>
                <span class="c1">#raise ValueError, msg</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">enable1D</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Data1D</span><span class="p">)</span>
            <span class="n">enable2D</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Data2D</span><span class="p">)</span>
            <span class="c1">## if user has already selected a model to plot</span>
            <span class="c1">## redraw the model with data smeared</span>
            <span class="n">smear</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">get_smearer</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">)</span>

            <span class="c1"># compute weight for the current data</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">get_weight</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">draw_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">page_id</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">smearer</span><span class="o">=</span><span class="n">smear</span><span class="p">,</span>
                            <span class="n">enable1D</span><span class="o">=</span><span class="n">enable1D</span><span class="p">,</span> <span class="n">enable2D</span><span class="o">=</span><span class="n">enable2D</span><span class="p">,</span>
                            <span class="n">qmin</span><span class="o">=</span><span class="n">qmin</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="n">qmax</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.draw_model"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.draw_model">[docs]</a>    <span class="k">def</span> <span class="nf">draw_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">smearer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">enable1D</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">enable2D</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">fid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">toggle_mode_on</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">qmin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">update_chisqr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw model.</span>

<span class="sd">        :param model: the model to draw</span>
<span class="sd">        :param name: the name of the model to draw</span>
<span class="sd">        :param data: the data on which the model is based to be drawn</span>
<span class="sd">        :param description: model&#39;s description</span>
<span class="sd">        :param enable1D: if true enable drawing model 1D</span>
<span class="sd">        :param enable2D: if true enable drawing model 2D</span>
<span class="sd">        :param qmin:  Range&#39;s minimum value to draw model</span>
<span class="sd">        :param qmax:  Range&#39;s maximum value to draw model</span>
<span class="sd">        :param qstep: number of step to divide the x and y-axis</span>
<span class="sd">        :param update_chisqr: update chisqr [bool]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#self.weight = weight</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Data1D</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">enable2D</span><span class="p">:</span>
            <span class="c1">## draw model 1D with no loaded data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_model1D</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                               <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                               <span class="n">page_id</span><span class="o">=</span><span class="n">page_id</span><span class="p">,</span>
                               <span class="n">enable1D</span><span class="o">=</span><span class="n">enable1D</span><span class="p">,</span>
                               <span class="n">smearer</span><span class="o">=</span><span class="n">smearer</span><span class="p">,</span>
                               <span class="n">qmin</span><span class="o">=</span><span class="n">qmin</span><span class="p">,</span>
                               <span class="n">qmax</span><span class="o">=</span><span class="n">qmax</span><span class="p">,</span>
                               <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                               <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                               <span class="n">toggle_mode_on</span><span class="o">=</span><span class="n">toggle_mode_on</span><span class="p">,</span>
                               <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                               <span class="n">update_chisqr</span><span class="o">=</span><span class="n">update_chisqr</span><span class="p">,</span>
                               <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## draw model 2D with no initial data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_model2D</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                               <span class="n">page_id</span><span class="o">=</span><span class="n">page_id</span><span class="p">,</span>
                               <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                               <span class="n">enable2D</span><span class="o">=</span><span class="n">enable2D</span><span class="p">,</span>
                               <span class="n">smearer</span><span class="o">=</span><span class="n">smearer</span><span class="p">,</span>
                               <span class="n">qmin</span><span class="o">=</span><span class="n">qmin</span><span class="p">,</span>
                               <span class="n">qmax</span><span class="o">=</span><span class="n">qmax</span><span class="p">,</span>
                               <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                               <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                               <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                               <span class="n">toggle_mode_on</span><span class="o">=</span><span class="n">toggle_mode_on</span><span class="p">,</span>
                               <span class="n">update_chisqr</span><span class="o">=</span><span class="n">update_chisqr</span><span class="p">,</span>
                               <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.onFit"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.onFit">[docs]</a>    <span class="k">def</span> <span class="nf">onFit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get series of data, model, associates parameters and range and send then</span>
<span class="sd">        to  series of fitters. Fit data and model, display result to</span>
<span class="sd">        corresponding panels.</span>
<span class="sd">        :param uid: id related to the panel currently calling this fit function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;no page to fit&quot;</span><span class="p">)</span> <span class="c1"># Should never happen</span>

        <span class="n">sim_page_uid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">batch_page_uid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="n">sim_page_uid</span><span class="p">:</span>
            <span class="n">fit_type</span> <span class="o">=</span> <span class="s1">&#39;simultaneous&#39;</span>
        <span class="k">elif</span> <span class="n">uid</span> <span class="o">==</span> <span class="n">batch_page_uid</span><span class="p">:</span>
            <span class="n">fit_type</span> <span class="o">=</span> <span class="s1">&#39;combined_batch&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_type</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>

        <span class="n">fitter_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sim_fitter</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s1">&#39;simultaneous&#39;</span><span class="p">:</span>
            <span class="c1"># for simultaneous fitting only one fitter is needed</span>
            <span class="n">sim_fitter</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">()</span>
            <span class="n">sim_fitter</span><span class="o">.</span><span class="n">fitter_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span><span class="o">.</span><span class="n">uid</span>
            <span class="n">fitter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_fitter</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_pg</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">list_page_id</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fit_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">page_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c1"># For simulfit (uid give with None), do for-loop</span>
            <span class="c1"># if uid is specified (singlefit), do it only on the page.</span>
            <span class="k">if</span> <span class="n">page_id</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sim_page_uid</span><span class="p">,</span> <span class="n">batch_page_uid</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span> <span class="ow">and</span> <span class="n">page_id</span> <span class="o">!=</span> <span class="n">uid</span><span class="p">:</span> <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">page_info</span><span class="o">.</span><span class="n">get_scheduled</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">page_info</span><span class="o">.</span><span class="n">nbr_residuals_computed</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_fit_weight</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
                                        <span class="n">flag</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">get_weight_flag</span><span class="p">(),</span>
                                        <span class="n">is2d</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">_is_2D</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">param_toFit</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No fitting parameters for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">page</span><span class="o">.</span><span class="n">window_caption</span>
                        <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">)</span>
                        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">_update_paramv_on_fit</span><span class="p">():</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fitting range or parameter values are&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; invalid in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                                    <span class="n">page</span><span class="o">.</span><span class="n">window_caption</span>
                        <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">)</span>
                        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">False</span>

                    <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">param_toFit</span><span class="p">]</span>
                    <span class="n">fitproblem_list</span> <span class="o">=</span> <span class="n">page_info</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">fitproblem</span> <span class="ow">in</span>  <span class="n">fitproblem_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sim_fitter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">fitter</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">()</span>
                            <span class="n">fitter</span><span class="o">.</span><span class="n">fitter_id</span> <span class="o">=</span> <span class="n">page_id</span>
                            <span class="n">fitter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitter</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fitter</span> <span class="o">=</span> <span class="n">sim_fitter</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_problem_to_fit</span><span class="p">(</span><span class="n">fitproblem</span><span class="o">=</span><span class="n">fitproblem</span><span class="p">,</span>
                                                 <span class="n">pars</span><span class="o">=</span><span class="n">pars</span><span class="p">,</span>
                                                 <span class="n">fitter</span><span class="o">=</span><span class="n">fitter</span><span class="p">,</span>
                                                 <span class="n">fit_id</span><span class="o">=</span><span class="n">fit_id</span><span class="p">)</span>
                        <span class="n">fit_id</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">list_page_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span>
                    <span class="n">page_info</span><span class="o">.</span><span class="n">clear_model_param</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fitting terminated&quot;</span>
                <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fitting error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">)</span>
                <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="c1">## If a thread is already started, stop it</span>
        <span class="c1">#if self.calc_fitis not None and self.calc_fit.isrunning():</span>
        <span class="c1">#    self.calc_fit.stop()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fitting is in progress...&quot;</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;progress&quot;</span><span class="p">))</span>

        <span class="c1">#Handler used to display fit message</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">ConsoleUpdate</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                                <span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">improvement_delta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># batch fit</span>
        <span class="n">batch_inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">batch_outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;simultaneous&quot;</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span>
        <span class="k">elif</span> <span class="n">fit_type</span> <span class="o">==</span> <span class="s2">&quot;combined_batch&quot;</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">batch_on</span><span class="p">:</span>
            <span class="n">calc_fit</span> <span class="o">=</span> <span class="n">FitThread</span><span class="p">(</span><span class="n">handler</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span>
                                 <span class="n">fn</span><span class="o">=</span><span class="n">fitter_list</span><span class="p">,</span>
                                 <span class="n">pars</span><span class="o">=</span><span class="n">pars</span><span class="p">,</span>
                                 <span class="n">batch_inputs</span><span class="o">=</span><span class="n">batch_inputs</span><span class="p">,</span>
                                 <span class="n">batch_outputs</span><span class="o">=</span><span class="n">batch_outputs</span><span class="p">,</span>
                                 <span class="n">page_id</span><span class="o">=</span><span class="n">list_page_id</span><span class="p">,</span>
                                 <span class="n">completefn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_fit_complete</span><span class="p">,</span>
                                 <span class="n">reset_flag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_reset_flag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## Perform more than 1 fit at the time</span>
            <span class="n">calc_fit</span> <span class="o">=</span> <span class="n">FitThread</span><span class="p">(</span><span class="n">handler</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span>
                                 <span class="n">fn</span><span class="o">=</span><span class="n">fitter_list</span><span class="p">,</span>
                                 <span class="n">batch_inputs</span><span class="o">=</span><span class="n">batch_inputs</span><span class="p">,</span>
                                 <span class="n">batch_outputs</span><span class="o">=</span><span class="n">batch_outputs</span><span class="p">,</span>
                                 <span class="n">page_id</span><span class="o">=</span><span class="n">list_page_id</span><span class="p">,</span>
                                 <span class="n">updatefn</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="n">update_fit</span><span class="p">,</span>
                                 <span class="n">completefn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit_completed</span><span class="p">)</span>
        <span class="c1">#self.fit_thread_list[current_page_id] = calc_fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_thread_list</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_fit</span>
        <span class="n">calc_fit</span><span class="o">.</span><span class="n">queue</span><span class="p">()</span>
        <span class="n">calc_fit</span><span class="o">.</span><span class="n">ready</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fitting is in progress...&quot;</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;progress&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Plugin.remove_plot"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.remove_plot">[docs]</a>    <span class="k">def</span> <span class="nf">remove_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        remove model plot when a fit page is closed</span>
<span class="sd">        :param uid: the id related to the fitpage to close</span>
<span class="sd">        :param fid: the id of the fitproblem(data, model, range,etc)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">fitproblemList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">get_fit_problem</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fitproblem</span> <span class="ow">in</span> <span class="n">fitproblemList</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_fit_data</span><span class="p">()</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_model</span><span class="p">()</span>
            <span class="n">plot_id</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">plot_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">theory</span><span class="p">:</span>
                <span class="n">plot_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
            <span class="n">group_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">group_id</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">plot_id</span><span class="p">,</span>
                                                   <span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
                                                   <span class="n">action</span><span class="o">=</span><span class="s1">&#39;remove&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Plugin.store_data"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.store_data">[docs]</a>    <span class="k">def</span> <span class="nf">store_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">data_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive a list of data and store them ans well as a caption of</span>
<span class="sd">        the fit page where they come from.</span>
<span class="sd">        :param uid: if related to a fit page</span>
<span class="sd">        :param data_list: list of data to fit</span>
<span class="sd">        :param caption: caption of the window related to these data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">set_fit_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">caption</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">set_fit_tab_caption</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plugin.on_add_new_page"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_add_new_page">[docs]</a>    <span class="k">def</span> <span class="nf">on_add_new_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ask fit panel to create a new empty page</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">add_empty_page</span><span class="p">()</span>
            <span class="c1"># add data associated to the page created</span>
            <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;Page Created&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Page was already Created&quot;</span>
                <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Creating Fit page: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Plugin.add_fit_page"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.add_fit_page">[docs]</a>    <span class="k">def</span> <span class="nf">add_fit_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        given a data, ask to the fitting panel to create a new fitting page,</span>
<span class="sd">        get this page and store it into the page_finder of this plug-in</span>
<span class="sd">        :param data: is a list of data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># page could be None when loading state files</span>
        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">page</span>
        <span class="c1">#append Data1D to the panel containing its theory</span>
        <span class="c1">#if theory already plotted</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
            <span class="n">theory_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">get_theory_data</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Data2D</span><span class="p">):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">theory_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">group_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Model1D&quot;</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                                 <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
                                              <span class="n">action</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">prev_data</span><span class="o">=</span><span class="n">theory_data</span><span class="p">,</span>
                                            <span class="n">new_data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">theory_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">group_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Model2D&quot;</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">theory_data</span><span class="o">.</span><span class="n">group_id</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                                 <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
                                              <span class="n">action</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">prev_data</span><span class="o">=</span><span class="n">theory_data</span><span class="p">,</span>
                                            <span class="n">new_data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_data</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">data_list</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">get_data_list</span><span class="p">(),</span>
                        <span class="n">caption</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">window_caption</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_on</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span><span class="o">.</span><span class="n">draw_page</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_on</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span><span class="o">.</span><span class="n">draw_page</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">page</span></div>

    <span class="k">def</span> <span class="nf">_onEVT_SLICER_PANEL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        receive and event telling to update a panel with a name starting with</span>
<span class="sd">        event.panel_name. this method update slicer panel</span>
<span class="sd">        for a given interactor.</span>

<span class="sd">        :param event: contains type of slicer , parameters for updating</span>
<span class="sd">            the panel and panel_name to find the slicer &#39;s panel concerned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">panel_name</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">panels</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">panel_name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">panels</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">window_caption</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">panels</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">set_slicer</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="c1">#self.parent._mgr.Update()</span>

    <span class="k">def</span> <span class="nf">_closed_fitpage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        request fitpanel to close a given page when its unique data is removed</span>
<span class="sd">        from the plot. close fitpage only when the a loaded data is removed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;is_data&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">is_data</span> <span class="ow">or</span> \
                <span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;Data1D&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">close_page_with_data</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset_schedule_problem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        unschedule or schedule all fitproblem to be fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># case that uid is not specified</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">page_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_tofit</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># when uid is given</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">schedule_tofit</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_problem_to_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitproblem</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">fitter</span><span class="p">,</span> <span class="n">fit_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and set fitter with series of data and model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_fit_data</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_model</span><span class="p">()</span>
        <span class="n">smearer</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_smearer</span><span class="p">()</span>
        <span class="n">qmin</span><span class="p">,</span> <span class="n">qmax</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_range</span><span class="p">()</span>

        <span class="c1">#Extra list of parameters and their constraints</span>
        <span class="n">listOfConstraint</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_model_param</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                <span class="c1">## check if constraint</span>
                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">listOfConstraint</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">new_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">fitter</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">new_model</span><span class="p">,</span> <span class="n">fit_id</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">constraints</span><span class="o">=</span><span class="n">listOfConstraint</span><span class="p">)</span>
        <span class="n">fitter</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">fit_id</span><span class="p">,</span> <span class="n">smearer</span><span class="o">=</span><span class="n">smearer</span><span class="p">,</span> <span class="n">qmin</span><span class="o">=</span><span class="n">qmin</span><span class="p">,</span>
                        <span class="n">qmax</span><span class="o">=</span><span class="n">qmax</span><span class="p">)</span>
        <span class="n">fitter</span><span class="o">.</span><span class="n">select_problem_for_fit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">fit_id</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_onSelect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        when Select data to fit a new page is created .Its reference is</span>
<span class="sd">        added to self.page_finder</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">panel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_panel</span>
        <span class="k">if</span> <span class="n">panel</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;Fitting:_onSelect: NonType panel&quot;</span>
        <span class="n">Plugin</span><span class="o">.</span><span class="n">on_perspective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_data</span><span class="p">(</span><span class="n">panel</span><span class="p">)</span>

<div class="viewcode-block" id="Plugin.select_data"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.select_data">[docs]</a>    <span class="k">def</span> <span class="nf">select_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">panel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">plottable</span> <span class="ow">in</span> <span class="n">panel</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">plottables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plottable</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Data1D&quot;</span><span class="p">,</span> <span class="s2">&quot;Theory1D&quot;</span><span class="p">]:</span>
                <span class="n">data_id</span> <span class="o">=</span> <span class="n">panel</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">selected_plottable</span>
                <span class="k">if</span> <span class="n">plottable</span> <span class="o">==</span> <span class="n">panel</span><span class="o">.</span><span class="n">plots</span><span class="p">[</span><span class="n">data_id</span><span class="p">]:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">plottable</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_fit_page</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">])</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">plottable</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_fit_page</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">])</span></div>

<div class="viewcode-block" id="Plugin.update_fit"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.update_fit">[docs]</a>    <span class="k">def</span> <span class="nf">update_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;update_fit result&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_batch_fit_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span>
                            <span class="n">batch_outputs</span><span class="p">,</span> <span class="n">batch_inputs</span><span class="p">,</span> <span class="n">elapsed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display fit result in batch</span>
<span class="sd">        :param result: list of objects received from fitters</span>
<span class="sd">        :param pars: list of  fitted parameters names</span>
<span class="sd">        :param page_id: list of page ids which called fit function</span>
<span class="sd">        :param elapsed: time spent at the fitting level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">page_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_thread_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_thread_list</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>

        <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_fit_button</span><span class="p">,</span> <span class="n">page_id</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">str_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S &quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fit completed on </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">str_time</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Duration time: </span><span class="si">%s</span><span class="s2"> s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">batch_outputs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">batch_outputs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># format batch_outputs</span>
        <span class="n">batch_outputs</span><span class="p">[</span><span class="s2">&quot;Chi2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#Don&#39;t like these loops</span>
        <span class="c1"># Need to create dictionary of all fitted parameters</span>
        <span class="c1"># since the number of parameters can differ between each fit result</span>
        <span class="k">for</span> <span class="n">list_res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">list_res</span><span class="p">:</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">):</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span>
                <span class="c1">#get all fittable parameters of the current model</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span>  <span class="n">model</span><span class="o">.</span><span class="n">getParamList</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">param</span>  <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">batch_outputs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">getDispParamList</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">is_fittable</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="n">param</span> <span class="ow">in</span> <span class="n">batch_outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">del</span> <span class="n">batch_outputs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                <span class="c1"># Add fitted parameters and their error</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">param_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">batch_outputs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">err_param</span> <span class="o">=</span> <span class="s2">&quot;error on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">err_param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">batch_inputs</span><span class="p">[</span><span class="n">err_param</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">list_res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">list_res</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fitter_id</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">correct_result</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">):</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;sas_data&quot;</span><span class="p">):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sas_data</span>

                <span class="n">is_data2d</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Data2D</span><span class="p">)</span>
                <span class="c1"># Check consistency of arrays</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_data2d</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">theory</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">])</span> <span class="ow">and</span> \
                        <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
                        <span class="n">correct_result</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">copy_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">new_theory</span> <span class="o">=</span> <span class="n">copy_data</span><span class="o">.</span><span class="n">data</span>
                    <span class="n">new_theory</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">theory</span>
                    <span class="n">new_theory</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="bp">False</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">correct_result</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c1"># Get all fittable parameters of the current model</span>
                <span class="n">param_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">getParamList</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">getDispParamList</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
                        <span class="c1"># Ensure polydispersity results are displayed</span>
                        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">is_fittable</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">p2</span> <span class="o">==</span> <span class="s1">&#39;width&#39;</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">param_list</span><span class="p">)</span>\
                            <span class="ow">and</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
                            <span class="n">param_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">is_fittable</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="n">param</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
                        <span class="n">param_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">correct_result</span> <span class="ow">or</span> <span class="n">res</span><span class="o">.</span><span class="n">fitness</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> \
                    <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fitness</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">pvec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">pvec</span><span class="p">)):</span>
                    <span class="n">data_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">data_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">model_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">model_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Data </span><span class="si">%s</span><span class="s2"> and Model </span><span class="si">%s</span><span class="s2"> did not fit.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_name</span><span class="p">,</span>
                                                                    <span class="n">model_name</span><span class="p">)</span>
                    <span class="n">ERROR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">BatchCell</span><span class="p">()</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fitness</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fitness</span>
                    <span class="n">batch_outputs</span><span class="p">[</span><span class="s2">&quot;Chi2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
                        <span class="c1"># Save value of  fixed parameters</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">param_list</span><span class="p">:</span>
                            <span class="n">batch_outputs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Save only fitted values</span>
                            <span class="n">batch_outputs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span>
                            <span class="n">batch_inputs</span><span class="p">[</span><span class="s2">&quot;error on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># TODO: Why sometimes res.pvec comes with np.float64?</span>
                    <span class="c1"># probably from scipy lmfit</span>
                    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">pvec</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">pvec</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">pvec</span><span class="p">]</span>

                    <span class="n">cell</span> <span class="o">=</span> <span class="n">BatchCell</span><span class="p">()</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fitness</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fitness</span>
                    <span class="n">batch_outputs</span><span class="p">[</span><span class="s2">&quot;Chi2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                    <span class="c1"># add parameters to batch_results</span>
                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
                        <span class="c1"># save value of  fixed parameters</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">param_list</span><span class="p">:</span>
                            <span class="n">batch_outputs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">param_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                            <span class="c1">#save only fitted values</span>
                            <span class="n">batch_outputs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">pvec</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
                                <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">param_list</span><span class="p">):</span>
                                <span class="n">item</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">stderr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="n">batch_inputs</span><span class="p">[</span><span class="s2">&quot;error on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">batch_inputs</span><span class="p">[</span><span class="s2">&quot;error on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">pvec</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                <span class="c1">#fill the batch result with emtpy value if not in the current</span>
                <span class="c1">#model</span>
                <span class="n">EMPTY</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param_list</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Chi2&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">]:</span>
                        <span class="n">batch_outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EMPTY</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">set_batch_result</span><span class="p">(</span><span class="n">batch_inputs</span><span class="o">=</span><span class="n">batch_inputs</span><span class="p">,</span>
                                                       <span class="n">batch_outputs</span><span class="o">=</span><span class="n">batch_outputs</span><span class="p">)</span>

                <span class="n">cpage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                <span class="n">cpage</span><span class="o">.</span><span class="n">_on_fit_complete</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">pid</span><span class="p">][</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">fitproblem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">pid</span><span class="p">][</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                <span class="n">qmin</span><span class="p">,</span> <span class="n">qmax</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_range</span><span class="p">()</span>
                <span class="n">plot_result</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">correct_result</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_data2d</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_complete1D</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">theory</span><span class="p">,</span> <span class="n">page_id</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span>
                                         <span class="n">elapsed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                         <span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                         <span class="n">weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                         <span class="n">toggle_mode_on</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">update_chisqr</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                         <span class="n">source</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="n">plot_result</span><span class="o">=</span><span class="n">plot_result</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_complete2D</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">new_theory</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                         <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                         <span class="n">page_id</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">elapsed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                         <span class="n">index</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                         <span class="n">qmin</span><span class="o">=</span><span class="n">qmin</span><span class="p">,</span>
                                         <span class="n">qmax</span><span class="o">=</span><span class="n">qmax</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                         <span class="n">toggle_mode_on</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                         <span class="n">update_chisqr</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                         <span class="n">source</span><span class="o">=</span><span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="n">plot_result</span><span class="o">=</span><span class="n">plot_result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_set_batch_result</span><span class="p">(</span><span class="n">page_id</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span>
                                         <span class="n">fid</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                         <span class="n">batch_outputs</span><span class="o">=</span><span class="n">batch_outputs</span><span class="p">,</span>
                                         <span class="n">batch_inputs</span><span class="o">=</span><span class="n">batch_inputs</span><span class="p">)</span>

        <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
        <span class="c1"># Remove parameters that are not shown</span>
        <span class="n">cpage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="n">tbatch_outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">shownkeystr</span> <span class="o">=</span> <span class="n">cpage</span><span class="o">.</span><span class="n">get_copy_params</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Chi2&quot;</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">shownkeystr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tbatch_outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">on_set_batch_result</span><span class="p">,</span> <span class="n">tbatch_outputs</span><span class="p">,</span>
                     <span class="n">batch_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_menu</span><span class="p">)</span>

<div class="viewcode-block" id="Plugin.on_set_batch_result"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_set_batch_result">[docs]</a>    <span class="k">def</span> <span class="nf">on_set_batch_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">batch_outputs</span><span class="p">,</span> <span class="n">batch_inputs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">page_id</span>
        <span class="k">if</span> <span class="n">fid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">pid</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">fitproblem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">pid</span><span class="p">][</span><span class="n">fid</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">nbr_residuals_computed</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_residuals</span><span class="p">()</span>
        <span class="n">theory_data</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_theory_data</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_fit_data</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">fitproblem</span><span class="o">.</span><span class="n">get_model</span><span class="p">()</span>
        <span class="c1">#fill batch result information</span>
        <span class="k">if</span> <span class="s2">&quot;Data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">batch_outputs</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">BatchCell</span><span class="p">()</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">index</span>

        <span class="k">if</span> <span class="n">theory_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1">#Suucessful fit</span>
            <span class="n">theory_data</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
            <span class="n">theory_data</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">theory_data</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Data2D</span><span class="p">):</span>
                <span class="n">group_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
                <span class="n">theory_data</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">group_id</span>
                <span class="k">if</span> <span class="n">group_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">theory_data</span><span class="o">.</span><span class="n">list_group_id</span><span class="p">:</span>
                    <span class="n">theory_data</span><span class="o">.</span><span class="n">list_group_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># associate residuals plot</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Data2D</span><span class="p">):</span>
                    <span class="n">group_id</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
                    <span class="n">residuals</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">group_id</span>
                    <span class="k">if</span> <span class="n">group_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">residuals</span><span class="o">.</span><span class="n">list_group_id</span><span class="p">:</span>
                        <span class="n">residuals</span><span class="o">.</span><span class="n">list_group_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
                <span class="n">batch_outputs</span><span class="p">[</span><span class="s2">&quot;Chi2&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">object</span> <span class="o">=</span> <span class="p">[</span><span class="n">residuals</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">cell</span><span class="o">.</span><span class="n">object</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">,</span> <span class="n">theory_data</span><span class="p">]</span>
        <span class="n">batch_outputs</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">batch_inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#if key.lower().strip() != &quot;loader&quot;:</span>
            <span class="n">batch_inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">param</span> <span class="o">=</span> <span class="s2">&quot;temperature&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span>  <span class="n">batch_inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">batch_inputs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">batch_inputs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_fit_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">batch_outputs</span><span class="p">,</span>
                       <span class="n">batch_inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">elapsed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display result of the fit on related panel(s).</span>
<span class="sd">        :param result: list of object generated when fit ends</span>
<span class="sd">        :param pars: list of names of parameters fitted</span>
<span class="sd">        :param page_id: list of page ids which called fit function</span>
<span class="sd">        :param elapsed: time spent at the fitting level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">str_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S &quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Fit completed on </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">str_time</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Duration time: </span><span class="si">%s</span><span class="s2"> s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_panel</span><span class="p">,</span> <span class="n">PlotResultEvent</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">))</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_fit_button</span><span class="p">,</span> <span class="n">page_id</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_thread_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">page_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">page_id</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">## fit more than 1 model at the same time</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Update potential simfit page(s)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span><span class="o">.</span><span class="n">_on_fit_complete</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span><span class="o">.</span><span class="n">_on_fit_complete</span><span class="p">()</span>
            <span class="c1"># Update all fit pages</span>
            <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">page_id</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">fit_msg</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">mesg</span>
                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">fitness</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> \
                    <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fitness</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">pvec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">pvec</span><span class="p">)):</span>
                    <span class="n">fit_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fitting did not converge!!!&quot;</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_fit_button</span><span class="p">,</span> <span class="n">page_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#set the panel when fit result are float not list</span>
                    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">pvec</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                        <span class="n">pvec</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">pvec</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pvec</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">pvec</span>
                    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                        <span class="n">stderr</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">stderr</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stderr</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">stderr</span>
                    <span class="n">cpage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                    <span class="c1"># Make sure we got all results</span>
                    <span class="c1">#(CallAfter is important to MAC)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1">#if res is not None:</span>
                        <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">cpage</span><span class="o">.</span><span class="n">onsetValues</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">fitness</span><span class="p">,</span>
                                     <span class="n">res</span><span class="o">.</span><span class="n">param_list</span><span class="p">,</span>
                                     <span class="n">pvec</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
                        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">cpage</span><span class="o">.</span><span class="n">_on_fit_complete</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                        <span class="n">fit_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Singular point: Fitting stopped.&quot;</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">fit_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Singular point: Fitting error occurred.&quot;</span>
                <span class="k">if</span> <span class="n">fit_msg</span><span class="p">:</span>
                    <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">fit_msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">)</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Fit completed but the following error occurred: </span><span class="si">%s</span><span class="s2">&quot;</span>
                   <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">)</span>
            <span class="c1">#msg = &quot;\n&quot;.join((traceback.format_exc(), msg))</span>
            <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_fit_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update Fit button when fit stopped</span>

<span class="sd">        : parameter page_id: fitpage where the button is</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">page_id</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">!=</span> <span class="s1">&#39;list&#39;</span><span class="p">:</span>
            <span class="n">page_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">page_id</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">page_id</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">_on_fit_complete</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_on_show_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Plugin.on_reset_batch_flag"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.on_reset_batch_flag">[docs]</a>    <span class="k">def</span> <span class="nf">on_reset_batch_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set batch_reset_flag</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">menu_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu1</span><span class="o">.</span><span class="n">FindItemById</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_reset_flag</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">menu_item</span><span class="o">.</span><span class="n">IsChecked</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">menu_item</span><span class="o">.</span><span class="n">Check</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_reset_flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">menu_item</span><span class="o">.</span><span class="n">Check</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_reset_flag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1">## post a message to status bar</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Set Chain Fitting: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_reset_flag</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">))</span></div>


    <span class="k">def</span> <span class="nf">_on_slicer_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive a panel as event and send it to guiframe</span>

<span class="sd">        :param event: event containing a panel</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">panel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slicer_panels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">panel</span><span class="p">)</span>
            <span class="c1"># Set group ID if available</span>
            <span class="n">event_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">popup_panel</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">panel</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">panel</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">event_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mypanels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">panel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_onclearslicer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the boxslicer when close the panel associate with this slicer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">GetTitle</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">panel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slicer_panels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">panel</span><span class="o">.</span><span class="n">window_caption</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">panels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">panels</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="s2">&quot;uid&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">panels</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">uid</span> <span class="o">==</span> <span class="n">panel</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">uid</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">panels</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">onClearSlicer</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                            <span class="c1">#self.parent._mgr.Update()</span>
                            <span class="k">break</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_on_model_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        react to model selection on any combo box or model menu.plot the model</span>

<span class="sd">        :param evt: wx.combobox event</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">model</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">uid</span>
        <span class="n">qmin</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">qmin</span>
        <span class="n">qmax</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">qmax</span>
        <span class="n">caption</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">caption</span>
        <span class="n">enable_smearer</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">enable_smearer</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="c1"># save the name containing the data name with the appropriate model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">enable_smearing</span><span class="p">(</span><span class="n">enable_smearer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">set_range</span><span class="p">(</span><span class="n">qmin</span><span class="o">=</span><span class="n">qmin</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="n">qmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">set_fit_tab_caption</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_on</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_page</span><span class="o">.</span><span class="n">draw_page</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_on</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_page</span><span class="o">.</span><span class="n">draw_page</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update1D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the output of plotting model 1D</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Plot updating ... &quot;</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="Plugin.create_theory_1D"><a class="viewcode-back" href="../../../../../dev/sasview-api/sas.sasgui.perspectives.fitting.html#sas.sasgui.perspectives.fitting.fitting.Plugin.create_theory_1D">[docs]</a>    <span class="k">def</span> <span class="nf">create_theory_1D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                         <span class="n">data_description</span><span class="p">,</span> <span class="n">data_id</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create a theory object associate with an existing Data1D</span>
<span class="sd">            and add it to the data manager.</span>
<span class="sd">            @param x: x-values of the data</span>
<span class="sd">            @param y: y_values of the data</span>
<span class="sd">            @param page_id: fit page ID</span>
<span class="sd">            @param model: model used for fitting</span>
<span class="sd">            @param data: Data1D object to create the theory for</span>
<span class="sd">            @param state: model state</span>
<span class="sd">            @param data_description: title to use in the data manager</span>
<span class="sd">            @param data_id: unique data ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dy</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">is_data</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="c1"># If this is a theory curve, pick the proper symbol to make it a curve</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">GUIFRAME_ID</span><span class="o">.</span><span class="n">CURVE_SYMBOL_NUM</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">is_data</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">dxl</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">dxw</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">_yaxis</span><span class="p">,</span> <span class="n">_yunit</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span>
        <span class="n">_xaxis</span><span class="p">,</span> <span class="n">_xunit</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">group_id</span>
        <span class="k">if</span> <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">group_id</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">data_id</span>
        <span class="c1"># Find if this theory was already plotted and replace that plot given</span>
        <span class="c1"># the same id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">get_theory_data</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">is_data</span><span class="p">:</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

        <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">data_description</span> <span class="o">+</span> <span class="s2">&quot; [&quot;</span> <span class="o">+</span> <span class="n">data_name</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">(</span><span class="n">_xaxis</span><span class="p">,</span> <span class="n">_xunit</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="p">(</span><span class="n">_yaxis</span><span class="p">,</span> <span class="n">_yunit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">set_theory_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span>
                                                  <span class="n">fid</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_theory</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span>
                                  <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_plot</span></div>

    <span class="k">def</span> <span class="nf">_complete1D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
                    <span class="n">weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">toggle_mode_on</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">update_chisqr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">plot_result</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">unsmeared_model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">unsmeared_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">unsmeared_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sq_model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pq_model</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Complete plotting 1D data</span>
<span class="sd">            @param unsmeared_model: fit model, without smearing</span>
<span class="sd">            @param unsmeared_data: data, rescaled to unsmeared model</span>
<span class="sd">            @param unsmeared_error: data error, rescaled to unsmeared model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_finite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">new_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_theory_1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                                         <span class="n">data_description</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                         <span class="n">data_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">plots_to_update</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># List of plottables that have changed since last calculation</span>
        <span class="c1"># Create the new theories</span>
        <span class="k">if</span> <span class="n">unsmeared_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">unsmeared_model_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_theory_1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">unsmeared_model</span><span class="p">,</span>
                                  <span class="n">page_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                                  <span class="n">data_description</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; unsmeared&quot;</span><span class="p">,</span>
                                  <span class="n">data_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; unsmeared&quot;</span><span class="p">)</span>
            <span class="n">plots_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unsmeared_model_plot</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">unsmeared_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">unsmeared_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">unsmeared_data_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_theory_1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">unsmeared_data</span><span class="p">,</span>
                                      <span class="n">page_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                                      <span class="n">data_description</span><span class="o">=</span><span class="s2">&quot;Data unsmeared&quot;</span><span class="p">,</span>
                                      <span class="n">data_id</span><span class="o">=</span><span class="s2">&quot;Data  &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; unsmeared&quot;</span><span class="p">,</span>
                                      <span class="n">dy</span><span class="o">=</span><span class="n">unsmeared_error</span><span class="p">)</span>
                <span class="n">plots_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unsmeared_data_plot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sq_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pq_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sq_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; S(q)&quot;</span>
            <span class="n">sq_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_theory_1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sq_model</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                                  <span class="n">data_description</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; S(q)&quot;</span><span class="p">,</span>
                                  <span class="n">data_id</span><span class="o">=</span><span class="n">sq_id</span><span class="p">)</span>
            <span class="n">plots_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sq_plot</span><span class="p">)</span>
            <span class="n">pq_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; P(q)&quot;</span>
            <span class="n">pq_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_theory_1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pq_model</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
                                  <span class="n">data_description</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; P(q)&quot;</span><span class="p">,</span>
                                  <span class="n">data_id</span><span class="o">=</span><span class="n">pq_id</span><span class="p">)</span>
            <span class="n">plots_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pq_plot</span><span class="p">)</span>
        <span class="c1"># Update the P(Q), S(Q) and unsmeared theory plots if they exist</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plots</span><span class="o">=</span><span class="n">plots_to_update</span><span class="p">,</span>
                                              <span class="n">action</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">))</span>

        <span class="n">current_pg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span>
        <span class="n">batch_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span><span class="o">.</span><span class="n">batch_on</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_on</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">plot_result</span><span class="p">:</span>
            <span class="n">top_data_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">top_data_id</span><span class="p">:</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)))</span>
        <span class="n">caption</span> <span class="o">=</span> <span class="n">current_pg</span><span class="o">.</span><span class="n">window_caption</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">set_fit_tab_caption</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">set_theory_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span>
                                                  <span class="n">fid</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">toggle_mode_on</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                         <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Model2D&quot;</span><span class="p">,</span>
                                      <span class="n">action</span><span class="o">=</span><span class="s2">&quot;Hide&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_chisqr</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cal_chisqr</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                          <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                                          <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                                          <span class="n">page_id</span><span class="o">=</span><span class="n">page_id</span><span class="p">,</span>
                                          <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="n">current_pg</span><span class="p">,</span> <span class="n">Chi2UpdateEvent</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_residuals</span><span class="p">(</span><span class="n">page_id</span><span class="o">=</span><span class="n">page_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                                     <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">number_finite</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Using the present parameters the model does not return any finite value. &quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Computing Error: Model did not return any finite value.&quot;</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Computation  completed!&quot;</span>
            <span class="k">if</span> <span class="n">number_finite</span> <span class="o">!=</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; PROBLEM: For some Q values the model returns non finite intensities!&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;For some Q values the model returns non finite intensities.&quot;</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_calc_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle exception from calculator by posting it as an error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">)))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the output of plotting model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Plot updating ... &quot;</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_complete2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">qmin</span><span class="p">,</span>
                    <span class="n">qmax</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">toggle_mode_on</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">update_chisqr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">plot_result</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complete get the result of modelthread and create model 2D</span>
<span class="sd">        that can be plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_finite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data2D</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">err_image</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">err_data</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;2d&#39;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Analytical model 2D &quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Model2D&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">detector</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">is_data</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">qx_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">qx_data</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">qy_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">qy_data</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">q_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">q_data</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mask</span>
        <span class="c1">## plot boundaries</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ymin</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ymax</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">xmin</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">xmax</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">title</span>

        <span class="n">new_plot</span><span class="o">.</span><span class="n">is_data</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">is_data</span><span class="p">:</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;2d&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Model2D for </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">data_name</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; [&quot;</span> <span class="o">+</span> \
                                    <span class="n">data_name</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>
        <span class="n">theory_data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">new_plot</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">set_theory_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">theory_data</span><span class="p">,</span>
                                                  <span class="n">fid</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_theory</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                  <span class="n">theory</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span>
                                  <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="n">current_pg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span> <span class="ow">and</span> <span class="n">plot_result</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">toggle_mode_on</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                         <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Model1D&quot;</span><span class="p">,</span>
                                      <span class="n">action</span><span class="o">=</span><span class="s2">&quot;Hide&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Chisqr in fitpage</span>
            <span class="k">if</span> <span class="n">update_chisqr</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cal_chisqr</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                          <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                                          <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                                          <span class="n">page_id</span><span class="o">=</span><span class="n">page_id</span><span class="p">,</span>
                                          <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="n">current_pg</span><span class="p">,</span> <span class="n">Chi2UpdateEvent</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_residuals</span><span class="p">(</span><span class="n">page_id</span><span class="o">=</span><span class="n">page_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                                     <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">number_finite</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Using the present parameters the model does not return any finite value. &quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Computing Error: Model did not return any finite value.&quot;</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Computation  completed!&quot;</span>
            <span class="k">if</span> <span class="n">number_finite</span> <span class="o">!=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; PROBLEM: For some Qx,Qy values the model returns non finite intensities!&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;For some Qx,Qy values the model returns non finite intensities.&quot;</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;stop&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_draw_model2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">qmin</span><span class="p">,</span>
                      <span class="n">qmax</span><span class="p">,</span>
                      <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">smearer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">enable2D</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">fid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">toggle_mode_on</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">update_chisqr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        draw model in 2D</span>

<span class="sd">        :param model: instance of the model to draw</span>
<span class="sd">        :param description: the description of the model</span>
<span class="sd">        :param enable2D: when True allows to draw model 2D</span>
<span class="sd">        :param qmin: the minimum value to  draw model 2D</span>
<span class="sd">        :param qmax: the maximum value to draw model 2D</span>
<span class="sd">        :param qstep: the number of division of Qx and Qy of the model to draw</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">enable2D</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">## If a thread is already started, stop it</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_2D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_2D</span><span class="o">.</span><span class="n">isrunning</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_2D</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="c1">## stop just raises a flag to tell the thread to kill</span>
                <span class="c1">## itself -- see the fix in Calc1D implemented to fix</span>
                <span class="c1">## an actual problem.  Seems the fix should also go here</span>
                <span class="c1">## and may be the cause of other noted instabilities</span>
                <span class="c1">##</span>
                <span class="c1">##    -PDB August 12, 2014</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_2D</span><span class="o">.</span><span class="n">isrunning</span><span class="p">():</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_2D</span> <span class="o">=</span> <span class="n">Calc2D</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                  <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                  <span class="n">page_id</span><span class="o">=</span><span class="n">page_id</span><span class="p">,</span>
                                  <span class="n">smearer</span><span class="o">=</span><span class="n">smearer</span><span class="p">,</span>
                                  <span class="n">qmin</span><span class="o">=</span><span class="n">qmin</span><span class="p">,</span>
                                  <span class="n">qmax</span><span class="o">=</span><span class="n">qmax</span><span class="p">,</span>
                                  <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                                  <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                                  <span class="n">toggle_mode_on</span><span class="o">=</span><span class="n">toggle_mode_on</span><span class="p">,</span>
                                  <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                                  <span class="n">completefn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_complete2D</span><span class="p">,</span>
                                  <span class="n">update_chisqr</span><span class="o">=</span><span class="n">update_chisqr</span><span class="p">,</span>
                                  <span class="n">exception_handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_calc_exception</span><span class="p">,</span>
                                  <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_2D</span><span class="o">.</span><span class="n">queue</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_draw_model1D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                      <span class="n">qmin</span><span class="p">,</span> <span class="n">qmax</span><span class="p">,</span> <span class="n">smearer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">toggle_mode_on</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">update_chisqr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span>
                      <span class="n">enable1D</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw model 1D from loaded data1D</span>

<span class="sd">        :param data: loaded data</span>
<span class="sd">        :param model: the model to plot</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">enable1D</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">## If a thread is already started, stop it</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_1D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_1D</span><span class="o">.</span><span class="n">isrunning</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_1D</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="c1">## stop just raises the flag -- the thread is supposed to</span>
                <span class="c1">## then kill itself but cannot.  Paul Kienzle came up with</span>
                <span class="c1">## this fix to prevent threads from stepping on each other</span>
                <span class="c1">## which was causing a simple custom plugin model to crash</span>
                <span class="c1">##Sasview.</span>
                <span class="c1">## We still don&#39;t know why the fit sometimes lauched a second</span>
                <span class="c1">## thread -- something which should also be investigated.</span>
                <span class="c1">## The thread approach was implemented in order to be able</span>
                <span class="c1">## to lauch a computation in a separate thread from the GUI so</span>
                <span class="c1">## that the GUI can still respond to user input including</span>
                <span class="c1">## a request to stop the computation.</span>
                <span class="c1">## It seems thus that the whole thread approach used here</span>
                <span class="c1">## May need rethinking</span>
                <span class="c1">##</span>
                <span class="c1">##    -PDB August 12, 2014</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_1D</span><span class="o">.</span><span class="n">isrunning</span><span class="p">():</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_1D</span> <span class="o">=</span> <span class="n">Calc1D</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                  <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                  <span class="n">page_id</span><span class="o">=</span><span class="n">page_id</span><span class="p">,</span>
                                  <span class="n">qmin</span><span class="o">=</span><span class="n">qmin</span><span class="p">,</span>
                                  <span class="n">qmax</span><span class="o">=</span><span class="n">qmax</span><span class="p">,</span>
                                  <span class="n">smearer</span><span class="o">=</span><span class="n">smearer</span><span class="p">,</span>
                                  <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                                  <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                                  <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                                  <span class="n">toggle_mode_on</span><span class="o">=</span><span class="n">toggle_mode_on</span><span class="p">,</span>
                                  <span class="n">completefn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_complete1D</span><span class="p">,</span>
                                  <span class="c1">#updatefn = self._update1D,</span>
                                  <span class="n">update_chisqr</span><span class="o">=</span><span class="n">update_chisqr</span><span class="p">,</span>
                                  <span class="n">exception_handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_calc_exception</span><span class="p">,</span>
                                  <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_1D</span><span class="o">.</span><span class="n">queue</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot; Error occurred when drawing </span><span class="si">%s</span><span class="s2"> Model 1D: &quot;</span> <span class="o">%</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_cal_chisqr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get handy Chisqr using the output from draw1D and 2D,</span>
<span class="sd">        instead of calling expansive CalcChisqr in guithread</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># default chisqr</span>
        <span class="n">chisqr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">#to compute chisq make sure data has valid data</span>
        <span class="c1"># return None if data is None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_data_validity</span><span class="p">(</span><span class="n">data_copy</span><span class="p">)</span> <span class="ow">or</span> <span class="n">data_copy</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">chisqr</span>

        <span class="c1"># Get data: data I, theory I, and data dI in order</span>
        <span class="k">if</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;Data2D&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">data_copy</span><span class="o">.</span><span class="n">err_data</span> <span class="o">=</span> <span class="n">weight</span>
            <span class="c1"># get rid of zero error points</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">err_data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">theory_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">get_theory_data</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">data_copy</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">theory_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">chisqr</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="n">theory_data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">en</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">err_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 1 d theory from model_thread is only in the range of index</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">data_copy</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">weight</span>
            <span class="k">if</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">dy</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">dy</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## Set consistently w/AbstractFitengine:</span>
                <span class="c1"># But this should be corrected later.</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span>
                <span class="n">dy</span><span class="p">[</span><span class="n">dy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="n">theory_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">get_theory_data</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">data_copy</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">theory_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">chisqr</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="n">theory_data</span><span class="o">.</span><span class="n">y</span>
            <span class="n">en</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># residual</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span> <span class="o">-</span> <span class="n">gn</span><span class="p">)</span> <span class="o">/</span> <span class="n">en</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Unmatch lengths </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fn</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">gn</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">en</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="n">residuals</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">res</span><span class="p">)]</span>
        <span class="c1"># get chisqr only w/finite</span>
        <span class="n">chisqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">residuals</span> <span class="o">*</span> <span class="n">residuals</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_residuals</span><span class="p">(</span><span class="n">page_id</span><span class="o">=</span><span class="n">page_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_copy</span><span class="p">,</span>
                             <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span>
                             <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chisqr</span>

    <span class="k">def</span> <span class="nf">_plot_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_id</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the residuals</span>

<span class="sd">        :param data: data</span>
<span class="sd">        :param index: index array (bool)</span>
<span class="sd">        : Note: this is different from the residuals in cal_chisqr()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Get data: data I, theory I, and data dI in order</span>
        <span class="k">if</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;Data2D&quot;</span><span class="p">:</span>
            <span class="c1"># build residuals</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Data2D</span><span class="p">()</span>
            <span class="c1">#residuals.copy_from_datainfo(data)</span>
            <span class="c1"># Not for trunk the line below, instead use the line above</span>
            <span class="n">data_copy</span><span class="o">.</span><span class="n">clone_without_data</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">residuals</span><span class="p">)</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">data</span>
            <span class="n">theory_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">get_theory_data</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">data_copy</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="n">theory_data</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">en</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">err_data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">en</span> <span class="o">=</span> <span class="n">weight</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span> <span class="o">-</span> <span class="n">gn</span><span class="p">)</span> <span class="o">/</span> <span class="n">en</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">qx_data</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">qx_data</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">qy_data</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">qy_data</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">q_data</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">q_data</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">err_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">qx_data</span><span class="p">)</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">qx_data</span><span class="p">)</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">qy_data</span><span class="p">)</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">qy_data</span><span class="p">)</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">q_data</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">q_data</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">mask</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>
            <span class="c1"># check the lengths</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">q_data</span><span class="p">):</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 1 d theory from model_thread is only in the range of index</span>
            <span class="k">if</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">dy</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">dy</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
                <span class="c1">## Set consitently w/AbstractFitengine:</span>
                <span class="c1">## But this should be corrected later.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dy</span> <span class="o">=</span> <span class="n">weight</span>
                <span class="n">dy</span><span class="p">[</span><span class="n">dy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">theory_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">get_theory_data</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="n">data_copy</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="n">theory_data</span><span class="o">.</span><span class="n">y</span>
            <span class="n">en</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="c1"># build residuals</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">residuals</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span> <span class="o">-</span> <span class="n">gn</span><span class="p">)</span> <span class="o">/</span> <span class="n">en</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ResidualPlot Error: different # of data points in theory&quot;</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">))</span>
                <span class="n">residuals</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span> <span class="o">-</span> <span class="n">gn</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">/</span> <span class="n">en</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">data_copy</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">dxl</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">dxw</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">ytransform</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
            <span class="c1"># For latter scale changes</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">xaxis</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">rm{Q} &#39;</span><span class="p">,</span> <span class="s1">&#39;A^{-1}&#39;</span><span class="p">)</span>
            <span class="n">residuals</span><span class="o">.</span><span class="n">yaxis</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">rm{Residuals} &#39;</span><span class="p">,</span> <span class="s1">&#39;normalized&#39;</span><span class="p">)</span>
        <span class="n">theory_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">theory_data</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">new_plot</span> <span class="o">=</span> <span class="n">residuals</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Residuals for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">theory_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> \
                        <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>
        <span class="c1">## allow to highlight data when plotted</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1">## when 2 data have the same id override the 1 st plotted</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s2">&quot;res&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_copy</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">theory_name</span><span class="p">)</span>
        <span class="c1">##group_id specify on which panel to plot this data</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">get_graph_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">group_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">group_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">group_id</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="s2">&quot;res&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
        <span class="c1">#new_plot.is_data = True</span>
        <span class="c1">##post data to plot</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_finder</span><span class="p">[</span><span class="n">page_id</span><span class="p">]</span><span class="o">.</span><span class="n">set_residuals</span><span class="p">(</span><span class="n">residuals</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span>
                                                <span class="n">fid</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_theory</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">new_plot</span><span class="p">)</span>
        <span class="n">batch_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_panel</span><span class="o">.</span><span class="n">get_page_by_id</span><span class="p">(</span><span class="n">page_id</span><span class="p">)</span><span class="o">.</span><span class="n">batch_on</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_on</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">))</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">SasView 4.2.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../../../sas.html" >sas</a> &raquo;</li>
          <li class="nav-item nav-item-3"><a href="../fitting.html" >sas.sasgui.perspectives.fitting</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2018, The SasView Project.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>