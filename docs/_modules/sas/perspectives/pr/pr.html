<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sas.perspectives.pr.pr &mdash; SasView 3.1.2 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '3.1.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="SasView 3.1.2 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">SasView 3.1.2 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sas.perspectives.pr.pr</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    P(r) perspective for SasView</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c">################################################################################</span>
<span class="c">#This software was developed by the University of Tennessee as part of the</span>
<span class="c">#Distributed Data Analysis of Neutron Scattering Experiments (DANSE)</span>
<span class="c">#project funded by the US National Science Foundation.</span>
<span class="c">#</span>
<span class="c">#See the license text in license.txt</span>
<span class="c">#</span>
<span class="c">#copyright 2009, University of Tennessee</span>
<span class="c">################################################################################</span>


<span class="c"># Make sure the option of saving each curve is available</span>
<span class="c"># Use the I(q) curve as input and compare the output to P(r)</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pylab</span>
<span class="kn">from</span> <span class="nn">sas.guiframe.gui_manager</span> <span class="kn">import</span> <span class="n">MDIFrame</span>
<span class="kn">from</span> <span class="nn">sas.guiframe.dataFitting</span> <span class="kn">import</span> <span class="n">Data1D</span>
<span class="kn">from</span> <span class="nn">sas.guiframe.events</span> <span class="kn">import</span> <span class="n">NewPlotEvent</span>
<span class="kn">from</span> <span class="nn">sas.guiframe.events</span> <span class="kn">import</span> <span class="n">StatusEvent</span>
<span class="kn">from</span> <span class="nn">sas.guiframe.gui_style</span> <span class="kn">import</span> <span class="n">GUIFRAME_ID</span>
<span class="kn">from</span> <span class="nn">sas.pr.invertor</span> <span class="kn">import</span> <span class="n">Invertor</span>
<span class="kn">from</span> <span class="nn">sas.dataloader.loader</span> <span class="kn">import</span> <span class="n">Loader</span>
<span class="kn">import</span> <span class="nn">sas.dataloader</span>

<span class="kn">from</span> <span class="nn">pr_widgets</span> <span class="kn">import</span> <span class="n">load_error</span>
<span class="kn">from</span> <span class="nn">sas.guiframe.plugin_base</span> <span class="kn">import</span> <span class="n">PluginBase</span>


<span class="n">PR_FIT_LABEL</span> <span class="o">=</span> <span class="s">r&quot;$P_{fit}(r)$&quot;</span>
<span class="n">PR_LOADED_LABEL</span> <span class="o">=</span> <span class="s">r&quot;$P_{loaded}(r)$&quot;</span>
<span class="n">IQ_DATA_LABEL</span> <span class="o">=</span> <span class="s">r&quot;$I_{obs}(q)$&quot;</span>
<span class="n">IQ_FIT_LABEL</span> <span class="o">=</span> <span class="s">r&quot;$I_{fit}(q)$&quot;</span>
<span class="n">IQ_SMEARED_LABEL</span> <span class="o">=</span> <span class="s">r&quot;$I_{smeared}(q)$&quot;</span>
<span class="n">GROUP_ID_IQ_DATA</span> <span class="o">=</span> <span class="s">r&quot;$I_{obs}(q)$&quot;</span>
<span class="n">GROUP_ID_PR_FIT</span> <span class="o">=</span> <span class="s">r&quot;$P_{fit}(r)$&quot;</span>



<div class="viewcode-block" id="Plugin"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin">[docs]</a><span class="k">class</span> <span class="nc">Plugin</span><span class="p">(</span><span class="n">PluginBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        P(r) inversion perspective</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_ALPHA</span> <span class="o">=</span> <span class="mf">0.0001</span>
    <span class="n">DEFAULT_NFUNC</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">DEFAULT_DMAX</span> <span class="o">=</span> <span class="mf">140.0</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">PluginBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Pr Inversion&quot;</span><span class="p">)</span>
        <span class="c">## Simulation window manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simview</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c">## State data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_ALPHA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_NFUNC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_DMAX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_min</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_max</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_bck</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">## Remember last plottable processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_data</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_file_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">## Time elapsed for last computation [sec]</span>
        <span class="c"># Start with a good default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">=</span> <span class="mf">0.022</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iq_data_shown</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c">## Current invertor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invertor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span> <span class="o">=</span> <span class="n">IQ_DATA_LABEL</span>
        <span class="c"># Copy of the last result in case we need to display it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_pr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_out</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_cov</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">## Calculation thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_thread</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">## Estimation thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">## Result panel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">## Currently views plottable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">## Number of P(r) points to display on the output plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pr_npts</span> <span class="o">=</span> <span class="mi">51</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_output</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_output_unity</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c">## List of added P(r) plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_Iq</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_plot_id</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Associate the inversion state reader with .prv files</span>
        <span class="kn">from</span> <span class="nn">inversion_state</span> <span class="kn">import</span> <span class="n">Reader</span>

        <span class="c"># Create a CanSAS/Pr reader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extensions</span> <span class="o">=</span> <span class="s">&#39;.prv&#39;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">Loader</span><span class="p">()</span>
        <span class="n">l</span><span class="o">.</span><span class="n">associate_file_reader</span><span class="p">(</span><span class="s">&#39;.prv&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span><span class="p">)</span>
        <span class="c">#l.associate_file_reader(&quot;.svs&quot;, self.state_reader)</span>

        <span class="c"># Log startup</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Pr(r) plug-in started&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Plugin.delete_data"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.delete_data">[docs]</a>    <span class="k">def</span> <span class="nf">delete_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        delete the data association with prview</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">clear_panel</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Plugin.get_data"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns the current data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span>
</div>
<div class="viewcode-block" id="Plugin.set_state"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">datainfo</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call-back method for the inversion state reader.</span>
<span class="sd">        This method is called when a .prv file is loaded.</span>

<span class="sd">        :param state: InversionState object</span>
<span class="sd">        :param datainfo: Data1D object [optional]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">datainfo</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;list&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datainfo</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">datainfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">datainfo</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Pr.set_state: datainfo parameter cannot &quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;be None in standalone mode&quot;</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">msg</span>

            <span class="c"># Ensuring that plots are coordinated correctly</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s">&#39;prstate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="n">time_str</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%b </span><span class="si">%d</span><span class="s"> %H:%M&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

            <span class="c"># Check that no time stamp is already appended</span>
            <span class="n">max_char</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s">&#39;prstate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;[&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_char</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_char</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s">&#39;prstate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>

            <span class="n">datainfo</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s">&#39;prstate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> \
                <span class="n">data</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s">&#39;prstate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_char</span><span class="p">]</span>\
                <span class="o">+</span> <span class="s">&#39; [&#39;</span> <span class="o">+</span> <span class="n">time_str</span> <span class="o">+</span> <span class="s">&#39;]&#39;</span>

            <span class="n">data</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s">&#39;prstate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">file</span>
            <span class="c"># TODO:</span>
            <span class="c">#remove this call when state save all information about the gui data</span>
            <span class="c"># such as ID , Group_ID, etc...</span>
            <span class="c">#make self.current_plottable = datainfo directly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">create_gui_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s">&#39;prstate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">file</span>

            <span class="c"># Make sure the user sees the P(r) panel after loading</span>
            <span class="c">#self.parent.set_perspective(self.perspective)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_perspective</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="c"># Load the P(r) results</span>
            <span class="c">#state = self.state_reader.get_state()</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="o">.</span><span class="n">id</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">data_list</span><span class="o">=</span><span class="n">data_dict</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="p">,</span>
                                                   <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;prview.set_state: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Plugin.help"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.help">[docs]</a>    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show a general help dialog.</span>

<span class="sd">        :TODO: replace the text with a nice image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">inversion_panel</span> <span class="kn">import</span> <span class="n">HelpDialog</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">HelpDialog</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dialog</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_fit_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Generate P(r) for sphere</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mf">60.0</span>
        <span class="n">d_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">d_max</span><span class="p">,</span> <span class="n">d_max</span> <span class="o">/</span> <span class="mf">51.0</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="n">pr_err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

        <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr_theory</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">radius</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">value</span>
            <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">pr_err</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="n">d_max</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c"># Perform fit</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">Invertor</span><span class="p">()</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">d_max</span> <span class="o">=</span> <span class="n">d_max</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">pr_err</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">pr_fit</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="si">%g</span><span class="s"> +- </span><span class="si">%g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>

        <span class="c"># Show input P(r)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Pr&quot;</span>
        <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P_{obs}(r)&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{r}&quot;</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{P(r)} &quot;</span><span class="p">,</span> <span class="s">&quot;cm^{-3}&quot;</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="s">&quot;P_{obs}(r)&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;P_{obs}(r)&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_theory</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">new_plot</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">))</span>

        <span class="c"># Show P(r) fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>

        <span class="c"># Show I(q) fit</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">/</span> <span class="mf">51.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_iq</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

<div class="viewcode-block" id="Plugin.show_shpere"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.show_shpere">[docs]</a>    <span class="k">def</span> <span class="nf">show_shpere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">70.0</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="mf">70.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Show P(r)</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">sum_true</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="n">y_true</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr_theory</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">radius</span><span class="p">)</span>
            <span class="n">sum_true</span> <span class="o">+=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">/</span> <span class="n">sum_true</span> <span class="o">*</span> <span class="n">x_range</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c"># Show the theory P(r)</span>
        <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">GUIFRAME_ID</span><span class="o">.</span><span class="n">CURVE_SYMBOL_NUM</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P_{true}(r)&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{r}&quot;</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{P(r)} &quot;</span><span class="p">,</span> <span class="s">&quot;cm^{-3}&quot;</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;P_{true}(r)&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="s">&quot;P_{true}(r)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_theory</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">new_plot</span><span class="p">)</span>
        <span class="c">#Put this call in plottables/guitools</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span>
                                               <span class="n">title</span><span class="o">=</span><span class="s">&quot;Sphere P(r)&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Plugin.get_npts"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.get_npts">[docs]</a>    <span class="k">def</span> <span class="nf">get_npts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of points in the I(q) data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Plugin.show_iq"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.show_iq">[docs]</a>    <span class="k">def</span> <span class="nf">show_iq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Display computed I(q)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qtemp</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">x</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">qtemp</span> <span class="o">=</span> <span class="n">q</span>

        <span class="c"># Make a plot</span>
        <span class="n">maxq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">q_i</span> <span class="ow">in</span> <span class="n">qtemp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">q_i</span> <span class="o">&gt;</span> <span class="n">maxq</span><span class="p">:</span>
                <span class="n">maxq</span> <span class="o">=</span> <span class="n">q_i</span>

        <span class="n">minq</span> <span class="o">=</span> <span class="mf">0.001</span>

        <span class="c"># Check for user min/max</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pr</span><span class="o">.</span><span class="n">q_min</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">minq</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">q_min</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pr</span><span class="o">.</span><span class="n">q_max</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">maxq</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">q_max</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">minq</span><span class="p">,</span> <span class="n">maxq</span><span class="p">,</span> <span class="n">maxq</span> <span class="o">/</span> <span class="mf">301.0</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">iq</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">print</span> <span class="s">&quot;Error getting error&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">GUIFRAME_ID</span><span class="o">.</span><span class="n">CURVE_SYMBOL_NUM</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">IQ_FIT_LABEL</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{Q}&quot;</span><span class="p">,</span> <span class="s">&#39;A^{-1}&#39;</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{Intensity} &quot;</span><span class="p">,</span> <span class="s">&quot;cm^{-1}&quot;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;I(q)&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>

        <span class="c"># If we have a group ID, use it</span>
        <span class="k">if</span> <span class="n">pr</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;plot_group_id&quot;</span><span class="p">):</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s">&quot;plot_group_id&quot;</span><span class="p">]</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IQ_FIT_LABEL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_theory</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">new_plot</span><span class="p">)</span>

        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">))</span>

        <span class="c"># If we have used slit smearing, plot the smeared I(q) too</span>
        <span class="k">if</span> <span class="n">pr</span><span class="o">.</span><span class="n">slit_width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pr</span><span class="o">.</span><span class="n">slit_height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">minq</span><span class="p">,</span> <span class="n">maxq</span><span class="p">,</span> <span class="n">maxq</span> <span class="o">/</span> <span class="mf">301.0</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">iq_smeared</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">print</span> <span class="s">&quot;Error getting error&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">GUIFRAME_ID</span><span class="o">.</span><span class="n">CURVE_SYMBOL_NUM</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">IQ_SMEARED_LABEL</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{Q}&quot;</span><span class="p">,</span> <span class="s">&#39;A^{-1}&#39;</span><span class="p">)</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{Intensity} &quot;</span><span class="p">,</span> <span class="s">&quot;cm^{-1}&quot;</span><span class="p">)</span>
            <span class="c"># If we have a group ID, use it</span>
            <span class="k">if</span> <span class="n">pr</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;plot_group_id&quot;</span><span class="p">):</span>
                <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s">&quot;plot_group_id&quot;</span><span class="p">]</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">IQ_SMEARED_LABEL</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_theory</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">new_plot</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_on_pr_npts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redisplay P(r) with a different number of points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">inversion_panel</span> <span class="kn">import</span> <span class="n">PrDistDialog</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">PrDistDialog</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">set_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pr_npts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dialog</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pr_npts</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">get_content</span><span class="p">()</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_pr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_pr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cov</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>


<div class="viewcode-block" id="Plugin.show_pr"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.show_pr">[docs]</a>    <span class="k">def</span> <span class="nf">show_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Show P(r)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">d_max</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">d_max</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pr_npts</span><span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pmax</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">cov2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">cov2</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dy</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">pr_err</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">cov2</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">pr</span><span class="o">.</span><span class="n">d_max</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="c"># keep track of the maximum P(r) value</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">pmax</span><span class="p">:</span>
                <span class="n">pmax</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_output</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">total</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">/</span> <span class="n">total</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_output_unity</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">pmax</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">/</span> <span class="n">pmax</span>

        <span class="k">if</span> <span class="n">cov2</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">GUIFRAME_ID</span><span class="o">.</span><span class="n">CURVE_SYMBOL_NUM</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">PR_FIT_LABEL</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{r}&quot;</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{P(r)} &quot;</span><span class="p">,</span> <span class="s">&quot;cm^{-3}&quot;</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;P(r) fit&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">PR_FIT_LABEL</span>
        <span class="c"># Make sure that the plot is linear</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">xtransform</span> <span class="o">=</span> <span class="s">&quot;x&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">ytransform</span> <span class="o">=</span> <span class="s">&quot;y&quot;</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">GROUP_ID_PR_FIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_theory</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">new_plot</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;P(r) fit&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">d_max</span>
</div>
<div class="viewcode-block" id="Plugin.load"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data. This will eventually be replaced</span>
<span class="sd">        by our standard DataLoader class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">class</span> <span class="nc">FileData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">err</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_current_file_data</span> <span class="o">=</span> <span class="n">FileData</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="c"># Use data loader to load file</span>
        <span class="n">dataread</span> <span class="o">=</span> <span class="n">data</span>
        <span class="c"># Notify the user if we could not read the file</span>
        <span class="k">if</span> <span class="n">dataread</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="s">&quot;Invalid data&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">err</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">dataread</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;Data1D&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">dataread</span><span class="o">.</span><span class="n">x</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">dataread</span><span class="o">.</span><span class="n">y</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">dataread</span><span class="o">.</span><span class="n">dy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataread</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataread</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">dataread</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">dataread</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">dataread</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dy</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;PrView only allows a single data set at a time. &quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;Only the first data set was loaded.&quot;</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dataread</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="s">&quot;This tool can only read 1D data&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_current_file_data</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_file_data</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_file_data</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span>
</div>
<div class="viewcode-block" id="Plugin.load_columns"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.load_columns">[docs]</a>    <span class="k">def</span> <span class="nf">load_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&quot;sphere_60_q0_2.txt&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load 2- or 3- column ascii</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Read the data from the data file</span>
        <span class="n">data_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data_err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">min_err</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">input_f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">buff</span> <span class="o">=</span> <span class="n">input_f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                            <span class="c">#scale = 0.05/math.sqrt(y)</span>
                            <span class="n">min_err</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">y</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">min_err</span>
                        <span class="c">#err = 0</span>

                    <span class="n">data_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                    <span class="n">data_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_y</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="n">data_err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_err</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">scale</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;The loaded file had no error bars, statistical errors are assumed.&quot;</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">message</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span><span class="p">,</span> <span class="n">data_err</span>
</div>
<div class="viewcode-block" id="Plugin.load_abs"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.load_abs">[docs]</a>    <span class="k">def</span> <span class="nf">load_abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load an IGOR .ABS reduced file</span>

<span class="sd">        :param path: file path</span>

<span class="sd">        :return: x, y, err vectors</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Read the data from the data file</span>
        <span class="n">data_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data_err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">min_err</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">data_started</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">input_f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">buff</span> <span class="o">=</span> <span class="n">input_f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data_started</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">err</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                                <span class="c">#scale = 0.05/math.sqrt(y)</span>
                                <span class="n">min_err</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">y</span>
                            <span class="n">err</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">min_err</span>
                            <span class="c">#err = 0</span>

                        <span class="n">data_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                        <span class="n">data_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_y</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                        <span class="n">data_err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_err</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;The 6 columns&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">data_started</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">scale</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;The loaded file had no error bars, statistical errors are assumed.&quot;</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">message</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span><span class="p">,</span> <span class="n">data_err</span>
</div>
<div class="viewcode-block" id="Plugin.pr_theory"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.pr_theory">[docs]</a>    <span class="k">def</span> <span class="nf">pr_theory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return P(r) of a sphere for a given R</span>
<span class="sd">            For test purposes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">R</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">12.0</span> <span class="o">*</span> <span class="p">((</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="n">R</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="n">R</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="n">R</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
</div>
<div class="viewcode-block" id="Plugin.get_context_menu"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.get_context_menu">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plotpanel</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the context menu items available for P(r)</span>

<span class="sd">        :param graph: the Graph object to which we attach the context menu</span>

<span class="sd">        :return: a list of menu items with call-back function</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">plotpanel</span><span class="o">.</span><span class="n">graph</span>
        <span class="c"># Look whether this Graph contains P(r) data</span>
        <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">selected_plottable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plotpanel</span><span class="o">.</span><span class="n">plots</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">plotpanel</span><span class="o">.</span><span class="n">plots</span><span class="p">[</span><span class="n">graph</span><span class="o">.</span><span class="n">selected_plottable</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">PR_FIT_LABEL</span><span class="p">:</span>
            <span class="c">#add_data_hint = &quot;Load a data file and display it on this plot&quot;</span>
            <span class="c">#[&quot;Add P(r) data&quot;,add_data_hint , self._on_add_data],</span>
            <span class="n">change_n_hint</span> <span class="o">=</span> <span class="s">&quot;Change the number of&quot;</span>
            <span class="n">change_n_hint</span> <span class="o">+=</span> <span class="s">&quot; points on the P(r) output&quot;</span>
            <span class="n">change_n_label</span> <span class="o">=</span> <span class="s">&quot;Change number of P(r) points&quot;</span>
            <span class="n">m_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">change_n_label</span><span class="p">,</span> <span class="n">change_n_hint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_pr_npts</span><span class="p">]]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_output_unity</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_output</span><span class="p">:</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="s">&quot;Let the output P(r) keep the scale of the data&quot;</span>
                <span class="n">m_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&quot;Disable P(r) scaling&quot;</span><span class="p">,</span> <span class="n">hint</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_on_disable_scaling</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_output_unity</span><span class="p">:</span>
                <span class="n">m_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&quot;Scale P_max(r) to unity&quot;</span><span class="p">,</span>
                               <span class="s">&quot;Scale P(r) so that its maximum is 1&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_on_scale_unity</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_output</span><span class="p">:</span>
                <span class="n">m_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&quot;Normalize P(r) to unity&quot;</span><span class="p">,</span>
                               <span class="s">&quot;Normalize the integral of P(r) to 1&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_on_normalize</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">m_list</span>

        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">PR_LOADED_LABEL</span><span class="p">,</span> <span class="n">IQ_DATA_LABEL</span><span class="p">,</span> <span class="n">IQ_FIT_LABEL</span><span class="p">,</span> <span class="n">IQ_SMEARED_LABEL</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">graph</span><span class="o">.</span><span class="n">selected_plottable</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Data1D</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[[</span><span class="s">&quot;Compute P(r)&quot;</span><span class="p">,</span>
                         <span class="s">&quot;Compute P(r) from distribution&quot;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_on_context_inversion</span><span class="p">]]</span>
        <span class="k">return</span> <span class="p">[]</span>
</div>
    <span class="k">def</span> <span class="nf">_on_disable_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disable P(r) scaling</span>

<span class="sd">        :param evt: Menu event</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_output</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_output_unity</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_pr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cov</span><span class="p">)</span>

        <span class="c"># Now replot the original added data</span>
        <span class="k">for</span> <span class="n">plot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_Iq</span><span class="p">[</span><span class="n">plot</span><span class="p">])</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                         <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">],</span>
                                      <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                      <span class="n">update</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

        <span class="c"># Need the update flag in the NewPlotEvent to protect against</span>
        <span class="c"># the plot no longer being there...</span>

    <span class="k">def</span> <span class="nf">_on_normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize the area under the P(r) curve to 1.</span>
<span class="sd">        This operation is done for all displayed plots.</span>

<span class="sd">        :param evt: Menu event</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_output</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_output_unity</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show_pr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_pr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cov</span><span class="p">)</span>

        <span class="c"># Now scale the added plots too</span>
        <span class="k">for</span> <span class="n">plot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">npts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">npts</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">total</span>

            <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">GUIFRAME_ID</span><span class="o">.</span><span class="n">CURVE_SYMBOL_NUM</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">group_id</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">title</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{r}&quot;</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">)</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{P(r)} &quot;</span><span class="p">,</span> <span class="s">&quot;cm^{-3}&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_theory</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">new_plot</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                         <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                      <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_on_scale_unity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scale the maximum P(r) value on each displayed plot to 1.</span>

<span class="sd">        :param evt: Menu event</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_output_unity</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_output</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show_pr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_pr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cov</span><span class="p">)</span>

        <span class="c"># Now scale the added plots too</span>
        <span class="k">for</span> <span class="n">plot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">:</span>
            <span class="n">_max</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">_max</span><span class="p">:</span>
                    <span class="n">_max</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">_max</span>

            <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">GUIFRAME_ID</span><span class="o">.</span><span class="n">CURVE_SYMBOL_NUM</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{r}&quot;</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">)</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{P(r)} &quot;</span><span class="p">,</span> <span class="s">&quot;cm^{-3}&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_theory</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">new_plot</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                         <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                      <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_added_plots</span><span class="p">[</span><span class="n">plot</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

<div class="viewcode-block" id="Plugin.start_thread"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.start_thread">[docs]</a>    <span class="k">def</span> <span class="nf">start_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Start a calculation thread</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pr_thread</span> <span class="kn">import</span> <span class="n">CalcPr</span>

        <span class="c"># If a thread is already started, stop it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_thread</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_thread</span><span class="o">.</span><span class="n">isrunning</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_thread</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="c">## stop just raises the flag -- the thread is supposed to</span>
            <span class="c">## then kill itself. In August 2014 it was shown that this is</span>
            <span class="c">## incorrectly handled by fitting.py and a fix implemented.</span>
            <span class="c">## It is not clear whether it is properly used here, but the</span>
            <span class="c">## &quot;fix&quot; of waiting for the previous thread to end breaks the</span>
            <span class="c">## pr perspective completely as it causes an infinite loop.</span>
            <span class="c">## Thus it is likely the threading is bing properly handled.</span>
            <span class="c">## While the &quot;fix&quot; is no longer implemented the comment is</span>
            <span class="c">## left here till somebody ascertains that in fact the threads</span>
            <span class="c">## are being properly handled.</span>
            <span class="c">##</span>
            <span class="c">##    -PDB January 25, 2015</span>

        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_thread</span> <span class="o">=</span> <span class="n">CalcPr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfunc</span><span class="p">,</span>
                                  <span class="n">error_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_error</span><span class="p">,</span>
                                  <span class="n">completefn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed</span><span class="p">,</span> <span class="n">updatefn</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_thread</span><span class="o">.</span><span class="n">queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_thread</span><span class="o">.</span><span class="n">ready</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_thread_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Call-back method for calculation errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">error</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_estimate_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameter estimation completed,</span>
<span class="sd">        display the results to the user</span>

<span class="sd">        :param alpha: estimated best alpha</span>
<span class="sd">        :param elapsed: computation time</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Save useful info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">=</span> <span class="n">elapsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">alpha_estimate</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perform_estimateNT</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_estimateNT_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nterms</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameter estimation completed,</span>
<span class="sd">        display the results to the user</span>

<span class="sd">        :param alpha: estimated best alpha</span>
<span class="sd">        :param nterms: estimated number of terms</span>
<span class="sd">        :param elapsed: computation time</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Save useful info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">=</span> <span class="n">elapsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">nterms_estimate</span> <span class="o">=</span> <span class="n">nterms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">alpha_estimate</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        wxCallAfter Method called with the results when the inversion</span>
<span class="sd">        is done</span>

<span class="sd">        :param out: output coefficient for the base functions</span>
<span class="sd">        :param cov: covariance matrix</span>
<span class="sd">        :param pr: Invertor instance</span>
<span class="sd">        :param elapsed: time spent computing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Ensure hat you have all inputs are ready at the time call happens:</span>
        <span class="c"># Without CallAfter, it will freeze with wx &gt;= 2.9.</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_call</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_completed_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called with the results when the inversion</span>
<span class="sd">        is done</span>

<span class="sd">        :param out: output coefficient for the base functions</span>
<span class="sd">        :param cov: covariance matrix</span>
<span class="sd">        :param pr: Invertor instance</span>
<span class="sd">        :param elapsed: time spent computing</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Save useful info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">=</span> <span class="n">elapsed</span>
        <span class="c"># Keep a copy of the last result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_pr</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_out</span> <span class="o">=</span> <span class="n">out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_cov</span> <span class="o">=</span> <span class="n">cov</span>

        <span class="c"># Save Pr invertor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">pr</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>

        <span class="c"># Show result on control panel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">chi2</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">chi2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">=</span> <span class="n">elapsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">oscillation</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">oscillations</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">get_positive</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">pos_err</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">get_pos_err</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">cov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">rg</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">rg</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">iq0</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">iq0</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">bck</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">background</span>

        <span class="c"># Show I(q) fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_iq</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">)</span>

        <span class="c"># Show P(r) fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_pr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">,</span> <span class="n">cov</span><span class="p">)</span>

<div class="viewcode-block" id="Plugin.show_data"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.show_data">[docs]</a>    <span class="k">def</span> <span class="nf">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show data read from a file</span>

<span class="sd">        :param path: file path</span>
<span class="sd">        :param reset: if True all other plottables will be cleared</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#if path is not None:</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_file_pr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;Problem reading data: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">status</span>

            <span class="c"># If the file contains nothing, just return</span>
            <span class="k">if</span> <span class="n">pr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="s">&quot;Loaded data is invalid&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">pr</span>

        <span class="c"># Make a plot of I(q) data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">err</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">new_plot</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">GUIFRAME_ID</span><span class="o">.</span><span class="n">CURVE_SYMBOL_NUM</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_plot</span> <span class="o">=</span> <span class="n">Data1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">IQ_DATA_LABEL</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{Q}&quot;</span><span class="p">,</span> <span class="s">&#39;A^{-1}&#39;</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">yaxis</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">rm{Intensity} &quot;</span><span class="p">,</span> <span class="s">&quot;cm^{-1}&quot;</span><span class="p">)</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">group_id</span> <span class="o">=</span> <span class="n">GROUP_ID_IQ_DATA</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span>
        <span class="n">new_plot</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;I(q)&quot;</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                     <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">new_plot</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;I(q)&quot;</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">reset</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span> <span class="o">=</span> <span class="n">new_plot</span>
        <span class="c"># Get Q range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">q_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">q_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Plugin.save_data"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.save_data">[docs]</a>    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">prstate</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save data in provided state object.</span>

<span class="sd">        :TODO: move the state code away from inversion_panel and move it here.</span>
<span class="sd">                Then remove the &quot;prstate&quot; input and make this method private.</span>

<span class="sd">        :param filepath: path of file to write to</span>
<span class="sd">        :param prstate: P(r) inversion state</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#TODO: do we need this or can we use DataLoader.loader.save directly?</span>

        <span class="c"># Add output data and coefficients to state</span>
        <span class="n">prstate</span><span class="o">.</span><span class="n">coefficients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_out</span>
        <span class="n">prstate</span><span class="o">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cov</span>

        <span class="c"># Write the output to file</span>
        <span class="c"># First, check that the data is of the right type</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span>
                      <span class="n">sas</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">Data1D</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="p">,</span> <span class="n">prstate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;pr.save_data: the data being saved is not a&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot; sas.data_info.Data1D object&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">msg</span>
</div>
<div class="viewcode-block" id="Plugin.setup_plot_inversion"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.setup_plot_inversion">[docs]</a>    <span class="k">def</span> <span class="nf">setup_plot_inversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">nfunc</span><span class="p">,</span> <span class="n">d_max</span><span class="p">,</span> <span class="n">q_min</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">q_max</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                             <span class="n">bck</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Set up inversion from plotted data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfunc</span> <span class="o">=</span> <span class="n">nfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">d_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_min</span> <span class="o">=</span> <span class="n">q_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_max</span> <span class="o">=</span> <span class="n">q_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_bck</span> <span class="o">=</span> <span class="n">bck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_height</span> <span class="o">=</span> <span class="n">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_width</span> <span class="o">=</span> <span class="n">width</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_plot_pr</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pr</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">pr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">perform_inversion</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Plugin.estimate_plot_inversion"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.estimate_plot_inversion">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_plot_inversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">nfunc</span><span class="p">,</span> <span class="n">d_max</span><span class="p">,</span>
                                <span class="n">q_min</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">q_max</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                <span class="n">bck</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Estimate parameters from plotted data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfunc</span> <span class="o">=</span> <span class="n">nfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">d_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_min</span> <span class="o">=</span> <span class="n">q_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_max</span> <span class="o">=</span> <span class="n">q_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_bck</span> <span class="o">=</span> <span class="n">bck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_height</span> <span class="o">=</span> <span class="n">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_width</span> <span class="o">=</span> <span class="n">width</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_plot_pr</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pr</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">pr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">perform_estimate</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_create_plot_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimate</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and prepare invertor instance from</span>
<span class="sd">        a plottable data set.</span>

<span class="sd">        :param path: path of the file to read in</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Sanity check</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Please load a valid data set before proceeding.&quot;</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># Get the data from the chosen data set and perform inversion</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">Invertor</span><span class="p">()</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">d_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">q_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_min</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">q_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_max</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="o">.</span><span class="n">x</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="o">.</span><span class="n">y</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">has_bck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_bck</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">slit_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slit_height</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">slit_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slit_width</span>

        <span class="c"># Keep track of the plot window title to ensure that</span>
        <span class="c"># we can overlay the plots</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s">&quot;plot_group_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="o">.</span><span class="n">group_id</span>

        <span class="c"># Fill in errors if none were provided</span>
        <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="o">.</span><span class="n">dy</span>
        <span class="n">all_zeros</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">err</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">all_zeros</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">all_zeros</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">min_err</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">y</span><span class="p">)):</span>
                <span class="c"># Scale the error so that we can fit over several decades of Q</span>
                <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">min_err</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">pr</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span> <span class="n">min_err</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;The loaded file had no error bars, &quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s">&quot;statistical errors are assumed.&quot;</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">message</span><span class="p">))</span>

        <span class="n">pr</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span>

        <span class="k">return</span> <span class="n">pr</span>

<div class="viewcode-block" id="Plugin.setup_file_inversion"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.setup_file_inversion">[docs]</a>    <span class="k">def</span> <span class="nf">setup_file_inversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">nfunc</span><span class="p">,</span> <span class="n">d_max</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                             <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">q_min</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">q_max</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                             <span class="n">bck</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Set up inversion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfunc</span> <span class="o">=</span> <span class="n">nfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">d_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_min</span> <span class="o">=</span> <span class="n">q_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_max</span> <span class="o">=</span> <span class="n">q_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_bck</span> <span class="o">=</span> <span class="n">bck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_height</span> <span class="o">=</span> <span class="n">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_width</span> <span class="o">=</span> <span class="n">width</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_file_pr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pr</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">pr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">perform_inversion</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Plugin.estimate_file_inversion"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.estimate_file_inversion">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_file_inversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">nfunc</span><span class="p">,</span> <span class="n">d_max</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                                <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">q_min</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">q_max</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                <span class="n">bck</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Estimate parameters for inversion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfunc</span> <span class="o">=</span> <span class="n">nfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">d_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_min</span> <span class="o">=</span> <span class="n">q_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_max</span> <span class="o">=</span> <span class="n">q_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_bck</span> <span class="o">=</span> <span class="n">bck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_height</span> <span class="o">=</span> <span class="n">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_width</span> <span class="o">=</span> <span class="n">width</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_file_pr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">pr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">perform_estimate</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_create_file_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and prepare invertor instance from</span>
<span class="sd">        a file data set.</span>

<span class="sd">        :param path: path of the file to read in</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Reset the status bar so that we don&#39;t get mixed up</span>
        <span class="c"># with old messages.</span>
        <span class="c">#TODO: refactor this into a proper status handling</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">class</span> <span class="nc">FileData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">err</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_current_file_data</span> <span class="o">=</span> <span class="n">FileData</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_file_data</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">x</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_file_data</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_file_data</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dy</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dy</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">load_error</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># If the file contains no data, just return</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">load_error</span><span class="p">(</span><span class="s">&quot;The loaded file contains no data&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># If we have not errors, add statistical errors</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">min_err</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
                    <span class="c"># Scale the error so that we can fit over several decades of Q</span>
                    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">min_err</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span> <span class="n">min_err</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;The loaded file had no error bars, &quot;</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s">&quot;statistical errors are assumed.&quot;</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">message</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Get the data from the chosen data set and perform inversion</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">Invertor</span><span class="p">()</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">d_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">q_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_min</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">q_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_max</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">has_bck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_bck</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">slit_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slit_height</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">slit_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slit_width</span>
            <span class="k">return</span> <span class="n">pr</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">load_error</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

<div class="viewcode-block" id="Plugin.perform_estimate"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.perform_estimate">[docs]</a>    <span class="k">def</span> <span class="nf">perform_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Perform parameter estimation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pr_thread</span> <span class="kn">import</span> <span class="n">EstimatePr</span>

        <span class="c"># If a thread is already started, stop it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span><span class="o">.</span><span class="n">isrunning</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="c">## stop just raises the flag -- the thread is supposed to</span>
            <span class="c">## then kill itself. In August 2014 it was shown that this is</span>
            <span class="c">## incorrectly handled by fitting.py and a fix implemented.</span>
            <span class="c">## It is not clear whether it is properly used here, but the</span>
            <span class="c">## &quot;fix&quot; of waiting for the previous thread to end breaks the</span>
            <span class="c">## pr perspective completely as it causes an infinite loop.</span>
            <span class="c">## Thus it is likely the threading is bing properly handled.</span>
            <span class="c">## While the &quot;fix&quot; is no longer implemented the comment is</span>
            <span class="c">## left here till somebody ascertains that in fact the threads</span>
            <span class="c">## are being properly handled.</span>
            <span class="c">##</span>
            <span class="c">##    -PDB January 25, 2015</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span> <span class="o">=</span> <span class="n">EstimatePr</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfunc</span><span class="p">,</span>
                                            <span class="n">error_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_error</span><span class="p">,</span>
                                            <span class="n">completefn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate_completed</span><span class="p">,</span>
                                            <span class="n">updatefn</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span><span class="o">.</span><span class="n">queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span><span class="o">.</span><span class="n">ready</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Plugin.perform_estimateNT"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.perform_estimateNT">[docs]</a>    <span class="k">def</span> <span class="nf">perform_estimateNT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Perform parameter estimation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pr_thread</span> <span class="kn">import</span> <span class="n">EstimateNT</span>

        <span class="c"># If a thread is already started, stop it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span><span class="o">.</span><span class="n">isrunning</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="c">## stop just raises the flag -- the thread is supposed to</span>
            <span class="c">## then kill itself. In August 2014 it was shown that this is</span>
            <span class="c">## incorrectly handled by fitting.py and a fix implemented.</span>
            <span class="c">## It is not clear whether it is properly used here, but the</span>
            <span class="c">## &quot;fix&quot; of waiting for the previous thread to end breaks the</span>
            <span class="c">## pr perspective completely as it causes an infinite loop.</span>
            <span class="c">## Thus it is likely the threading is bing properly handled.</span>
            <span class="c">## While the &quot;fix&quot; is no longer implemented the comment is</span>
            <span class="c">## left here till somebody ascertains that in fact the threads</span>
            <span class="c">## are being properly handled.</span>
            <span class="c">##</span>
            <span class="c">##    -PDB January 25, 2015</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="c"># Skip the slit settings for the estimation</span>
        <span class="c"># It slows down the application and it doesn&#39;t change the estimates</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">slit_height</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">slit_width</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span> <span class="o">=</span> <span class="n">EstimateNT</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfunc</span><span class="p">,</span>
                                            <span class="n">error_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_error</span><span class="p">,</span>
                                            <span class="n">completefn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimateNT_completed</span><span class="p">,</span>
                                            <span class="n">updatefn</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span><span class="o">.</span><span class="n">queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_thread</span><span class="o">.</span><span class="n">ready</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Plugin.perform_inversion"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.perform_inversion">[docs]</a>    <span class="k">def</span> <span class="nf">perform_inversion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Perform inversion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_thread</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_on_context_inversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Call-back method for plot context menu</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">panel</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
        <span class="n">Plugin</span><span class="o">.</span><span class="n">on_perspective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>

        <span class="c"># If we have more than one displayed plot, make the user choose</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel</span><span class="o">.</span><span class="n">plots</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> \
            <span class="n">panel</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">selected_plottable</span> <span class="ow">in</span> <span class="n">panel</span><span class="o">.</span><span class="n">plots</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">panel</span><span class="o">.</span><span class="n">plots</span><span class="p">[</span><span class="n">panel</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">selected_plottable</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Prview Error: No data is available&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># Store a reference to the current plottable</span>
        <span class="c"># If we have a suggested value, use it.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">alpha_estimate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">estimate</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Prview :Alpha Not estimate yet&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">nterms_estimate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">nfunc</span> <span class="o">=</span> <span class="n">estimate</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">nfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfunc</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Prview : ntemrs Not estimate yet&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span> <span class="o">=</span> <span class="n">panel</span><span class="o">.</span><span class="n">plots</span><span class="p">[</span><span class="n">panel</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">selected_plottable</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">current_plottable</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">plotname</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="c">#self.control_panel.nfunc = self.nfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">d_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span>
        <span class="c">#self.parent.set_perspective(self.perspective)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">_on_invert</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

<div class="viewcode-block" id="Plugin.get_panels"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.get_panels">[docs]</a>    <span class="k">def</span> <span class="nf">get_panels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create and return a list of panel objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">inversion_panel</span> <span class="kn">import</span> <span class="n">InversionControl</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">MDIFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;None&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span> <span class="o">=</span> <span class="n">InversionControl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                              <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">RAISED_BORDER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">set_panel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_set_helper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">nfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">d_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perspective</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perspective</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">window_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Plugin.set_data"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.set_data">[docs]</a>    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        receive a list of data to compute pr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_1d_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">data_2d_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="c"># separate data into data1d and data2d list</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Data1D</span><span class="p">):</span>
                            <span class="n">data_1d_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s"> type </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                                             <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
                            <span class="n">data_2d_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_2d_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;PrView does not support the following data types:</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="n">error_msg</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_1d_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;Prview does not allow multiple data!</span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;Please select one.</span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">pr_widgets</span> <span class="kn">import</span> <span class="n">DataDialog</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">DataDialog</span><span class="p">(</span><span class="n">data_list</span><span class="o">=</span><span class="n">data_1d_list</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;PrView receives no data. </span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">Data1D</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                                 <span class="n">NewPlotEvent</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;remove&#39;</span><span class="p">,</span>
                                              <span class="n">group_id</span><span class="o">=</span><span class="n">GROUP_ID_IQ_DATA</span><span class="p">,</span>
                                              <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">id</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">control_panel</span><span class="o">.</span><span class="n">_change_file</span><span class="p">(</span><span class="n">evt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Prview Set_data: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span><span class="p">)</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s">&quot;error&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Pr cannot be computed for data of &quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;type </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Pr contain no data&quot;</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">StatusEvent</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s">&#39;warning&#39;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Plugin.post_init"><a class="viewcode-back" href="../../../../dev/api/sas.perspectives.pr.html#sas.perspectives.pr.pr.Plugin.post_init">[docs]</a>    <span class="k">def</span> <span class="nf">post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Post initialization call back to close the loose ends</span>
<span class="sd">            [Somehow openGL needs this call]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">SasView 3.1.2 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, The SasView Project.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>