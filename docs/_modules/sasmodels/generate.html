<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sasmodels.generate &mdash; SasView 4.2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '4.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="top" title="SasView 4.2.0 documentation" href="../../index.html" />
    <link rel="up" title="sasmodels" href="../sasmodels.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SasView 4.2.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../sasmodels.html" accesskey="U">sasmodels</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sasmodels.generate</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SAS model constructor.</span>

<span class="sd">Small angle scattering models are defined by a set of kernel functions:</span>

<span class="sd">    *Iq(q, p1, p2, ...)* returns the scattering at q for a form with</span>
<span class="sd">    particular dimensions averaged over all orientations.</span>

<span class="sd">    *Iqac(qab, qc, p1, p2, ...)* returns the scattering at qab, qc</span>
<span class="sd">    for a rotationally symmetric form with particular dimensions.</span>
<span class="sd">    qab, qc are determined from shape orientation and scattering angles.</span>
<span class="sd">    This call is used if the shape has orientation parameters theta and phi.</span>

<span class="sd">    *Iqabc(qa, qb, qc, p1, p2, ...)* returns the scattering at qa, qb, qc</span>
<span class="sd">    for a form with particular dimensions.  qa, qb, qc are determined from</span>
<span class="sd">    shape orientation and scattering angles. This call is used if the shape</span>
<span class="sd">    has orientation parameters theta, phi and psi.</span>

<span class="sd">    *Iqxy(qx, qy, p1, p2, ...)* returns the scattering at qx, qy.  Use this</span>
<span class="sd">    to create an arbitrary 2D theory function, needed for q-dependent</span>
<span class="sd">    background functions and for models with non-uniform magnetism.</span>

<span class="sd">    *form_volume(p1, p2, ...)* returns the volume of the form with particular</span>
<span class="sd">    dimension, or 1.0 if no volume normalization is required.</span>

<span class="sd">    *ER(p1, p2, ...)* returns the effective radius of the form with</span>
<span class="sd">    particular dimensions.</span>

<span class="sd">    *VR(p1, p2, ...)* returns the volume ratio for core-shell style forms.</span>

<span class="sd">    #define INVALID(v) (expr)  returns False if v.parameter is invalid</span>
<span class="sd">    for some parameter or other (e.g., v.bell_radius &lt; v.radius).  If</span>
<span class="sd">    necessary, the expression can call a function.</span>

<span class="sd">These functions are defined in a kernel module .py script and an associated</span>
<span class="sd">set of .c files.  The model constructor will use them to create models with</span>
<span class="sd">polydispersity across volume and orientation parameters, and provide</span>
<span class="sd">scale and background parameters for each model.</span>

<span class="sd">C code should be stylized C-99 functions written for OpenCL. All functions</span>
<span class="sd">need prototype declarations even if the are defined before they are used.</span>
<span class="sd">Although OpenCL supports *#include* preprocessor directives, the list of</span>
<span class="sd">includes should be given as part of the metadata in the kernel module</span>
<span class="sd">definition. The included files should be listed using a path relative to the</span>
<span class="sd">kernel module, or if using &quot;lib/file.c&quot; if it is one of the standard includes</span>
<span class="sd">provided with the sasmodels source. The includes need to be listed in order</span>
<span class="sd">so that functions are defined before they are used.</span>

<span class="sd">Floating point values should be declared as *double*.  For single precision</span>
<span class="sd">calculations, *double* will be replaced by *float*.  The single precision</span>
<span class="sd">conversion will also tag floating point constants with &quot;f&quot; to make them</span>
<span class="sd">single precision constants.  When using integral values in floating point</span>
<span class="sd">expressions, they should be expressed as floating point values by including</span>
<span class="sd">a decimal point.  This includes 0., 1. and 2.</span>

<span class="sd">OpenCL has a *sincos* function which can improve performance when both</span>
<span class="sd">the *sin* and *cos* values are needed for a particular argument.  Since</span>
<span class="sd">this function does not exist in C99, all use of *sincos* should be</span>
<span class="sd">replaced by the macro *SINCOS(value, sn, cn)* where *sn* and *cn* are</span>
<span class="sd">previously declared *double* variables.  When compiled for systems without</span>
<span class="sd">OpenCL, *SINCOS* will be replaced by *sin* and *cos* calls.   If *value* is</span>
<span class="sd">an expression, it will appear twice in this case; whether or not it will be</span>
<span class="sd">evaluated twice depends on the quality of the compiler.</span>

<span class="sd">If the input parameters are invalid, the scattering calculator should</span>
<span class="sd">return a negative number. Particularly with polydispersity, there are</span>
<span class="sd">some sets of shape parameters which lead to nonsensical forms, such</span>
<span class="sd">as a capped cylinder where the cap radius is smaller than the</span>
<span class="sd">cylinder radius.  The polydispersity calculation will ignore these points,</span>
<span class="sd">effectively chopping the parameter weight distributions at the boundary</span>
<span class="sd">of the infeasible region.  The resulting scattering will be set to</span>
<span class="sd">background.  This will work correctly even when polydispersity is off.</span>

<span class="sd">*ER* and *VR* are python functions which operate on parameter vectors.</span>
<span class="sd">The constructor code will generate the necessary vectors for computing</span>
<span class="sd">them with the desired polydispersity.</span>
<span class="sd">The kernel module must set variables defining the kernel meta data:</span>

<span class="sd">    *id* is an implicit variable formed from the filename.  It will be</span>
<span class="sd">    a valid python identifier, and will be used as the reference into</span>
<span class="sd">    the html documentation, with &#39;_&#39; replaced by &#39;-&#39;.</span>

<span class="sd">    *name* is the model name as displayed to the user.  If it is missing,</span>
<span class="sd">    it will be constructed from the id.</span>

<span class="sd">    *title* is a short description of the model, suitable for a tool tip,</span>
<span class="sd">    or a one line model summary in a table of models.</span>

<span class="sd">    *description* is an extended description of the model to be displayed</span>
<span class="sd">    while the model parameters are being edited.</span>

<span class="sd">    *parameters* is the list of parameters.  Parameters in the kernel</span>
<span class="sd">    functions must appear in the same order as they appear in the</span>
<span class="sd">    parameters list.  Two additional parameters, *scale* and *background*</span>
<span class="sd">    are added to the beginning of the parameter list.  They will show up</span>
<span class="sd">    in the documentation as model parameters, but they are never sent to</span>
<span class="sd">    the kernel functions.  Note that *effect_radius* and *volfraction*</span>
<span class="sd">    must occur first in structure factor calculations.</span>

<span class="sd">    *category* is the default category for the model.  The category is</span>
<span class="sd">    two level structure, with the form &quot;group:section&quot;, indicating where</span>
<span class="sd">    in the manual the model will be located.  Models are alphabetical</span>
<span class="sd">    within their section.</span>

<span class="sd">    *source* is the list of C-99 source files that must be joined to</span>
<span class="sd">    create the OpenCL kernel functions.  The files defining the functions</span>
<span class="sd">    need to be listed before the files which use the functions.</span>

<span class="sd">    *ER* is a python function defining the effective radius.  If it is</span>
<span class="sd">    not present, the effective radius is 0.</span>

<span class="sd">    *VR* is a python function defining the volume ratio.  If it is not</span>
<span class="sd">    present, the volume ratio is 1.</span>

<span class="sd">    *form_volume*, *Iq*, *Iqac*, *Iqabc* are strings containing</span>
<span class="sd">    the C source code for the body of the volume, Iq, and Iqac functions</span>
<span class="sd">    respectively.  These can also be defined in the last source file.</span>

<span class="sd">    *Iq*, *Iqac*, *Iqabc* also be instead be python functions defining the</span>
<span class="sd">    kernel.  If they are marked as *Iq.vectorized = True* then the</span>
<span class="sd">    kernel is passed the entire *q* vector at once, otherwise it is</span>
<span class="sd">    passed values one *q* at a time.  The performance improvement of</span>
<span class="sd">    this step is significant.</span>

<span class="sd">    *demo* is a dictionary of parameter=value defining a set of</span>
<span class="sd">    parameters to use by default when *compare* is called.  Any</span>
<span class="sd">    parameter not set in *demo* gets the initial value from the</span>
<span class="sd">    parameter list.  *demo* is mostly needed to set the default</span>
<span class="sd">    polydispersity values for tests.</span>

<span class="sd">A :class:`modelinfo.ModelInfo` structure is constructed from the kernel meta</span>
<span class="sd">data and returned to the caller.</span>

<span class="sd">The doc string at the start of the kernel module will be used to</span>
<span class="sd">construct the model documentation web pages.  Embedded figures should</span>
<span class="sd">appear in the subdirectory &quot;img&quot; beside the model definition, and tagged</span>
<span class="sd">with the kernel module name to avoid collision with other models.  Some</span>
<span class="sd">file systems are case-sensitive, so only use lower case characters for</span>
<span class="sd">file names and extensions.</span>

<span class="sd">Code follows the C99 standard with the following extensions and conditions::</span>

<span class="sd">    M_PI_180 = pi/180</span>
<span class="sd">    M_4PI_3 = 4pi/3</span>
<span class="sd">    square(x) = x*x</span>
<span class="sd">    cube(x) = x*x*x</span>
<span class="sd">    sas_sinx_x(x) = sin(x)/x, with sin(0)/0 -&gt; 1</span>
<span class="sd">    all double precision constants must include the decimal point</span>
<span class="sd">    all double declarations may be converted to half, float, or long double</span>
<span class="sd">    FLOAT_SIZE is the number of bytes in the converted variables</span>

<span class="sd">:func:`load_kernel_module` loads the model definition file and</span>
<span class="sd">:func:`modelinfo.make_model_info` parses it. :func:`make_source`</span>
<span class="sd">converts C-based model definitions to C source code, including the</span>
<span class="sd">polydispersity integral.  :func:`model_sources` returns the list of</span>
<span class="sd">source files the model depends on, and :func:`timestamp` returns</span>
<span class="sd">the latest time stamp amongst the source files (so you can check if</span>
<span class="sd">the model needs to be rebuilt).</span>

<span class="sd">The function :func:`make_doc` extracts the doc string and adds the</span>
<span class="sd">parameter table to the top.  *make_figure* in *sasmodels/doc/genmodel*</span>
<span class="sd">creates the default figure for the model.  [These two sets of code</span>
<span class="sd">should mignrate into docs.py so docs can be updated in one place].</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="c1"># TODO: determine which functions are useful outside of generate</span>
<span class="c1">#__all__ = [&quot;model_info&quot;, &quot;make_doc&quot;, &quot;make_source&quot;, &quot;convert_type&quot;]</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">join</span> <span class="k">as</span> <span class="n">joinpath</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">getmtime</span><span class="p">,</span> <span class="n">sep</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">zlib</span> <span class="kn">import</span> <span class="n">crc32</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">currentframe</span><span class="p">,</span> <span class="n">getframeinfo</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>  <span class="c1"># type: ignore</span>

<span class="kn">from</span> <span class="nn">.modelinfo</span> <span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">.custom</span> <span class="kn">import</span> <span class="n">load_custom_kernel_module</span>

<span class="c1"># pylint: disable=unused-import</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Dict</span>
    <span class="kn">from</span> <span class="nn">.modelinfo</span> <span class="kn">import</span> <span class="n">ModelInfo</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="c1"># pylint: enable=unused-import</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1"># jitter projection to use in the kernel code.  See explore/jitter.py</span>
<span class="c1"># for details.  To change it from a program, set generate.PROJECTION.</span>
<span class="n">PROJECTION</span> <span class="o">=</span> <span class="mi">1</span>

<div class="viewcode-block" id="get_data_path"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.get_data_path">[docs]</a><span class="k">def</span> <span class="nf">get_data_path</span><span class="p">(</span><span class="n">external_dir</span><span class="p">,</span> <span class="n">target_file</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">target_file</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="c1"># check next to exe/zip file</span>
    <span class="n">exepath</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">exepath</span><span class="p">,</span> <span class="n">external_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">target_file</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="c1"># check in py2app Contents/Resources</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">exepath</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;Resources&#39;</span><span class="p">,</span> <span class="n">external_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">target_file</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Could not find &#39;</span><span class="o">+</span><span class="n">joinpath</span><span class="p">(</span><span class="n">external_dir</span><span class="p">,</span> <span class="n">target_file</span><span class="p">))</span></div>

<span class="n">EXTERNAL_DIR</span> <span class="o">=</span> <span class="s1">&#39;sasmodels-data&#39;</span>
<span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">get_data_path</span><span class="p">(</span><span class="n">EXTERNAL_DIR</span><span class="p">,</span> <span class="s1">&#39;kernel_iq.c&#39;</span><span class="p">)</span>
<span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">)</span>

<span class="n">F16</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float16&#39;</span><span class="p">)</span>
<span class="n">F32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">F64</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>  <span class="c1"># CRUFT: older numpy does not support float128</span>
    <span class="n">F128</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float128&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="n">F128</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># Conversion from units defined in the parameter table for each model</span>
<span class="c1"># to units displayed in the sphinx documentation.</span>
<span class="c1"># This section associates the unit with the macro to use to produce the LaTex</span>
<span class="c1"># code.  The macro itself needs to be defined in sasmodels/doc/rst_prolog.</span>
<span class="c1">#</span>
<span class="c1"># NOTE: there is an RST_PROLOG at the end of this file which is NOT</span>
<span class="c1"># used for the bundled documentation. Still as long as we are defining the macros</span>
<span class="c1"># in two places any new addition should define the macro in both places.</span>
<span class="n">RST_UNITS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Ang&quot;</span><span class="p">:</span> <span class="s2">&quot;|Ang|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1/Ang&quot;</span><span class="p">:</span> <span class="s2">&quot;|Ang^-1|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1/Ang^2&quot;</span><span class="p">:</span> <span class="s2">&quot;|Ang^-2|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ang^3&quot;</span><span class="p">:</span> <span class="s2">&quot;|Ang^3|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ang^2&quot;</span><span class="p">:</span> <span class="s2">&quot;|Ang^2|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1e15/cm^3&quot;</span><span class="p">:</span> <span class="s2">&quot;|1e15cm^3|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ang^3/mol&quot;</span><span class="p">:</span> <span class="s2">&quot;|Ang^3|/mol&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1e-6/Ang^2&quot;</span><span class="p">:</span> <span class="s2">&quot;|1e-6Ang^-2|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;degrees&quot;</span><span class="p">:</span> <span class="s2">&quot;degree&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1/cm&quot;</span><span class="p">:</span> <span class="s2">&quot;|cm^-1|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ang/cm&quot;</span><span class="p">:</span> <span class="s2">&quot;|Ang*cm^-1|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;g/cm^3&quot;</span><span class="p">:</span> <span class="s2">&quot;|g/cm^3|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mg/m^2&quot;</span><span class="p">:</span> <span class="s2">&quot;|mg/m^2|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># Headers for the parameters tables in th sphinx documentation</span>
<span class="n">PARTABLE_HEADERS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Parameter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Description&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Units&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Default value&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<span class="c1"># Minimum width for a default value (this is shorter than the column header</span>
<span class="c1"># width, so will be ignored).</span>
<span class="n">PARTABLE_VALUE_WIDTH</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Documentation header for the module, giving the model name, its short</span>
<span class="c1"># description and its parameter table.  The remainder of the doc comes</span>
<span class="c1"># from the module docstring.</span>
<span class="n">DOC_HEADER</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;.. _</span><span class="si">%(id)s</span><span class="s2">:</span>

<span class="si">%(name)s</span><span class="s2"></span>
<span class="s2">=======================================================</span>

<span class="si">%(title)s</span><span class="s2"></span>

<span class="si">%(parameters)s</span><span class="s2"></span>

<span class="si">%(returns)s</span><span class="s2"></span>

<span class="si">%(docs)s</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="set_integration_size"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.set_integration_size">[docs]</a><span class="k">def</span> <span class="nf">set_integration_size</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="c1"># type: (ModelInfo, int) -&gt; None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the model definition, replacing the gaussian integration with</span>
<span class="sd">    a gaussian integration of a different size.</span>

<span class="sd">    Note: this really ought to be a method in modelinfo, but that leads to</span>
<span class="sd">    import loops.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">source</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lib/gauss&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.gengauss</span> <span class="kn">import</span> <span class="n">gengauss</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;gauss</span><span class="si">%d</span><span class="s2">.c&quot;</span><span class="o">%</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">gengauss</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lib/gauss</span><span class="si">%d</span><span class="s2">.c&quot;</span><span class="o">%</span><span class="n">n</span> <span class="k">if</span> <span class="n">lib</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;lib/gauss&#39;</span><span class="p">)</span>
                       <span class="k">else</span> <span class="n">lib</span> <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">source</span><span class="p">]</span></div>

<div class="viewcode-block" id="format_units"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.format_units">[docs]</a><span class="k">def</span> <span class="nf">format_units</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
    <span class="c1"># type: (str) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert units into ReStructured Text format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;string&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">RST_UNITS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_partable"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.make_partable">[docs]</a><span class="k">def</span> <span class="nf">make_partable</span><span class="p">(</span><span class="n">pars</span><span class="p">):</span>
    <span class="c1"># type: (List[Parameter]) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the parameter table to include in the sphinx documentation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">column_widths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">),</span>
        <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">description</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">),</span>
        <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">format_units</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">units</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">),</span>
        <span class="n">PARTABLE_VALUE_WIDTH</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="n">column_widths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
                     <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">column_widths</span><span class="p">,</span> <span class="n">PARTABLE_HEADERS</span><span class="p">)]</span>

    <span class="n">underbar</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">column_widths</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">underbar</span><span class="p">,</span>
        <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-*s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">column_widths</span><span class="p">,</span> <span class="n">PARTABLE_HEADERS</span><span class="p">)),</span>
        <span class="n">underbar</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s2">&quot;</span><span class="si">%-*s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">column_widths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="si">%-*s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">column_widths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">description</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="si">%-*s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">column_widths</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">format_units</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">units</span><span class="p">)),</span>
            <span class="s2">&quot;</span><span class="si">%*g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">column_widths</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span><span class="p">),</span>
            <span class="p">]))</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">underbar</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_search</span><span class="p">(</span><span class="n">search_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="c1"># type: (List[str], str) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find *filename* in *search_path*.</span>

<span class="sd">    Raises ValueError if file does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">search_path</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">target</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> not found in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">search_path</span><span class="p">))</span>


<div class="viewcode-block" id="model_sources"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.model_sources">[docs]</a><span class="k">def</span> <span class="nf">model_sources</span><span class="p">(</span><span class="n">model_info</span><span class="p">):</span>
    <span class="c1"># type: (ModelInfo) -&gt; List[str]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of the sources file paths for the module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">search_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="n">MODEL_PATH</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">_search</span><span class="p">(</span><span class="n">search_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">model_info</span><span class="o">.</span><span class="n">source</span><span class="p">]</span></div>


<div class="viewcode-block" id="dll_timestamp"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.dll_timestamp">[docs]</a><span class="k">def</span> <span class="nf">dll_timestamp</span><span class="p">(</span><span class="n">model_info</span><span class="p">):</span>
    <span class="c1"># type: (ModelInfo) -&gt; int</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a timestamp for the model corresponding to the most recently</span>
<span class="sd">    changed file or dependency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: fails DRY; templates appear two places.</span>
    <span class="n">model_templates</span> <span class="o">=</span> <span class="p">[</span><span class="n">joinpath</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;kernel_header.c&#39;</span><span class="p">,</span> <span class="s1">&#39;kernel_iq.c&#39;</span><span class="p">)]</span>
    <span class="n">source_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_sources</span><span class="p">(</span><span class="n">model_info</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">model_templates</span>
                    <span class="o">+</span> <span class="p">[</span><span class="n">model_info</span><span class="o">.</span><span class="n">filename</span><span class="p">])</span>
    <span class="c1"># Note: file may not exist when it is a standard model from library.zip</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">getmtime</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">source_files</span> <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
    <span class="n">newest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="k">if</span> <span class="n">times</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">newest</span></div>

<div class="viewcode-block" id="ocl_timestamp"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.ocl_timestamp">[docs]</a><span class="k">def</span> <span class="nf">ocl_timestamp</span><span class="p">(</span><span class="n">model_info</span><span class="p">):</span>
    <span class="c1"># type: (ModelInfo) -&gt; int</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a timestamp for the model corresponding to the most recently</span>
<span class="sd">    changed file or dependency.</span>

<span class="sd">    Note that this does not look at the time stamps for the OpenCL header</span>
<span class="sd">    information since that need not trigger a recompile of the DLL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: fails DRY; templates appear two places.</span>
    <span class="n">model_templates</span> <span class="o">=</span> <span class="p">[</span><span class="n">joinpath</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;kernel_header.c&#39;</span><span class="p">,</span> <span class="s1">&#39;kernel_iq.c&#39;</span><span class="p">)]</span>
    <span class="n">source_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_sources</span><span class="p">(</span><span class="n">model_info</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">model_templates</span>
                    <span class="o">+</span> <span class="p">[</span><span class="n">model_info</span><span class="o">.</span><span class="n">filename</span><span class="p">])</span>
    <span class="c1"># Note: file may not exist when it is a standard model from library.zip</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">getmtime</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">source_files</span> <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
    <span class="n">newest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="k">if</span> <span class="n">times</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">newest</span></div>

<div class="viewcode-block" id="tag_source"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.tag_source">[docs]</a><span class="k">def</span> <span class="nf">tag_source</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="c1"># type: (str) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a unique tag for the source code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Note: need 0xffffffff&amp;val to force an unsigned 32-bit number</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c1"># bytes has no encode attribute in python 3</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%08X</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="o">&amp;</span><span class="n">crc32</span><span class="p">(</span><span class="n">source</span><span class="p">))</span></div>

<div class="viewcode-block" id="convert_type"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.convert_type">[docs]</a><span class="k">def</span> <span class="nf">convert_type</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="c1"># type: (str, np.dtype) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert code from double precision to the desired type.</span>

<span class="sd">    Floating point constants are tagged with &#39;f&#39; for single precision or &#39;L&#39;</span>
<span class="sd">    for long double precision.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">_fix_tgmath_int</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">F16</span><span class="p">:</span>
        <span class="n">fbytes</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">_convert_type</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;half&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">F32</span><span class="p">:</span>
        <span class="n">fbytes</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">_convert_type</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">F64</span><span class="p">:</span>
        <span class="n">fbytes</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="c1"># no need to convert if it is already double</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">F128</span><span class="p">:</span>
        <span class="n">fbytes</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">_convert_type</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;long double&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected dtype in source conversion: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;#define FLOAT_SIZE </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fbytes</span><span class="p">)</span><span class="o">+</span><span class="n">source</span></div>


<span class="k">def</span> <span class="nf">_convert_type</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">constant_flag</span><span class="p">):</span>
    <span class="c1"># type: (str, str, str) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace &#39;double&#39; with *type_name* in *source*, tagging floating point</span>
<span class="sd">    constants with *constant_flag*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert double keyword to float/long double/half.</span>
    <span class="c1"># Accept an &#39;n&#39; # parameter for vector # values, where n is 2, 4, 8 or 16.</span>
    <span class="c1"># Assume complex numbers are represented as cdouble which is typedef&#39;d</span>
    <span class="c1"># to double2.</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;(^|[^a-zA-Z0-9_]c?)double(([248]|16)?($|[^a-zA-Z0-9_]))&#39;</span><span class="p">,</span>
                    <span class="s1">r&#39;\1</span><span class="si">%s</span><span class="s1">\2&#39;</span><span class="o">%</span><span class="n">type_name</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">_tag_float</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constant_flag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">source</span>

<span class="n">TGMATH_INT_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;&quot;&quot;</span>
<span class="s2">(?: # Non-capturing match; not lookbehind since pattern length is variable</span>
<span class="s2">  \b              # word boundary</span>
<span class="s2">   # various math functions</span>
<span class="s2">  (a?(sin|cos|tan)h? | atan2</span>
<span class="s2">   | erfc? | tgamma</span>
<span class="s2">   | exp(2|10|m1)? | log(2|10|1p)? | pow[nr]? | sqrt | rsqrt | rootn</span>
<span class="s2">   | fabs | fmax | fmin</span>
<span class="s2">   )</span>
<span class="s2">  \s*[(]\s*       # open parenthesis</span>
<span class="s2">)</span>
<span class="s2">[+-]?(0|[1-9]\d*) # integer</span>
<span class="s2">(?=               # lookahead match: don&#39;t want to move from end of int</span>
<span class="s2">  \s*[,)]         # comma or close parenthesis for end of argument</span>
<span class="s2">)                 # end lookahead</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_fix_tgmath_int</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="c1"># type: (str) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace f(integer) with f(integer.) for sin, cos, pow, etc.</span>

<span class="sd">    OS X OpenCL complains that it can&#39;t resolve the type generic calls to</span>
<span class="sd">    the standard math functions when they are called with integer constants,</span>
<span class="sd">    but this does not happen with the Windows Intel driver for example.</span>
<span class="sd">    To avoid confusion on the matrix marketplace, automatically promote</span>
<span class="sd">    integers to floats if we recognize them in the source.</span>

<span class="sd">    The specific functions we look for are:</span>

<span class="sd">        trigonometric: sin, asin, sinh, asinh, etc., and atan2</span>
<span class="sd">        exponential:   exp, exp2, exp10, expm1, log, log2, log10, logp1</span>
<span class="sd">        power:         pow, pown, powr, sqrt, rsqrt, rootn</span>
<span class="sd">        special:       erf, erfc, tgamma</span>
<span class="sd">        float:         fabs, fmin, fmax</span>

<span class="sd">    Note that we don&#39;t convert the second argument of dual argument</span>
<span class="sd">    functions: atan2, fmax, fmin, pow, powr.  This could potentially</span>
<span class="sd">    be a problem for pow(x, 2), but that case seems to work without change.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">TGMATH_INT_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;\g&lt;0&gt;.&#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># Floating point regular expression</span>
<span class="c1">#</span>
<span class="c1"># Define parts:</span>
<span class="c1">#</span>
<span class="c1">#    E = [eE][+-]?\d+    : Exponent</span>
<span class="c1">#    P = [.]             : Decimal separator</span>
<span class="c1">#    N = [1-9]\d*        : Natural number, no leading zeros</span>
<span class="c1">#    Z = 0               : Zero</span>
<span class="c1">#    F = \d+             : Fractional number, maybe leading zeros</span>
<span class="c1">#    F? = \d*            : Optional fractional number</span>
<span class="c1">#</span>
<span class="c1"># We want to reject bare natural numbers and bare decimal points, so we</span>
<span class="c1"># need to tediously outline the cases where we have either a fraction or</span>
<span class="c1"># an exponent:</span>
<span class="c1">#</span>
<span class="c1">#   ( ZP | ZPF | ZE | ZPE | ZPFE | NP | NPF | NE | NPE | NPFE | PF | PFE )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># We can then join cases by making parts optional.  The following are</span>
<span class="c1"># some ways to do this:</span>
<span class="c1">#</span>
<span class="c1">#   ( (Z|N)(P|PF|E|PE|PFE) | PFE? )                   # Split on lead</span>
<span class="c1">#     =&gt; ( (Z|N)(PF?|(PF?)?E) | PFE? )</span>
<span class="c1">#   ( ((Z|N)PF?|PF)E? | (Z|N)E)                       # Split on point</span>
<span class="c1">#   ( (ZP|ZPF|NP|NPF|PF) | (Z|ZP|ZPF|N|NP|NPF|PF)E )  # Split on E</span>
<span class="c1">#     =&gt; ( ((Z|N)PF?|PF) | ((Z|N)(PF?)? | PF) E )</span>
<span class="n">FLOAT_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;&quot;&quot;</span>
<span class="s2">    (?&lt;!\w)  # use negative lookbehind since &#39;.&#39; confuses \b test</span>
<span class="s2">    # use split on lead to match float ( (Z|N)(PF?|(PF?)?E) | PFE? )</span>
<span class="s2">    ( ( 0 | [1-9]\d* )                     # ( ( Z | N )</span>
<span class="s2">      ([.]\d* | ([.]\d*)? [eE][+-]?\d+ )   #   (PF? | (PF?)? E )</span>
<span class="s2">    | [.]\d+ ([eE][+-]?\d+)?               # | PF (E)?</span>
<span class="s2">    )                                      # )</span>
<span class="s2">    (?!\w)  # use negative lookahead since &#39;.&#39; confuses \b test</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_tag_float</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constant_flag</span><span class="p">):</span>
    <span class="c1"># Convert floating point constants to single by adding &#39;f&#39; to the end,</span>
    <span class="c1"># or long double with an &#39;L&#39; suffix.  OS/X complains if you don&#39;t do this.</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">FLOAT_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;\g&lt;0&gt;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">constant_flag</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
    <span class="c1">#print(&quot;in&quot;,repr(source),&quot;out&quot;,repr(out), constant_flag)</span>
    <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="test_tag_float"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.test_tag_float">[docs]</a><span class="k">def</span> <span class="nf">test_tag_float</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;check that floating point constants are properly identified and tagged with &#39;f&#39;&quot;&quot;&quot;</span>

    <span class="n">cases</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">ZP  : 0.</span>
<span class="s2">ZPF : 0.0,0.01,0.1</span>
<span class="s2">Z  E: 0e+001</span>
<span class="s2">ZP E: 0.E0</span>
<span class="s2">ZPFE: 0.13e-031</span>
<span class="s2">NP  : 1., 12.</span>
<span class="s2">NPF : 1.0001, 1.1, 1.0</span>
<span class="s2">N  E: 1e0, 37E-080</span>
<span class="s2">NP E: 1.e0, 37.E-080</span>
<span class="s2">NPFE: 845.017e+22</span>
<span class="s2"> PF : .1, .0, .0100</span>
<span class="s2"> PFE: .6e+9, .82E-004</span>
<span class="s2"># isolated cases</span>
<span class="s2">0.</span>
<span class="s2">1e0</span>
<span class="s2">0.13e-013</span>
<span class="s2"># untouched</span>
<span class="s2">struct3.e3, 03.05.67, 37</span>
<span class="s2"># expressions</span>
<span class="s2">3.75+-1.6e-7-27+13.2</span>
<span class="s2">a3.e2 - 0.</span>
<span class="s2">4*atan(1)</span>
<span class="s2">4.*atan(1.)</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">ZP  : 0.f</span>
<span class="s2">ZPF : 0.0f,0.01f,0.1f</span>
<span class="s2">Z  E: 0e+001f</span>
<span class="s2">ZP E: 0.E0f</span>
<span class="s2">ZPFE: 0.13e-031f</span>
<span class="s2">NP  : 1.f, 12.f</span>
<span class="s2">NPF : 1.0001f, 1.1f, 1.0f</span>
<span class="s2">N  E: 1e0f, 37E-080f</span>
<span class="s2">NP E: 1.e0f, 37.E-080f</span>
<span class="s2">NPFE: 845.017e+22f</span>
<span class="s2"> PF : .1f, .0f, .0100f</span>
<span class="s2"> PFE: .6e+9f, .82E-004f</span>
<span class="s2"># isolated cases</span>
<span class="s2">0.f</span>
<span class="s2">1e0f</span>
<span class="s2">0.13e-013f</span>
<span class="s2"># untouched</span>
<span class="s2">struct3.e3, 03.05.67, 37</span>
<span class="s2"># expressions</span>
<span class="s2">3.75f+-1.6e-7f-27+13.2f</span>
<span class="s2">a3.e2 - 0.f</span>
<span class="s2">4*atan(1)</span>
<span class="s2">4.f*atan(1.f)</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">case_in</span><span class="p">,</span> <span class="n">case_out</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cases</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_tag_float</span><span class="p">(</span><span class="n">case_in</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">case_out</span> <span class="o">==</span> <span class="n">out</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> =&gt; </span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">case_in</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="kernel_name"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.kernel_name">[docs]</a><span class="k">def</span> <span class="nf">kernel_name</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="n">variant</span><span class="p">):</span>
    <span class="c1"># type: (ModelInfo, str) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Name of the exported kernel symbol.</span>

<span class="sd">    *variant* is &quot;Iq&quot;, &quot;Iqxy&quot; or &quot;Imagnetic&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">model_info</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">variant</span></div>


<div class="viewcode-block" id="indent"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.indent">[docs]</a><span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
    <span class="c1"># type: (str, int) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Indent a string of text with *depth* additional spaces on each line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spaces</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="n">depth</span>
    <span class="n">interline_separator</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">spaces</span>
    <span class="k">return</span> <span class="n">spaces</span> <span class="o">+</span> <span class="n">interline_separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span></div>


<span class="n">_template_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Tuple[int, str, str]]</span>
<div class="viewcode-block" id="load_template"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.load_template">[docs]</a><span class="k">def</span> <span class="nf">load_template</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># type: (str) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load template file from sasmodels resource directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">mtime</span> <span class="o">=</span> <span class="n">getmtime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_template_cache</span> <span class="ow">or</span> <span class="n">mtime</span> <span class="o">&gt;</span> <span class="n">_template_cache</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
            <span class="n">_template_cache</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mtime</span><span class="p">,</span> <span class="n">fid</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_template_cache</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">path</span></div>


<span class="n">_FN_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">double </span><span class="si">%(name)s</span><span class="s2">(</span><span class="si">%(pars)s</span><span class="s2">);</span>
<span class="s2">double </span><span class="si">%(name)s</span><span class="s2">(</span><span class="si">%(pars)s</span><span class="s2">) {</span>
<span class="s2">#line </span><span class="si">%(line)d</span><span class="s2"> &quot;</span><span class="si">%(filename)s</span><span class="s2">&quot;</span>
<span class="s2">    </span><span class="si">%(body)s</span><span class="s2"></span>
<span class="s2">}</span>

<span class="s2">&quot;&quot;&quot;</span>
<span class="k">def</span> <span class="nf">_gen_fn</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="c1"># type: (ModelInfo, str, List[Parameter]) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a function given pars and body.</span>

<span class="sd">    Returns the following string::</span>

<span class="sd">         double fn(double a, double b, ...);</span>
<span class="sd">         double fn(double a, double b, ...) {</span>
<span class="sd">             ....</span>
<span class="sd">         }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">par_decl</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">as_function_argument</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">)</span> <span class="k">if</span> <span class="n">pars</span> <span class="k">else</span> <span class="s1">&#39;void&#39;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">filename</span>
    <span class="c1"># Note: if symbol is defined strangely in the module then default it to 1</span>
    <span class="n">lineno</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">lineno</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_FN_TEMPLATE</span> <span class="o">%</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;pars&#39;</span><span class="p">:</span> <span class="n">par_decl</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span>
        <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">lineno</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_call_pars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="c1"># type: (str, List[Parameter]) -&gt; List[str]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of *prefix+parameter* from parameter items.</span>

<span class="sd">    *prefix* should be &quot;v.&quot; if v is a struct.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">as_call_reference</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">]</span>


<span class="c1"># type in IQXY pattern could be single, float, double, long double, ...</span>
<span class="n">_IQXY_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;(^|\s)double\s+I(?P&lt;mode&gt;q(ab?c|xy))\s*[(]&quot;</span><span class="p">,</span>
                           <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<div class="viewcode-block" id="find_xy_mode"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.find_xy_mode">[docs]</a><span class="k">def</span> <span class="nf">find_xy_mode</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="c1"># type: (List[str]) -&gt; bool</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the xy mode as qa, qac, qabc or qxy.</span>

<span class="sd">    Note this is not a C parser, and so can be easily confused by</span>
<span class="sd">    non-standard syntax.  Also, it will incorrectly identify the following</span>
<span class="sd">    as having 2D models::</span>

<span class="sd">        /*</span>
<span class="sd">        double Iqac(qab, qc, ...) { ... fill this in later ... }</span>
<span class="sd">        */</span>

<span class="sd">    If you want to comment out the function, use // on the front of the</span>
<span class="sd">    line::</span>

<span class="sd">        /*</span>
<span class="sd">        // double Iqac(qab, qc, ...) { ... fill this in later ... }</span>
<span class="sd">        */</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_IQXY_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;qa&#39;</span></div>


<span class="k">def</span> <span class="nf">_add_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a file to the list of source code chunks, tagged with path and line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#line </span><span class="si">%d</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

<div class="viewcode-block" id="make_source"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.make_source">[docs]</a><span class="k">def</span> <span class="nf">make_source</span><span class="p">(</span><span class="n">model_info</span><span class="p">):</span>
    <span class="c1"># type: (ModelInfo) -&gt; Dict[str, str]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the OpenCL/ctypes kernel from the module info.</span>

<span class="sd">    Uses source files found in the given search path.  Returns None if this</span>
<span class="sd">    is a pure python model, with no C source components.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">Iq</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;can&#39;t compile python model&quot;</span><span class="p">)</span>
        <span class="c1">#return None</span>

    <span class="c1"># TODO: need something other than volume to indicate dispersion parameters</span>
    <span class="c1"># No volume normalization despite having a volume parameter.</span>
    <span class="c1"># Thickness is labelled a volume in order to trigger polydispersity.</span>
    <span class="c1"># May want a separate dispersion flag, or perhaps a separate category for</span>
    <span class="c1"># disperse, but not volume.  Volume parameters also use relative values</span>
    <span class="c1"># for the distribution rather than the absolute values used by angular</span>
    <span class="c1"># dispersion.  Need to be careful that necessary parameters are available</span>
    <span class="c1"># for computing volume even if we allow non-disperse volume parameters.</span>

    <span class="n">partable</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1"># Load templates and user code</span>
    <span class="n">kernel_header</span> <span class="o">=</span> <span class="n">load_template</span><span class="p">(</span><span class="s1">&#39;kernel_header.c&#39;</span><span class="p">)</span>
    <span class="n">kernel_code</span> <span class="o">=</span> <span class="n">load_template</span><span class="p">(</span><span class="s1">&#39;kernel_iq.c&#39;</span><span class="p">)</span>
    <span class="n">user_code</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">model_sources</span><span class="p">(</span><span class="n">model_info</span><span class="p">)]</span>

    <span class="c1"># Build initial sources</span>
    <span class="n">source</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_add_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">kernel_header</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">user_code</span><span class="p">:</span>
        <span class="n">_add_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model_info</span><span class="o">.</span><span class="n">c_code</span><span class="p">:</span>
        <span class="n">_add_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">model_info</span><span class="o">.</span><span class="n">c_code</span><span class="p">,</span> <span class="n">model_info</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                    <span class="n">lineno</span><span class="o">=</span><span class="n">model_info</span><span class="o">.</span><span class="n">lineno</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c_code&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Make parameters for q, qx, qy so that we can use them in declarations</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">qab</span><span class="p">,</span> <span class="n">qa</span><span class="p">,</span> <span class="n">qb</span><span class="p">,</span> <span class="n">qc</span> \
        <span class="o">=</span> <span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="s1">&#39;q qx qy qab qa qb qc&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
    <span class="c1"># Generate form_volume function, etc. from body only</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">form_volume</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">partable</span><span class="o">.</span><span class="n">form_volume_parameters</span>
        <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_gen_fn</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="s1">&#39;form_volume&#39;</span><span class="p">,</span> <span class="n">pars</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">Iq</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">+</span> <span class="n">partable</span><span class="o">.</span><span class="n">iq_parameters</span>
        <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_gen_fn</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="s1">&#39;Iq&#39;</span><span class="p">,</span> <span class="n">pars</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">Iqxy</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">]</span> <span class="o">+</span> <span class="n">partable</span><span class="o">.</span><span class="n">iq_parameters</span> <span class="o">+</span> <span class="n">partable</span><span class="o">.</span><span class="n">orientation_parameters</span>
        <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_gen_fn</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="s1">&#39;Iqxy&#39;</span><span class="p">,</span> <span class="n">pars</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">Iqac</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">qab</span><span class="p">,</span> <span class="n">qc</span><span class="p">]</span> <span class="o">+</span> <span class="n">partable</span><span class="o">.</span><span class="n">iq_parameters</span>
        <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_gen_fn</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="s1">&#39;Iqac&#39;</span><span class="p">,</span> <span class="n">pars</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_info</span><span class="o">.</span><span class="n">Iqabc</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">qa</span><span class="p">,</span> <span class="n">qb</span><span class="p">,</span> <span class="n">qc</span><span class="p">]</span> <span class="o">+</span> <span class="n">partable</span><span class="o">.</span><span class="n">iq_parameters</span>
        <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_gen_fn</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="s1">&#39;Iqabc&#39;</span><span class="p">,</span> <span class="n">pars</span><span class="p">))</span>

    <span class="c1"># What kind of 2D model do we need?  Is it consistent with the parameters?</span>
    <span class="n">xy_mode</span> <span class="o">=</span> <span class="n">find_xy_mode</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xy_mode</span> <span class="o">==</span> <span class="s1">&#39;qabc&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">partable</span><span class="o">.</span><span class="n">is_asymmetric</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;asymmetric oriented models need to define Iqabc&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">xy_mode</span> <span class="o">==</span> <span class="s1">&#39;qac&#39;</span> <span class="ow">and</span> <span class="n">partable</span><span class="o">.</span><span class="n">is_asymmetric</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;symmetric oriented models need to define Iqac&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">partable</span><span class="o">.</span><span class="n">orientation_parameters</span> <span class="ow">and</span> <span class="n">xy_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;qac&#39;</span><span class="p">,</span> <span class="s1">&#39;qabc&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected function I</span><span class="si">%s</span><span class="s2"> for unoriented shape&quot;</span><span class="o">%</span><span class="n">xy_mode</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">partable</span><span class="o">.</span><span class="n">orientation_parameters</span> <span class="ow">and</span> <span class="n">xy_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;qac&#39;</span><span class="p">,</span> <span class="s1">&#39;qabc&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xy_mode</span> <span class="o">==</span> <span class="s1">&#39;qxy&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;oriented shapes should define Iqac or Iqabc&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected function Iqac or Iqabc for oriented shape&quot;</span><span class="p">)</span>

    <span class="c1"># Define the parameter table</span>
    <span class="n">lineno</span> <span class="o">=</span> <span class="n">getframeinfo</span><span class="p">(</span><span class="n">currentframe</span><span class="p">())</span><span class="o">.</span><span class="n">lineno</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#line </span><span class="si">%d</span><span class="s1"> &quot;sasmodels/generate.py&quot;&#39;</span><span class="o">%</span><span class="n">lineno</span><span class="p">)</span>
    <span class="c1">#source.append(&#39;introduce breakage in generate to test lineno reporting&#39;)</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#define PARAMETER_TABLE </span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">as_definition</span><span class="p">()</span>
                              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">partable</span><span class="o">.</span><span class="n">kernel_parameters</span><span class="p">))</span>

    <span class="c1"># Define the function calls</span>
    <span class="k">if</span> <span class="n">partable</span><span class="o">.</span><span class="n">form_volume_parameters</span><span class="p">:</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">_call_pars</span><span class="p">(</span><span class="s2">&quot;_v.&quot;</span><span class="p">,</span> <span class="n">partable</span><span class="o">.</span><span class="n">form_volume_parameters</span><span class="p">)</span>
        <span class="n">call_volume</span> <span class="o">=</span> <span class="s2">&quot;#define CALL_VOLUME(_v) form_volume(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">refs</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Model doesn&#39;t have volume.  We could make the kernel run a little</span>
        <span class="c1"># faster by not using/transferring the volume normalizations, but</span>
        <span class="c1"># the ifdef&#39;s reduce readability more than is worthwhile.</span>
        <span class="n">call_volume</span> <span class="o">=</span> <span class="s2">&quot;#define CALL_VOLUME(v) 1.0&quot;</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">call_volume</span><span class="p">)</span>

    <span class="n">model_refs</span> <span class="o">=</span> <span class="n">_call_pars</span><span class="p">(</span><span class="s2">&quot;_v.&quot;</span><span class="p">,</span> <span class="n">partable</span><span class="o">.</span><span class="n">iq_parameters</span><span class="p">)</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;_q&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model_refs</span><span class="p">)</span>
    <span class="n">call_iq</span> <span class="o">=</span> <span class="s2">&quot;#define CALL_IQ(_q, _v) Iq(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">pars</span>
    <span class="k">if</span> <span class="n">xy_mode</span> <span class="o">==</span> <span class="s1">&#39;qabc&#39;</span><span class="p">:</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;_qa&quot;</span><span class="p">,</span> <span class="s2">&quot;_qb&quot;</span><span class="p">,</span> <span class="s2">&quot;_qc&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model_refs</span><span class="p">)</span>
        <span class="n">call_iqxy</span> <span class="o">=</span> <span class="s2">&quot;#define CALL_IQ_ABC(_qa,_qb,_qc,_v) Iqabc(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">pars</span>
        <span class="n">clear_iqxy</span> <span class="o">=</span> <span class="s2">&quot;#undef CALL_IQ_ABC&quot;</span>
    <span class="k">elif</span> <span class="n">xy_mode</span> <span class="o">==</span> <span class="s1">&#39;qac&#39;</span><span class="p">:</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;_qa&quot;</span><span class="p">,</span> <span class="s2">&quot;_qc&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model_refs</span><span class="p">)</span>
        <span class="n">call_iqxy</span> <span class="o">=</span> <span class="s2">&quot;#define CALL_IQ_AC(_qa,_qc,_v) Iqac(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">pars</span>
        <span class="n">clear_iqxy</span> <span class="o">=</span> <span class="s2">&quot;#undef CALL_IQ_AC&quot;</span>
    <span class="k">elif</span> <span class="n">xy_mode</span> <span class="o">==</span> <span class="s1">&#39;qa&#39;</span><span class="p">:</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;_qa&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model_refs</span><span class="p">)</span>
        <span class="n">call_iqxy</span> <span class="o">=</span> <span class="s2">&quot;#define CALL_IQ_A(_qa,_v) Iq(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">pars</span>
        <span class="n">clear_iqxy</span> <span class="o">=</span> <span class="s2">&quot;#undef CALL_IQ_A&quot;</span>
    <span class="k">elif</span> <span class="n">xy_mode</span> <span class="o">==</span> <span class="s1">&#39;qxy&#39;</span><span class="p">:</span>
        <span class="n">orientation_refs</span> <span class="o">=</span> <span class="n">_call_pars</span><span class="p">(</span><span class="s2">&quot;_v.&quot;</span><span class="p">,</span> <span class="n">partable</span><span class="o">.</span><span class="n">orientation_parameters</span><span class="p">)</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;_qx&quot;</span><span class="p">,</span> <span class="s2">&quot;_qy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model_refs</span> <span class="o">+</span> <span class="n">orientation_refs</span><span class="p">)</span>
        <span class="n">call_iqxy</span> <span class="o">=</span> <span class="s2">&quot;#define CALL_IQ_XY(_qx,_qy,_v) Iqxy(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">pars</span>
        <span class="n">clear_iqxy</span> <span class="o">=</span> <span class="s2">&quot;#undef CALL_IQ_XY&quot;</span>
        <span class="k">if</span> <span class="n">partable</span><span class="o">.</span><span class="n">orientation_parameters</span><span class="p">:</span>
            <span class="n">call_iqxy</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#define HAVE_THETA&quot;</span>
            <span class="n">clear_iqxy</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#undef HAVE_THETA&quot;</span>
        <span class="k">if</span> <span class="n">partable</span><span class="o">.</span><span class="n">is_asymmetric</span><span class="p">:</span>
            <span class="n">call_iqxy</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#define HAVE_PSI&quot;</span>
            <span class="n">clear_iqxy</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#undef HAVE_PSI&quot;</span>


    <span class="n">magpars</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">partable</span><span class="o">.</span><span class="n">call_parameters</span><span class="p">)</span>
               <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;sld&#39;</span><span class="p">]</span>

    <span class="c1"># Fill in definitions for numbers of parameters</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#define MAX_PD </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">partable</span><span class="o">.</span><span class="n">max_pd</span><span class="p">)</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#define NUM_PARS </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">partable</span><span class="o">.</span><span class="n">npars</span><span class="p">)</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#define NUM_VALUES </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">partable</span><span class="o">.</span><span class="n">nvalues</span><span class="p">)</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#define NUM_MAGNETIC </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">partable</span><span class="o">.</span><span class="n">nmagnetic</span><span class="p">)</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#define MAGNETIC_PARS </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">magpars</span><span class="p">))</span>
    <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#define PROJECTION </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">PROJECTION</span><span class="p">)</span>

    <span class="c1"># TODO: allow mixed python/opencl kernels?</span>

    <span class="n">ocl</span> <span class="o">=</span> <span class="n">_kernels</span><span class="p">(</span><span class="n">kernel_code</span><span class="p">,</span> <span class="n">call_iq</span><span class="p">,</span> <span class="n">call_iqxy</span><span class="p">,</span> <span class="n">clear_iqxy</span><span class="p">,</span> <span class="n">model_info</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">dll</span> <span class="o">=</span> <span class="n">_kernels</span><span class="p">(</span><span class="n">kernel_code</span><span class="p">,</span> <span class="n">call_iq</span><span class="p">,</span> <span class="n">call_iqxy</span><span class="p">,</span> <span class="n">clear_iqxy</span><span class="p">,</span> <span class="n">model_info</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;dll&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="o">+</span><span class="n">dll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dll</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dll</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="s1">&#39;opencl&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="o">+</span><span class="n">ocl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ocl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ocl</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span></div>


<span class="k">def</span> <span class="nf">_kernels</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">call_iq</span><span class="p">,</span> <span class="n">call_iqxy</span><span class="p">,</span> <span class="n">clear_iqxy</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="c1"># type: ([str,str], str, str, str) -&gt; List[str]</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">iq</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># define the Iq kernel</span>
        <span class="s2">&quot;#define KERNEL_NAME </span><span class="si">%s</span><span class="s2">_Iq&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
        <span class="n">call_iq</span><span class="p">,</span>
        <span class="s1">&#39;#line 1 &quot;</span><span class="si">%s</span><span class="s1"> Iq&quot;&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="s2">&quot;#undef CALL_IQ&quot;</span><span class="p">,</span>
        <span class="s2">&quot;#undef KERNEL_NAME&quot;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="n">iqxy</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># define the Iqxy kernel from the same source with different #defines</span>
        <span class="s2">&quot;#define KERNEL_NAME </span><span class="si">%s</span><span class="s2">_Iqxy&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
        <span class="n">call_iqxy</span><span class="p">,</span>
        <span class="s1">&#39;#line 1 &quot;</span><span class="si">%s</span><span class="s1"> Iqxy&quot;&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">clear_iqxy</span><span class="p">,</span>
        <span class="s2">&quot;#undef KERNEL_NAME&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">imagnetic</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># define the Imagnetic kernel</span>
        <span class="s2">&quot;#define KERNEL_NAME </span><span class="si">%s</span><span class="s2">_Imagnetic&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
        <span class="s2">&quot;#define MAGNETIC 1&quot;</span><span class="p">,</span>
        <span class="n">call_iqxy</span><span class="p">,</span>
        <span class="s1">&#39;#line 1 &quot;</span><span class="si">%s</span><span class="s1"> Imagnetic&quot;&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">clear_iqxy</span><span class="p">,</span>
        <span class="s2">&quot;#undef MAGNETIC&quot;</span><span class="p">,</span>
        <span class="s2">&quot;#undef KERNEL_NAME&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">iq</span><span class="p">,</span> <span class="n">iqxy</span><span class="p">,</span> <span class="n">imagnetic</span>


<div class="viewcode-block" id="load_kernel_module"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.load_kernel_module">[docs]</a><span class="k">def</span> <span class="nf">load_kernel_module</span><span class="p">(</span><span class="n">model_name</span><span class="p">):</span>
    <span class="c1"># type: (str) -&gt; module</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the kernel module named in *model_name*.</span>

<span class="sd">    If the name ends in *.py* then load it as a custom model using</span>
<span class="sd">    :func:`sasmodels.custom.load_custom_kernel_module`, otherwise</span>
<span class="sd">    load it from :mod:`sasmodels.models`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">):</span>
        <span class="n">kernel_module</span> <span class="o">=</span> <span class="n">load_custom_kernel_module</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">sasmodels</span> <span class="kn">import</span> <span class="n">models</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;sasmodels.models.&#39;</span><span class="o">+</span><span class="n">model_name</span><span class="p">)</span>
            <span class="n">kernel_module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="c1"># If the model isn&#39;t a built in model, try the plugin directory</span>
            <span class="n">plugin_path</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SAS_MODELPATH&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plugin_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="n">plugin_path</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;.py&quot;</span>
                <span class="n">kernel_module</span> <span class="o">=</span> <span class="n">load_custom_kernel_module</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
    <span class="k">return</span> <span class="n">kernel_module</span></div>


<span class="n">section_marker</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;\A(?P&lt;first&gt;[</span><span class="si">%s</span><span class="s1">])(?P=first)*\Z&#39;</span>
                            <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">_convert_section_titles_to_boldface</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="c1"># type: (Sequence[str]) -&gt; Iterator[str]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do the actual work of identifying and converting section headings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prior</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prior</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">line</span>
        <span class="k">elif</span> <span class="n">section_marker</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior</span><span class="p">):</span>
                <span class="k">yield</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="n">prior</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">))</span>
                <span class="n">prior</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">prior</span>
                <span class="n">prior</span> <span class="o">=</span> <span class="n">line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">prior</span>
            <span class="n">prior</span> <span class="o">=</span> <span class="n">line</span>
    <span class="k">if</span> <span class="n">prior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">prior</span>


<div class="viewcode-block" id="convert_section_titles_to_boldface"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.convert_section_titles_to_boldface">[docs]</a><span class="k">def</span> <span class="nf">convert_section_titles_to_boldface</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="c1"># type: (str) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use explicit bold-face rather than section headings so that the table of</span>
<span class="sd">    contents is not polluted with section names from the model documentation.</span>

<span class="sd">    Sections are identified as the title line followed by a line of punctuation</span>
<span class="sd">    at least as long as the title line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_convert_section_titles_to_boldface</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)))</span></div>


<div class="viewcode-block" id="make_doc"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.make_doc">[docs]</a><span class="k">def</span> <span class="nf">make_doc</span><span class="p">(</span><span class="n">model_info</span><span class="p">):</span>
    <span class="c1"># type: (ModelInfo) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the documentation for the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Iq_units</span> <span class="o">=</span> <span class="s2">&quot;The returned value is scaled to units of |cm^-1| |sr^-1|, absolute scale.&quot;</span>
    <span class="n">Sq_units</span> <span class="o">=</span> <span class="s2">&quot;The returned value is a dimensionless structure factor, $S(q)$.&quot;</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">docs</span> <span class="k">if</span> <span class="n">model_info</span><span class="o">.</span><span class="n">docs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="n">convert_section_titles_to_boldface</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model_info</span><span class="o">.</span><span class="n">structure_factor</span><span class="p">:</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">kernel_parameters</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">COMMON</span> <span class="o">+</span> <span class="n">model_info</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">kernel_parameters</span>
    <span class="n">partable</span> <span class="o">=</span> <span class="n">make_partable</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
    <span class="n">subst</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">model_info</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span>
                 <span class="n">name</span><span class="o">=</span><span class="n">model_info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="n">model_info</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                 <span class="n">parameters</span><span class="o">=</span><span class="n">partable</span><span class="p">,</span>
                 <span class="n">returns</span><span class="o">=</span><span class="n">Sq_units</span> <span class="k">if</span> <span class="n">model_info</span><span class="o">.</span><span class="n">structure_factor</span> <span class="k">else</span> <span class="n">Iq_units</span><span class="p">,</span>
                 <span class="n">docs</span><span class="o">=</span><span class="n">docs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DOC_HEADER</span> <span class="o">%</span> <span class="n">subst</span></div>


<span class="c1"># TODO: need a single source for rst_prolog; it is also in doc/rst_prolog</span>
<span class="n">RST_PROLOG</span> <span class="o">=</span> <span class="s2">r&quot;&quot;&quot;\</span>
<span class="s2">.. |Ang| unicode:: U+212B</span>
<span class="s2">.. |Ang^-1| replace:: |Ang|\ :sup:`-1`</span>
<span class="s2">.. |Ang^2| replace:: |Ang|\ :sup:`2`</span>
<span class="s2">.. |Ang^-2| replace:: |Ang|\ :sup:`-2`</span>
<span class="s2">.. |1e-6Ang^-2| replace:: 10\ :sup:`-6`\ |Ang|\ :sup:`-2`</span>
<span class="s2">.. |Ang^3| replace:: |Ang|\ :sup:`3`</span>
<span class="s2">.. |Ang^-3| replace:: |Ang|\ :sup:`-3`</span>
<span class="s2">.. |Ang^-4| replace:: |Ang|\ :sup:`-4`</span>
<span class="s2">.. |cm^-1| replace:: cm\ :sup:`-1`</span>
<span class="s2">.. |cm^2| replace:: cm\ :sup:`2`</span>
<span class="s2">.. |cm^-2| replace:: cm\ :sup:`-2`</span>
<span class="s2">.. |cm^3| replace:: cm\ :sup:`3`</span>
<span class="s2">.. |1e15cm^3| replace:: 10\ :sup:`15`\ cm\ :sup:`3`</span>
<span class="s2">.. |cm^-3| replace:: cm\ :sup:`-3`</span>
<span class="s2">.. |sr^-1| replace:: sr\ :sup:`-1`</span>

<span class="s2">.. |cdot| unicode:: U+00B7</span>
<span class="s2">.. |deg| unicode:: U+00B0</span>
<span class="s2">.. |g/cm^3| replace:: g\ |cdot|\ cm\ :sup:`-3`</span>
<span class="s2">.. |mg/m^2| replace:: mg\ |cdot|\ m\ :sup:`-2`</span>
<span class="s2">.. |fm^2| replace:: fm\ :sup:`2`</span>
<span class="s2">.. |Ang*cm^-1| replace:: |Ang|\ |cdot|\ cm\ :sup:`-1`</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># TODO: make a better fake reference role</span>
<span class="n">RST_ROLES</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">.. role:: ref</span>

<span class="s2">.. role:: numref</span>

<span class="s2">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="make_html"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.make_html">[docs]</a><span class="k">def</span> <span class="nf">make_html</span><span class="p">(</span><span class="n">model_info</span><span class="p">):</span>
    <span class="c1"># type: (ModelInfo) -&gt; str</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert model docs directly to html.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">rst2html</span>

    <span class="n">rst</span> <span class="o">=</span> <span class="n">make_doc</span><span class="p">(</span><span class="n">model_info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rst2html</span><span class="o">.</span><span class="n">rst2html</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">RST_ROLES</span><span class="p">,</span> <span class="n">RST_PROLOG</span><span class="p">,</span> <span class="n">rst</span><span class="p">)))</span></div>

<div class="viewcode-block" id="view_html"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.view_html">[docs]</a><span class="k">def</span> <span class="nf">view_html</span><span class="p">(</span><span class="n">model_name</span><span class="p">):</span>
    <span class="c1"># type: (str) -&gt; None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the model definition and view its help.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">modelinfo</span>
    <span class="n">kernel_module</span> <span class="o">=</span> <span class="n">load_kernel_module</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">modelinfo</span><span class="o">.</span><span class="n">make_model_info</span><span class="p">(</span><span class="n">kernel_module</span><span class="p">)</span>
    <span class="n">view_html_from_info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span></div>

<div class="viewcode-block" id="view_html_from_info"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.view_html_from_info">[docs]</a><span class="k">def</span> <span class="nf">view_html_from_info</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
    <span class="c1"># type: (ModelInfo) -&gt; None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View the help for a loaded model definition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">rst2html</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;file://&quot;</span><span class="o">+</span><span class="n">dirname</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;/&quot;</span>
    <span class="n">rst2html</span><span class="o">.</span><span class="n">view_html</span><span class="p">(</span><span class="n">make_html</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span></div>

<div class="viewcode-block" id="demo_time"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.demo_time">[docs]</a><span class="k">def</span> <span class="nf">demo_time</span><span class="p">():</span>
    <span class="c1"># type: () -&gt; None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show how long it takes to process a model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">from</span> <span class="nn">.modelinfo</span> <span class="kn">import</span> <span class="n">make_model_info</span>
    <span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">cylinder</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">make_source</span><span class="p">(</span><span class="n">make_model_info</span><span class="p">(</span><span class="n">cylinder</span><span class="p">))</span>
    <span class="n">toc</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;time: </span><span class="si">%g</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">toc</span><span class="p">)</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.generate.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># type: () -&gt; None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Program which prints the source produced by the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.modelinfo</span> <span class="kn">import</span> <span class="n">make_model_info</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;usage: python -m sasmodels.generate modelname&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">kernel_module</span> <span class="o">=</span> <span class="n">load_kernel_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">model_info</span> <span class="o">=</span> <span class="n">make_model_info</span><span class="p">(</span><span class="n">kernel_module</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">make_source</span><span class="p">(</span><span class="n">model_info</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;dll&#39;</span><span class="p">])</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SasView 4.2.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../sasmodels.html" >sasmodels</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2018, The SasView Project.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>