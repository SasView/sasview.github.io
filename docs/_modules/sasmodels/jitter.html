<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sasmodels.jitter &mdash; SasView 4.2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '4.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="top" title="SasView 4.2.0 documentation" href="../../index.html" />
    <link rel="up" title="sasmodels" href="../sasmodels.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SasView 4.2.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../sasmodels.html" accesskey="U">sasmodels</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sasmodels.jitter</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Jitter Explorer</span>
<span class="sd">===============</span>

<span class="sd">Application to explore orientation angle and angular dispersity.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">argparse</span>

<span class="k">try</span><span class="p">:</span> <span class="c1"># CRUFT: travis-ci does not support mpl_toolkits.mplot3d</span>
    <span class="kn">import</span> <span class="nn">mpl_toolkits.mplot3d</span>  <span class="c1"># Adds projection=&#39;3d&#39; option to subplot</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.widgets</span> <span class="kn">import</span> <span class="n">Slider</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">radians</span>

<div class="viewcode-block" id="draw_beam"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_beam">[docs]</a><span class="k">def</span> <span class="nf">draw_beam</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw the beam going from source at (0, 0, 1) to detector at (0, 0, -1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#axes.plot([0,0],[0,0],[1,-1])</span>
    <span class="c1">#axes.scatter([0]*100,[0]*100,np.linspace(1, -1, 100), alpha=0.8)</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mf">1.3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>

    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">view</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">Rz</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">points</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_ellipsoid"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_ellipsoid">[docs]</a><span class="k">def</span> <span class="nf">draw_ellipsoid</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw an ellipsoid.&quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">size</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">draw_labels</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;c+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;c-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;a-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;b+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
    <span class="p">])</span></div>

<div class="viewcode-block" id="draw_sc"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_sc">[docs]</a><span class="k">def</span> <span class="nf">draw_sc</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw points for simple cubic paracrystal&quot;&quot;&quot;</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">_build_sc</span><span class="p">()</span>
    <span class="n">_draw_crystal</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_fcc"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_fcc">[docs]</a><span class="k">def</span> <span class="nf">draw_fcc</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw points for face-centered cubic paracrystal&quot;&quot;&quot;</span>
    <span class="c1"># Build the simple cubic crystal</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">_build_sc</span><span class="p">()</span>
    <span class="c1"># Define the centers for each face</span>
    <span class="c1"># x planes at -1, 0, 1 have four centers per plane, at +/- 0.5 in y and z</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
        <span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">12</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># y and z planes can be generated by substituting x for y and z respectively</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">+</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">z</span><span class="o">+</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">))</span>
    <span class="n">_draw_crystal</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_bcc"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_bcc">[docs]</a><span class="k">def</span> <span class="nf">draw_bcc</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw points for body-centered cubic paracrystal&quot;&quot;&quot;</span>
    <span class="c1"># Build the simple cubic crystal</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">_build_sc</span><span class="p">()</span>
    <span class="c1"># Define the centers for each octant</span>
    <span class="c1"># x plane at +/- 0.5 have four centers per plane at +/- 0.5 in y and z</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
        <span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
    <span class="n">_draw_crystal</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_draw_crystal</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">atoms</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">*</span><span class="n">size</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_build_sc</span><span class="p">():</span>
    <span class="c1"># three planes of 9 dots for x at -1, 0 and 1</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span><span class="p">,</span>
        <span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
    <span class="c1">#print(list(enumerate(atoms)))</span>
    <span class="c1"># Pull the dot at (0, 0, 1) to the front of the list</span>
    <span class="c1"># It will be highlighted in the view</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">14</span>
    <span class="n">highlight</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">atoms</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">highlight</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">atoms</span>

<div class="viewcode-block" id="draw_parallelepiped"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_parallelepiped">[docs]</a><span class="k">def</span> <span class="nf">draw_parallelepiped</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw a parallelepiped.&quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">size</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">tri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="c1"># counter clockwise triangles</span>
        <span class="c1"># z: up/down, x: right/left, y: front/back</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="c1"># top face</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="c1"># bottom face</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="c1"># right face</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="c1"># left face</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="c1"># front face</span>
        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="c1"># back face</span>
    <span class="p">])</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">triangles</span><span class="o">=</span><span class="n">tri</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="c1"># Draw pink face on box.</span>
    <span class="c1"># Since I can&#39;t control face color, instead draw a thin box situated just</span>
    <span class="c1"># in front of the &quot;c+&quot; face.  Use the c face so that rotations about psi</span>
    <span class="c1"># rotate that face.</span>
    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">triangles</span><span class="o">=</span><span class="n">tri</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">draw_labels</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;c+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;c-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;a-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;b+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
    <span class="p">])</span></div>

<div class="viewcode-block" id="draw_sphere"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_sphere">[docs]</a><span class="k">def</span> <span class="nf">draw_sphere</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw a sphere&quot;&quot;&quot;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_jitter"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_jitter">[docs]</a><span class="k">def</span> <span class="nf">draw_jitter</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="n">draw_shape</span><span class="o">=</span><span class="n">draw_parallelepiped</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represent jitter as a set of shapes at different orientations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set max diagonal to 0.95</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.95</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">size</span><span class="p">))</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">scale</span><span class="o">*</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">size</span><span class="p">)</span>

    <span class="c1">#np.random.seed(10)</span>
    <span class="c1">#cloud = np.random.randn(10,3)</span>
    <span class="n">cloud</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span> <span class="o">=</span> <span class="n">jitter</span>
    <span class="k">if</span> <span class="n">dtheta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cloud</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cloud</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dphi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cloud</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cloud</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dpsi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cloud</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cloud</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">draw_shape</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gaussian&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span><span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">}[</span><span class="n">dist</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">cloud</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale</span><span class="o">*</span><span class="n">dtheta</span><span class="o">*</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scale</span><span class="o">*</span><span class="n">dphi</span><span class="o">*</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scale</span><span class="o">*</span><span class="n">dpsi</span><span class="o">*</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">draw_shape</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">size</span>
        <span class="n">lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="s1">&#39;set_&#39;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;lim&#39;</span><span class="p">)([</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">])</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;axis&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>

<span class="n">PROJECTIONS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># in order of PROJECTION number; do not change without updating the</span>
    <span class="c1"># constants in kernel_iq.c</span>
    <span class="s1">&#39;equirectangular&#39;</span><span class="p">,</span> <span class="s1">&#39;sinusoidal&#39;</span><span class="p">,</span> <span class="s1">&#39;guyou&#39;</span><span class="p">,</span> <span class="s1">&#39;azimuthal_equidistance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;azimuthal_equal_area&#39;</span><span class="p">,</span>
<span class="p">]</span>
<div class="viewcode-block" id="draw_mesh"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_mesh">[docs]</a><span class="k">def</span> <span class="nf">draw_mesh</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
              <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;equirectangular&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw the dispersion mesh showing the theta-phi orientations at which</span>
<span class="sd">    the model will be evaluated.</span>

<span class="sd">    jitter projections</span>
<span class="sd">    &lt;https://en.wikipedia.org/wiki/List_of_map_projections&gt;</span>

<span class="sd">    equirectangular (standard latitude-longitude mesh)</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Equirectangular_projection&gt;</span>
<span class="sd">        Allows free movement in phi (around the equator), but theta is</span>
<span class="sd">        limited to +/- 90, and points are cos-weighted. Jitter in phi is</span>
<span class="sd">        uniform in weight along a line of latitude.  With small theta and</span>
<span class="sd">        phi ranging over +/- 180 this forms a wobbling disk.  With small</span>
<span class="sd">        phi and theta ranging over +/- 90 this forms a wedge like a slice</span>
<span class="sd">        of an orange.</span>
<span class="sd">    azimuthal_equidistance (Postel)</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Azimuthal_equidistant_projection&gt;</span>
<span class="sd">        Preserves distance from center, and so is an excellent map for</span>
<span class="sd">        representing a bivariate gaussian on the surface.  Theta and phi</span>
<span class="sd">        operate identically, cutting wegdes from the antipode of the viewing</span>
<span class="sd">        angle.  This unfortunately does not allow free movement in either</span>
<span class="sd">        theta or phi since the orthogonal wobble decreases to 0 as the body</span>
<span class="sd">        rotates through 180 degrees.</span>
<span class="sd">    sinusoidal (Sanson-Flamsteed, Mercator equal-area)</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Sinusoidal_projection&gt;</span>
<span class="sd">        Preserves arc length with latitude, giving bad behaviour at</span>
<span class="sd">        theta near +/- 90.  Theta and phi operate somewhat differently,</span>
<span class="sd">        so a system with a-b-c dtheta-dphi-dpsi will not give the same</span>
<span class="sd">        value as one with b-a-c dphi-dtheta-dpsi, as would be the case</span>
<span class="sd">        for azimuthal equidistance.  Free movement using theta or phi</span>
<span class="sd">        uniform over +/- 180 will work, but not as well as equirectangular</span>
<span class="sd">        phi, with theta being slightly worse.  Computationally it is much</span>
<span class="sd">        cheaper for wide theta-phi meshes since it excludes points which</span>
<span class="sd">        lie outside the sinusoid near theta +/- 90 rather than packing</span>
<span class="sd">        them close together as in equirectangle.  Note that the poles</span>
<span class="sd">        will be slightly overweighted for theta &gt; 90 with the circle</span>
<span class="sd">        from theta at 90+dt winding backwards around the pole, overlapping</span>
<span class="sd">        the circle from theta at 90-dt.</span>
<span class="sd">    Guyou (hemisphere-in-a-square) **not weighted**</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Guyou_hemisphere-in-a-square_projection&gt;</span>
<span class="sd">        With tiling, allows rotation in phi or theta through +/- 180, with</span>
<span class="sd">        uniform spacing.  Both theta and phi allow free rotation, with wobble</span>
<span class="sd">        in the orthogonal direction reasonably well behaved (though not as</span>
<span class="sd">        good as equirectangular phi). The forward/reverse transformations</span>
<span class="sd">        relies on elliptic integrals that are somewhat expensive, so the</span>
<span class="sd">        behaviour has to be very good to justify the cost and complexity.</span>
<span class="sd">        The weighting function for each point has not yet been computed.</span>
<span class="sd">        Note: run the module *guyou.py* directly and it will show the forward</span>
<span class="sd">        and reverse mappings.</span>
<span class="sd">    azimuthal_equal_area  **incomplete**</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Lambert_azimuthal_equal-area_projection&gt;</span>
<span class="sd">        Preserves the relative density of the surface patches.  Not that</span>
<span class="sd">        useful and not completely implemented</span>
<span class="sd">    Gauss-Kreuger **not implemented**</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Transverse_Mercator_projection#Ellipsoidal_transverse_Mercator&gt;</span>
<span class="sd">        Should allow free movement in theta, but phi is distorted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: try Kent distribution instead of a gaussian warped by projection</span>

    <span class="n">dist_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dist_x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">dist_x</span> <span class="o">*=</span> <span class="mi">3</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dist_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span>
        <span class="c1"># Note: uses sasmodels ridiculous definition of rectangle width</span>
        <span class="n">dist_x</span> <span class="o">*=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;expected dist to be gaussian, rectangle or uniform&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;equirectangular&#39;</span><span class="p">:</span>  <span class="c1">#define PROJECTION 1</span>
        <span class="k">def</span> <span class="nf">_rotate</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Rx</span><span class="p">(</span><span class="n">phi_j</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">theta_i</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">w_i</span><span class="o">*</span><span class="n">w_j</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">theta_i</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;sinusoidal&#39;</span><span class="p">:</span>  <span class="c1">#define PROJECTION 2</span>
        <span class="k">def</span> <span class="nf">_rotate</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">):</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="n">theta_i</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">latitude</span><span class="p">))</span>
            <span class="n">longitude</span> <span class="o">=</span> <span class="n">phi_j</span><span class="o">/</span><span class="n">scale</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">phi_j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span><span class="o">*</span><span class="mi">180</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="c1">#print(&quot;(%+7.2f, %+7.2f) =&gt; (%+7.2f, %+7.2f)&quot;%(theta_i, phi_j, latitude, longitude))</span>
            <span class="k">return</span> <span class="n">Rx</span><span class="p">(</span><span class="n">longitude</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">latitude</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">):</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="n">theta_i</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">latitude</span><span class="p">))</span>
            <span class="n">active</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">phi_j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span><span class="o">*</span><span class="mi">180</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">active</span><span class="o">*</span><span class="n">w_i</span><span class="o">*</span><span class="n">w_j</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;guyou&#39;</span><span class="p">:</span>  <span class="c1">#define PROJECTION 3  (eventually?)</span>
        <span class="k">def</span> <span class="nf">_rotate</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">.guyou</span> <span class="kn">import</span> <span class="n">guyou_invert</span>
            <span class="c1">#latitude, longitude = guyou_invert([theta_i], [phi_j])</span>
            <span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span> <span class="o">=</span> <span class="n">guyou_invert</span><span class="p">([</span><span class="n">phi_j</span><span class="p">],</span> <span class="p">[</span><span class="n">theta_i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">Rx</span><span class="p">(</span><span class="n">longitude</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">latitude</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">w_i</span><span class="o">*</span><span class="n">w_j</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;azimuthal_equidistance&#39;</span><span class="p">:</span>  <span class="c1"># Note: Rz Ry, not Rx Ry</span>
        <span class="k">def</span> <span class="nf">_rotate</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">):</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">theta_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">longitude</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">phi_j</span><span class="p">,</span> <span class="n">theta_i</span><span class="p">))</span>
            <span class="c1">#print(&quot;(%+7.2f, %+7.2f) =&gt; (%+7.2f, %+7.2f)&quot;%(theta_i, phi_j, latitude, longitude))</span>
            <span class="k">return</span> <span class="n">Rz</span><span class="p">(</span><span class="n">longitude</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">latitude</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">):</span>
            <span class="c1"># Weighting for each point comes from the integral:</span>
            <span class="c1">#     \int\int I(q, lat, log) sin(lat) dlat dlog</span>
            <span class="c1"># We are doing a conformal mapping from disk to sphere, so we need</span>
            <span class="c1"># a change of variables g(theta, phi) -&gt; (lat, long):</span>
            <span class="c1">#     lat, long = sqrt(theta^2 + phi^2), arctan(phi/theta)</span>
            <span class="c1"># giving:</span>
            <span class="c1">#     dtheta dphi = det(J) dlat dlong</span>
            <span class="c1"># where J is the jacobian from the partials of g. Using</span>
            <span class="c1">#     R = sqrt(theta^2 + phi^2),</span>
            <span class="c1"># then</span>
            <span class="c1">#     J = [[x/R, Y/R], -y/R^2, x/R^2]]</span>
            <span class="c1"># and</span>
            <span class="c1">#     det(J) = 1/R</span>
            <span class="c1"># with the final integral being:</span>
            <span class="c1">#    \int\int I(q, theta, phi) sin(R)/R dtheta dphi</span>
            <span class="c1">#</span>
            <span class="c1"># This does approximately the right thing, decreasing the weight</span>
            <span class="c1"># of each point as you go farther out on the disk, but it hasn&#39;t</span>
            <span class="c1"># yet been checked against the 1D integral results. Prior</span>
            <span class="c1"># to declaring this &quot;good enough&quot; and checking that integrals</span>
            <span class="c1"># work in practice, we will examine alternative mappings.</span>
            <span class="c1">#</span>
            <span class="c1"># The issue is that the mapping does not support the case of free</span>
            <span class="c1"># rotation about a single axis correctly, with a small deviation</span>
            <span class="c1"># in the orthogonal axis independent of the first axis.  Like the</span>
            <span class="c1"># usual polar coordiates integration, the integrated sections</span>
            <span class="c1"># form wedges, though at least in this case the wedge cuts through</span>
            <span class="c1"># the entire sphere, and treats theta and phi identically.</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">theta_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">latitude</span><span class="p">))</span><span class="o">/</span><span class="n">latitude</span> <span class="k">if</span> <span class="n">latitude</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">weight</span><span class="o">*</span><span class="n">w_i</span><span class="o">*</span><span class="n">w_j</span> <span class="k">if</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mi">180</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;azimuthal_equal_area&#39;</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_rotate</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">theta_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="mi">180</span><span class="o">-</span><span class="n">degrees</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">radius</span><span class="p">))</span>
            <span class="n">longitude</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">phi_j</span><span class="p">,</span> <span class="n">theta_i</span><span class="p">))</span>
            <span class="c1">#print(&quot;(%+7.2f, %+7.2f) =&gt; (%+7.2f, %+7.2f)&quot;%(theta_i, phi_j, latitude, longitude))</span>
            <span class="k">return</span> <span class="n">Rz</span><span class="p">(</span><span class="n">longitude</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">latitude</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">):</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">theta_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">latitude</span><span class="p">))</span><span class="o">/</span><span class="n">latitude</span> <span class="k">if</span> <span class="n">latitude</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">weight</span><span class="o">*</span><span class="n">w_i</span><span class="o">*</span><span class="n">w_j</span> <span class="k">if</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mi">180</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown projection </span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">projection</span><span class="p">)</span>

    <span class="c1"># mesh in theta, phi formed by rotating z</span>
    <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span> <span class="o">=</span> <span class="n">jitter</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">radius</span><span class="p">]])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">_rotate</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">)</span><span class="o">*</span><span class="n">z</span>
                        <span class="k">for</span> <span class="n">theta_i</span> <span class="ow">in</span> <span class="n">dtheta</span><span class="o">*</span><span class="n">dist_x</span>
                        <span class="k">for</span> <span class="n">phi_j</span> <span class="ow">in</span> <span class="n">dphi</span><span class="o">*</span><span class="n">dist_x</span><span class="p">])</span>
    <span class="n">dist_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">theta_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtheta</span><span class="o">*</span><span class="n">dist_x</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">w_j</span><span class="p">,</span> <span class="n">phi_j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dphi</span><span class="o">*</span><span class="n">dist_x</span><span class="p">)])</span>
    <span class="c1">#print(max(dist_w), min(dist_w), min(dist_w[dist_w &gt; 0]))</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span> <span class="n">dist_w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">dist_w</span> <span class="o">=</span> <span class="n">dist_w</span><span class="p">[</span><span class="n">dist_w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">dist_w</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dist_w</span><span class="p">)</span>

    <span class="c1"># rotate relative to beam</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">orient_relative_to_beam</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="c1">#plt.figure(2); plt.clf(); plt.hist(z, bins=np.linspace(-1, 1, 51))</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">dist_w</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_labels"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_labels">[docs]</a><span class="k">def</span> <span class="nf">draw_labels</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw text at a particular location.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span><span class="p">,</span> <span class="n">locations</span><span class="p">,</span> <span class="n">orientations</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">text</span><span class="p">)</span>
    <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">locations</span><span class="p">)</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">orientations</span><span class="p">)</span>

    <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">)</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>

    <span class="c1"># TODO: zdir for labels is broken, and labels aren&#39;t appearing.</span>
    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">zdir</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)):</span>
        <span class="n">zdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">zdir</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="n">zdir</span><span class="p">)</span></div>

<span class="c1"># Definition of rotation matrices comes from wikipedia:</span>
<span class="c1">#    https://en.wikipedia.org/wiki/Rotation_matrix#Basic_rotations</span>
<div class="viewcode-block" id="Rx"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Rx">[docs]</a><span class="k">def</span> <span class="nf">Rx</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a matrix to rotate points about *x* by *angle* degrees.&quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span>
           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)]]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ry"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Ry">[docs]</a><span class="k">def</span> <span class="nf">Ry</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a matrix to rotate points about *y* by *angle* degrees.&quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="p">[[</span><span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span>
           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)]]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rz"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Rz">[docs]</a><span class="k">def</span> <span class="nf">Rz</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a matrix to rotate points about *z* by *angle* degrees.&quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="p">[[</span><span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
           <span class="p">[</span><span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span></div>

<div class="viewcode-block" id="transform_xyz"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.transform_xyz">[docs]</a><span class="k">def</span> <span class="nf">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a set of (x,y,z) points through the jitter and view transforms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)]</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">apply_jitter</span><span class="p">(</span><span class="n">jitter</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">orient_relative_to_beam</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span></div>

<div class="viewcode-block" id="apply_jitter"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.apply_jitter">[docs]</a><span class="k">def</span> <span class="nf">apply_jitter</span><span class="p">(</span><span class="n">jitter</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the jitter transform to a set of points.</span>

<span class="sd">    Points are stored in a 3 x n numpy matrix, not a numpy array or tuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span> <span class="o">=</span> <span class="n">jitter</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">Rx</span><span class="p">(</span><span class="n">dphi</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)</span><span class="o">*</span><span class="n">Rz</span><span class="p">(</span><span class="n">dpsi</span><span class="p">)</span><span class="o">*</span><span class="n">points</span>
    <span class="k">return</span> <span class="n">points</span></div>

<div class="viewcode-block" id="orient_relative_to_beam"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.orient_relative_to_beam">[docs]</a><span class="k">def</span> <span class="nf">orient_relative_to_beam</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the view transform to a set of points.</span>

<span class="sd">    Points are stored in a 3 x n numpy matrix, not a numpy array or tuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">view</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">Rz</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">Rz</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="o">*</span><span class="n">points</span>
    <span class="k">return</span> <span class="n">points</span></div>

<span class="c1"># translate between number of dimension of dispersity and the number of</span>
<span class="c1"># points along each dimension.</span>
<span class="n">PD_N_TABLE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>     <span class="c1"># 0</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>   <span class="c1"># 100</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>   <span class="c1"># 900</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>  <span class="c1"># 3375</span>
<span class="p">}</span>

<div class="viewcode-block" id="clipped_range"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.clipped_range">[docs]</a><span class="k">def</span> <span class="nf">clipped_range</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">portion</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;central&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine range from data.</span>

<span class="sd">    If *portion* is 1, use full range, otherwise use the center of the range</span>
<span class="sd">    or the top of the range, depending on whether *mode* is &#39;central&#39; or &#39;top&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">portion</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;central&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">portion</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">offset</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">portion</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="draw_scattering"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_scattering">[docs]</a><span class="k">def</span> <span class="nf">draw_scattering</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the scattering for the particular view.</span>

<span class="sd">    *calculator* is returned from :func:`build_model`.  *axes* are the 3D axes</span>
<span class="sd">    on which the data will be plotted.  *view* and *jitter* are the current</span>
<span class="sd">    orientation and orientation dispersity.  *dist* is one of the sasmodels</span>
<span class="sd">    weight distributions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>  <span class="c1"># uniform is not yet in this branch</span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># add the orientation parameters to the model parameters</span>
    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">view</span>
    <span class="n">theta_pd</span><span class="p">,</span> <span class="n">phi_pd</span><span class="p">,</span> <span class="n">psi_pd</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale</span><span class="o">*</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">jitter</span><span class="p">]</span>
    <span class="n">theta_pd_n</span><span class="p">,</span> <span class="n">phi_pd_n</span><span class="p">,</span> <span class="n">psi_pd_n</span> <span class="o">=</span> <span class="n">PD_N_TABLE</span><span class="p">[(</span><span class="n">theta_pd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phi_pd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">psi_pd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="c1">## increase pd_n for testing jitter integration rather than simple viz</span>
    <span class="c1">#theta_pd_n, phi_pd_n, psi_pd_n = [5*v for v in (theta_pd_n, phi_pd_n, psi_pd_n)]</span>

    <span class="n">pars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">theta_pd</span><span class="o">=</span><span class="n">theta_pd</span><span class="p">,</span> <span class="n">theta_pd_type</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">theta_pd_n</span><span class="o">=</span><span class="n">theta_pd_n</span><span class="p">,</span>
        <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">phi_pd</span><span class="o">=</span><span class="n">phi_pd</span><span class="p">,</span> <span class="n">phi_pd_type</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">phi_pd_n</span><span class="o">=</span><span class="n">phi_pd_n</span><span class="p">,</span>
        <span class="n">psi</span><span class="o">=</span><span class="n">psi</span><span class="p">,</span> <span class="n">psi_pd</span><span class="o">=</span><span class="n">psi_pd</span><span class="p">,</span> <span class="n">psi_pd_type</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">psi_pd_n</span><span class="o">=</span><span class="n">psi_pd_n</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">calculator</span><span class="o">.</span><span class="n">pars</span><span class="p">)</span>

    <span class="c1"># compute the pattern</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">x_bins</span><span class="p">,</span> <span class="n">calculator</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">y_bins</span>
    <span class="n">Iqxy</span> <span class="o">=</span> <span class="n">calculator</span><span class="p">(</span><span class="o">**</span><span class="n">pars</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qx</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">qy</span><span class="p">))</span>

    <span class="c1"># scale it and draw it</span>
    <span class="n">Iqxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Iqxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calculator</span><span class="o">.</span><span class="n">limits</span><span class="p">:</span>
        <span class="c1"># use limits from orientation (0,0,0)</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">limits</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">Iqxy</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmax</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">7</span>
        <span class="c1">#vmin, vmax = clipped_range(Iqxy, portion=portion, mode=&#39;top&#39;)</span>
    <span class="c1">#print(&quot;range&quot;,(vmin,vmax))</span>
    <span class="c1">#qx, qy = np.meshgrid(qx, qy)</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="n">Iqxy</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">level</span><span class="p">[</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">()(</span><span class="n">level</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">rstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
    <span class="k">elif</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">qx</span><span class="o">/</span><span class="n">qx</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">qy</span><span class="o">/</span><span class="n">qy</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">Iqxy</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="mf">1.1</span><span class="p">,</span>
                      <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">Iqxy</span><span class="p">)</span></div>

<div class="viewcode-block" id="build_model"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.build_model">[docs]</a><span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">**</span><span class="n">pars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a calculator for the given shape.</span>

<span class="sd">    *model_name* is any sasmodels model.  *n* and *qmax* define an n x n mesh</span>
<span class="sd">    on which to evaluate the model.  The remaining parameters are stored in</span>
<span class="sd">    the returned calculator as *calculator.pars*.  They are used by</span>
<span class="sd">    :func:`draw_scattering` to set the non-orientation parameters in the</span>
<span class="sd">    calculation.</span>

<span class="sd">    Returns a *calculator* function which takes a dictionary or parameters and</span>
<span class="sd">    produces Iqxy.  The Iqxy value needs to be reshaped to an n x n matrix</span>
<span class="sd">    for plotting.  See the :class:`sasmodels.direct_model.DirectModel` class</span>
<span class="sd">    for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sasmodels.core</span> <span class="kn">import</span> <span class="n">load_model_info</span><span class="p">,</span> <span class="n">build_model</span> <span class="k">as</span> <span class="n">build_sasmodel</span>
    <span class="kn">from</span> <span class="nn">sasmodels.data</span> <span class="kn">import</span> <span class="n">empty_data2D</span>
    <span class="kn">from</span> <span class="nn">sasmodels.direct_model</span> <span class="kn">import</span> <span class="n">DirectModel</span>

    <span class="n">model_info</span> <span class="o">=</span> <span class="n">load_model_info</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">build_sasmodel</span><span class="p">(</span><span class="n">model_info</span><span class="p">)</span> <span class="c1">#, dtype=&#39;double!&#39;)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">qmax</span><span class="p">,</span> <span class="n">qmax</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">empty_data2D</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DirectModel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

    <span class="c1"># stuff the values for non-orientation parameters into the calculator</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="n">pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;backgound&#39;</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>

    <span class="c1"># fix the data limits so that we can see if the pattern fades</span>
    <span class="c1"># under rotation or angular dispersion</span>
    <span class="n">Iqxy</span> <span class="o">=</span> <span class="n">calculator</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">calculator</span><span class="o">.</span><span class="n">pars</span><span class="p">)</span>
    <span class="n">Iqxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Iqxy</span><span class="p">)</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">clipped_range</span><span class="p">(</span><span class="n">Iqxy</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">+</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">calculator</span></div>

<div class="viewcode-block" id="select_calculator"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.select_calculator">[docs]</a><span class="k">def</span> <span class="nf">select_calculator</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">100</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a model calculator for the given shape.</span>

<span class="sd">    *model_name* is one of sphere, cylinder, ellipsoid, triaxial_ellipsoid,</span>
<span class="sd">    parallelepiped or bcc_paracrystal. *n* is the number of points to use</span>
<span class="sd">    in the q range.  *qmax* is chosen based on model parameters for the</span>
<span class="sd">    given model to show something intersting.</span>

<span class="sd">    Returns *calculator* and tuple *size* (a,b,c) giving minor and major</span>
<span class="sd">    equitorial axes and polar axis respectively.  See :func:`build_model`</span>
<span class="sd">    for details on the returned calculator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">size</span>
    <span class="n">d_factor</span> <span class="o">=</span> <span class="mf">0.06</span>  <span class="c1"># for paracrystal models</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;sphere&#39;</span><span class="p">:</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;sc_paracrystal&#39;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">dnn</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">c</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;sc_paracrystal&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">dnn</span><span class="o">=</span><span class="n">dnn</span><span class="p">,</span>
                                 <span class="n">d_factor</span><span class="o">=</span><span class="n">d_factor</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">d_factor</span><span class="p">)</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span>
                                 <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;fcc_paracrystal&#39;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
        <span class="c1"># nearest neigbour distance dnn should be 2 radius, but I think the</span>
        <span class="c1"># model uses lattice spacing rather than dnn in its calculations</span>
        <span class="n">dnn</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">c</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;fcc_paracrystal&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">dnn</span><span class="o">=</span><span class="n">dnn</span><span class="p">,</span>
                                 <span class="n">d_factor</span><span class="o">=</span><span class="n">d_factor</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">d_factor</span><span class="p">)</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span>
                                 <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;bcc_paracrystal&#39;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
        <span class="c1"># nearest neigbour distance dnn should be 2 radius, but I think the</span>
        <span class="c1"># model uses lattice spacing rather than dnn in its calculations</span>
        <span class="n">dnn</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">c</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;bcc_paracrystal&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">dnn</span><span class="o">=</span><span class="n">dnn</span><span class="p">,</span>
                                 <span class="n">d_factor</span><span class="o">=</span><span class="n">d_factor</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">d_factor</span><span class="p">)</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span>
                                 <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;cylinder&#39;</span><span class="p">:</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;cylinder&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;ellipsoid&#39;</span><span class="p">:</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;ellipsoid&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                 <span class="n">radius_polar</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">radius_equatorial</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;triaxial_ellipsoid&#39;</span><span class="p">:</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;triaxial_ellipsoid&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                 <span class="n">radius_equat_minor</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
                                 <span class="n">radius_equat_major</span><span class="o">=</span><span class="n">b</span><span class="p">,</span>
                                 <span class="n">radius_polar</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;parallelepiped&#39;</span><span class="p">:</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;parallelepiped&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown model </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">model_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">calculator</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span></div>

<span class="n">SHAPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;parallelepiped&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;ellipsoid&#39;</span><span class="p">,</span> <span class="s1">&#39;triaxial_ellipsoid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cylinder&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fcc_paracrystal&#39;</span><span class="p">,</span> <span class="s1">&#39;bcc_paracrystal&#39;</span><span class="p">,</span> <span class="s1">&#39;sc_paracrystal&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">DRAW_SHAPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;fcc_paracrystal&#39;</span><span class="p">:</span> <span class="n">draw_fcc</span><span class="p">,</span>
    <span class="s1">&#39;bcc_paracrystal&#39;</span><span class="p">:</span> <span class="n">draw_bcc</span><span class="p">,</span>
    <span class="s1">&#39;sc_paracrystal&#39;</span><span class="p">:</span> <span class="n">draw_sc</span><span class="p">,</span>
    <span class="s1">&#39;parallelepiped&#39;</span><span class="p">:</span> <span class="n">draw_parallelepiped</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">DISTRIBUTIONS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">DIST_LIMITS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
    <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="s1">&#39;uniform&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
<span class="p">}</span>

<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;parallelepiped&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
        <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;equirectangular&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show an interactive orientation and jitter demo.</span>

<span class="sd">    *model_name* is one of: sphere, ellipsoid, triaxial_ellipsoid,</span>
<span class="sd">    parallelepiped, cylinder, or sc/fcc/bcc_paracrystal</span>

<span class="sd">    *size* gives the dimensions (a, b, c) of the shape.</span>

<span class="sd">    *dist* is the type of dispersition: gaussian, rectangle, or uniform.</span>

<span class="sd">    *mesh* is the number of points in the dispersion mesh.</span>

<span class="sd">    *projection* is the map projection to use for the mesh: equirectangular,</span>
<span class="sd">    sinusoidal, guyou, azimuthal_equidistance, or azimuthal_equal_area.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># projection number according to 1-order position in list, but</span>
    <span class="c1"># only 1 and 2 are implemented so far.</span>
    <span class="kn">from</span> <span class="nn">sasmodels</span> <span class="kn">import</span> <span class="n">generate</span>
    <span class="n">generate</span><span class="o">.</span><span class="n">PROJECTION</span> <span class="o">=</span> <span class="n">PROJECTIONS</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">generate</span><span class="o">.</span><span class="n">PROJECTION</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;*** PROJECTION </span><span class="si">%s</span><span class="s2"> not implemented in scattering function ***&quot;</span><span class="o">%</span><span class="n">projection</span><span class="p">)</span>
        <span class="n">generate</span><span class="o">.</span><span class="n">PROJECTION</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># set up calculator</span>
    <span class="n">calculator</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">select_calculator</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">draw_shape</span> <span class="o">=</span> <span class="n">DRAW_SHAPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">draw_parallelepiped</span><span class="p">)</span>

    <span class="c1">## uncomment to set an independent the colour range for every view</span>
    <span class="c1">## If left commented, the colour range is fixed for all views</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1">## initial view</span>
    <span class="c1">#theta, dtheta = 70., 10.</span>
    <span class="c1">#phi, dphi = -45., 3.</span>
    <span class="c1">#psi, dpsi = -45., 3.</span>
    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

    <span class="c1">## create the plot window</span>
    <span class="c1">#plt.hold(True)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="s1">&#39;gist_earth&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
    <span class="c1">#gs = gridspec.GridSpec(2,1,height_ratios=[4,1])</span>
    <span class="c1">#axes = plt.subplot(gs[0], projection=&#39;3d&#39;)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>  <span class="c1"># CRUFT: not all versions of matplotlib accept &#39;square&#39; 3d projection</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;square&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">axcolor</span> <span class="o">=</span> <span class="s1">&#39;lightgoldenrodyellow&#39;</span>

    <span class="c1">## add control widgets to plot</span>
    <span class="n">axes_theta</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axcolor</span><span class="p">)</span>
    <span class="n">axes_phi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axcolor</span><span class="p">)</span>
    <span class="n">axes_psi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axcolor</span><span class="p">)</span>
    <span class="n">stheta</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_theta</span><span class="p">,</span> <span class="s1">&#39;Theta&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">sphi</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_phi</span><span class="p">,</span> <span class="s1">&#39;Phi&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">spsi</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_psi</span><span class="p">,</span> <span class="s1">&#39;Psi&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="n">psi</span><span class="p">)</span>

    <span class="n">axes_dtheta</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axcolor</span><span class="p">)</span>
    <span class="n">axes_dphi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axcolor</span><span class="p">)</span>
    <span class="n">axes_dpsi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="n">axisbg</span><span class="o">=</span><span class="n">axcolor</span><span class="p">)</span>
    <span class="c1"># Note: using ridiculous definition of rectangle distribution, whose width</span>
    <span class="c1"># in sasmodels is sqrt(3) times the given width.  Divide by sqrt(3) to keep</span>
    <span class="c1"># the maximum width to 90.</span>
    <span class="n">dlimit</span> <span class="o">=</span> <span class="n">DIST_LIMITS</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span>
    <span class="n">sdtheta</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_dtheta</span><span class="p">,</span> <span class="s1">&#39;dTheta&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">dlimit</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="n">dtheta</span><span class="p">)</span>
    <span class="n">sdphi</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_dphi</span><span class="p">,</span> <span class="s1">&#39;dPhi&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">dlimit</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="n">dphi</span><span class="p">)</span>
    <span class="n">sdpsi</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_dpsi</span><span class="p">,</span> <span class="s1">&#39;dPsi&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">dlimit</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="n">dpsi</span><span class="p">)</span>


    <span class="c1">## callback to draw the new view</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">stheta</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">sphi</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">spsi</span><span class="o">.</span><span class="n">val</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="n">sdtheta</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">sdphi</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">sdpsi</span><span class="o">.</span><span class="n">val</span>
        <span class="c1"># set small jitter as 0 if multiple pd dims</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">jitter</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">][</span><span class="n">dims</span><span class="p">]</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">jitter</span><span class="p">]</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">draw_beam</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">draw_jitter</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">draw_shape</span><span class="o">=</span><span class="n">draw_shape</span><span class="p">)</span>
        <span class="c1">#draw_jitter(axes, view, (0,0,0))</span>
        <span class="n">draw_mesh</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
        <span class="n">draw_scattering</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="c1">## bind control widgets to view updater</span>
    <span class="n">stheta</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">))</span>
    <span class="n">sphi</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">))</span>
    <span class="n">spsi</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;psi&#39;</span><span class="p">))</span>
    <span class="n">sdtheta</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;dtheta&#39;</span><span class="p">))</span>
    <span class="n">sdphi</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;dphi&#39;</span><span class="p">))</span>
    <span class="n">sdpsi</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;dpsi&#39;</span><span class="p">))</span>

    <span class="c1">## initialize view</span>
    <span class="n">update</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">)</span>

    <span class="c1">## go interactive</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Display jitter&quot;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--projection&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">PROJECTIONS</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="n">PROJECTIONS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;coordinate projection&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;10,40,100&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;a,b,c lengths&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--distribution&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">DISTRIBUTIONS</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="n">DISTRIBUTIONS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;jitter distribution&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--mesh&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;#points in theta-phi mesh&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">SHAPES</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">SHAPES</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;oriented shape&#39;</span><span class="p">)</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
    <span class="n">run</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
        <span class="n">mesh</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span></div>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SasView 4.2.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../sasmodels.html" >sasmodels</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2018, The SasView Project.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>